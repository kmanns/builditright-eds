{"version":3,"file":"useCustomerRolePermissions.js","sources":["/@dropins/storefront-purchase-order/src/data/transforms/transform-customer-role-permissions.ts","/@dropins/storefront-purchase-order/src/hooks/useCustomerRolePermissions.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { CustomerRolePermissionsModel } from '@/b2b-purchase-order/data/models/customer-role-permissions-model';\nimport { PO_PERMISSIONS } from '@/b2b-purchase-order/api/permissions';\n\ntype PermissionsPayload = {\n  admin?: boolean;\n  [key: string]: boolean | undefined;\n};\n\n/**\n * Transforms flat permissions object from auth/permissions event into CustomerRolePermissionsModel\n *\n * Permission Logic:\n * - true: Permission granted\n * - false: Permission disabled (overrides admin privileges - indicates PO feature is disabled)\n * - Default: Admins get access, regular users don't\n *\n * @param permissionsData - Flat object with permission keys and admin flag\n * @returns CustomerRolePermissionsModel\n */\nexport const transformPermissions = (\n  permissionsData: PermissionsPayload | null | undefined\n): CustomerRolePermissionsModel => {\n  // Fallback for edge cases\n  if (!permissionsData) {\n    return {\n      isAdmin: false,\n      purchaseOrderEnabled: false,\n      role: { id: '', name: '' },\n      permissions: {\n        purchaseOrderAll: false,\n        viewPurchaseOrders: false,\n        viewPurchaseOrdersForSubordinates: false,\n        viewPurchaseOrdersForCompany: false,\n        autoApprovePurchaseOrder: false,\n        superApprovePurchaseOrder: false,\n        viewApprovalRules: false,\n        manageApprovalRules: false,\n      },\n    };\n  }\n\n  const isAdmin = permissionsData.admin === true;\n\n  /**\n   * Check if permission is granted\n   * - false: Overrides admin (PO disabled)\n   * - true: Permission granted\n   * - Default: Use admin status\n   */\n  const hasPermission = (key: string): boolean => {\n    const permissionValue = permissionsData[key];\n\n    if (permissionValue === false) {\n      return false;\n    }\n\n    if (permissionValue === true) {\n      return true;\n    }\n\n    return isAdmin;\n  };\n\n  const permissions = {\n    purchaseOrderAll: hasPermission(PO_PERMISSIONS.PO_ALL),\n    viewPurchaseOrders: hasPermission(PO_PERMISSIONS.VIEW_CUSTOMER),\n    viewPurchaseOrdersForSubordinates: hasPermission(\n      PO_PERMISSIONS.VIEW_SUBORDINATES\n    ),\n    viewPurchaseOrdersForCompany: hasPermission(PO_PERMISSIONS.VIEW_COMPANY),\n    autoApprovePurchaseOrder: hasPermission(PO_PERMISSIONS.AUTO_APPROVE),\n    superApprovePurchaseOrder: hasPermission(PO_PERMISSIONS.SUPER_APPROVE),\n    viewApprovalRules: hasPermission(PO_PERMISSIONS.VIEW_RULES),\n    manageApprovalRules: hasPermission(PO_PERMISSIONS.MANAGE_RULES),\n  };\n\n  // Purchase orders are disabled if ANY permission in the payload is explicitly set to false\n  // Otherwise enabled if user has at least one permission\n  const hasExplicitlyDisabledPermission = Object.values(permissionsData).some(\n    (value) => value === false\n  );\n  const purchaseOrderEnabled = hasExplicitlyDisabledPermission\n    ? false\n    : Object.values(permissions).some((permission) => permission === true);\n\n  return {\n    isAdmin,\n    purchaseOrderEnabled,\n    role: {\n      id: '',\n      name: isAdmin ? 'Company Administrator' : '',\n    },\n    permissions,\n  };\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useMemo, useState, useEffect } from 'preact/hooks';\nimport { events } from '@adobe-commerce/event-bus';\nimport { transformPermissions } from '@/b2b-purchase-order/data/transforms/transform-customer-role-permissions';\nimport { CustomerRolePermissionsModel } from '@/b2b-purchase-order/data/models';\n\n/**\n * Hook to consume customer role permissions from the auth/permissions event\n *\n * Initializes with last payload and subscribes to real-time updates.\n * Transforms permissions data where:\n * - true: Permission granted\n * - false: Permission disabled (overrides admin - PO feature disabled)\n * - Default: Admins get access, regular users don't\n *\n * @returns {permissions: CustomerRolePermissionsModel, loadingPermissions: boolean}\n */\nexport const useCustomerRolePermissions = (): {\n  permissions: CustomerRolePermissionsModel;\n  loadingPermissions: boolean;\n} => {\n  // Initialize with the last payload from the auth/permissions event\n  const initialPermissionsData = events.lastPayload('auth/permissions');\n\n  // State to hold permissions data, updated when event is triggered\n  const [permissionsData, setPermissionsData] = useState(\n    initialPermissionsData\n  );\n\n  // Subscribe to auth/permissions event for real-time updates\n  useEffect(() => {\n    const subscription = events.on(\n      'auth/permissions',\n      (payload) => {\n        setPermissionsData(payload);\n      },\n      { eager: true }\n    );\n\n    // Cleanup subscription on unmount\n    return () => {\n      subscription?.off();\n    };\n  }, []);\n\n  // We're loading if we don't have permissions data from the event yet\n  const loadingPermissions = !permissionsData;\n\n  // Transform and memoize the permissions data\n  const permissions = useMemo(() => {\n    return transformPermissions(permissionsData);\n  }, [permissionsData]);\n\n  return {\n    permissions,\n    loadingPermissions,\n  };\n};\n"],"names":["transformPermissions","permissionsData","isAdmin","hasPermission","key","permissionValue","permissions","PO_PERMISSIONS","purchaseOrderEnabled","value","permission","useCustomerRolePermissions","initialPermissionsData","events","setPermissionsData","useState","useEffect","subscription","payload","loadingPermissions","useMemo"],"mappings":"gLAoCO,MAAMA,EACXC,GACiC,CAEjC,GAAI,CAACA,EACH,MAAO,CACL,QAAS,GACT,qBAAsB,GACtB,KAAM,CAAE,GAAI,GAAI,KAAM,EAAA,EACtB,YAAa,CACX,iBAAkB,GAClB,mBAAoB,GACpB,kCAAmC,GACnC,6BAA8B,GAC9B,yBAA0B,GAC1B,0BAA2B,GAC3B,kBAAmB,GACnB,oBAAqB,EAAA,CACvB,EAIJ,MAAMC,EAAUD,EAAgB,QAAU,GAQpCE,EAAiBC,GAAyB,CAC9C,MAAMC,EAAkBJ,EAAgBG,CAAG,EAE3C,OAAIC,IAAoB,GACf,GAGLA,IAAoB,GACf,GAGFH,CACT,EAEMI,EAAc,CAClB,iBAAkBH,EAAcI,EAAe,MAAM,EACrD,mBAAoBJ,EAAcI,EAAe,aAAa,EAC9D,kCAAmCJ,EACjCI,EAAe,iBAAA,EAEjB,6BAA8BJ,EAAcI,EAAe,YAAY,EACvE,yBAA0BJ,EAAcI,EAAe,YAAY,EACnE,0BAA2BJ,EAAcI,EAAe,aAAa,EACrE,kBAAmBJ,EAAcI,EAAe,UAAU,EAC1D,oBAAqBJ,EAAcI,EAAe,YAAY,CAAA,EAQ1DC,EAHkC,OAAO,OAAOP,CAAe,EAAE,KACpEQ,GAAUA,IAAU,EAAA,EAGnB,GACA,OAAO,OAAOH,CAAW,EAAE,KAAMI,GAAeA,IAAe,EAAI,EAEvE,MAAO,CACL,QAAAR,EACA,qBAAAM,EACA,KAAM,CACJ,GAAI,GACJ,KAAMN,EAAU,wBAA0B,EAAA,EAE5C,YAAAI,CAAA,CAEJ,EC9EaK,EAA6B,IAGrC,CAEH,MAAMC,EAAyBC,EAAO,YAAY,kBAAkB,EAG9D,CAACZ,EAAiBa,CAAkB,EAAIC,EAC5CH,CAAA,EAIFI,EAAU,IAAM,CACd,MAAMC,EAAeJ,EAAO,GAC1B,mBACCK,GAAY,CACXJ,EAAmBI,CAAO,CAC5B,EACA,CAAE,MAAO,EAAA,CAAK,EAIhB,MAAO,IAAM,CACXD,GAAA,MAAAA,EAAc,KAChB,CACF,EAAG,CAAA,CAAE,EAGL,MAAME,EAAqB,CAAClB,EAO5B,MAAO,CACL,YALkBmB,EAAQ,IACnBpB,EAAqBC,CAAe,EAC1C,CAACA,CAAe,CAAC,EAIlB,mBAAAkB,CAAA,CAEJ"}