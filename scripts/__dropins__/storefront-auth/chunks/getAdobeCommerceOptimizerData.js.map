{"version":3,"file":"getAdobeCommerceOptimizerData.js","sources":["/@dropins/storefront-auth/src/configs/cookieConfigs.ts","/@dropins/storefront-auth/src/lib/cookieUtils.ts","/@dropins/storefront-auth/src/api/initialize/initialize.ts","/@dropins/storefront-auth/src/data/transforms/transform-store-config.ts","/@dropins/storefront-auth/src/data/transforms/transform-adobe-commerce-optimizer.ts","/@dropins/storefront-auth/src/lib/fetch-error.ts","/@dropins/storefront-auth/src/lib/base64ToSha1.ts","/@dropins/storefront-auth/src/lib/emitAuthGroupId.ts","/@dropins/storefront-auth/src/api/getStoreConfig/graphql/getStoreConfig.graphql.ts","/@dropins/storefront-auth/src/api/getStoreConfig/getStoreConfig.ts","/@dropins/storefront-auth/src/api/verifyToken/graphql/verifyToken.graphql.ts","/@dropins/storefront-auth/src/api/verifyToken/verifyToken.ts","/@dropins/storefront-auth/src/api/getCustomerRolePermissions/graphql/getCustomerRolePermissions.graphql.ts","/@dropins/storefront-auth/src/api/getCustomerRolePermissions/getCustomerRolePermissions.ts","/@dropins/storefront-auth/src/api/getAdobeCommerceOptimizerData/graphql/getAdobeCommerceOptimizerData.graphql.ts","/@dropins/storefront-auth/src/api/getAdobeCommerceOptimizerData/getAdobeCommerceOptimizerData.ts"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nconst COOKIE_NAMES = {\n  auth_dropin_user_token: 'auth_dropin_user_token',\n  auth_dropin_firstname: 'auth_dropin_firstname',\n};\n\nconst LOCALHOST = [\n  'localhost',\n  '127.0.0.1',\n  '::1'\n];\n\nconst COOKIE_LIFETIME = 3600;\n\nexport { COOKIE_NAMES, COOKIE_LIFETIME, LOCALHOST };\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\n/* eslint-disable no-useless-escape */\nimport { getStoreConfig } from '@/auth/api';\nimport { COOKIE_LIFETIME } from '@/auth/configs/cookieConfigs';\n\nexport const getCookie = (cookieName: string) => {\n  const cookies = document.cookie.split(';');\n  let foundValue;\n\n  cookies.forEach((cookie) => {\n    const [name, value] = cookie.trim().split('=');\n    if (name === cookieName) {\n      foundValue = decodeURIComponent(value);\n    }\n  });\n\n  return foundValue;\n};\n\nexport const deleteCookie = (cookieName: string) => {\n  document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;\n};\n\nexport const getCookiesLifetime = async () => {\n  try {\n    const storeConfigString = sessionStorage.getItem('storeConfig');\n    const cachedStoreConfig = storeConfigString\n      ? JSON.parse(storeConfigString)\n      : {};\n\n    let accessTokenLifeTime = cachedStoreConfig.customerAccessTokenLifetime;\n\n    if (!accessTokenLifeTime) {\n      const storeConfig = await getStoreConfig();\n\n      sessionStorage.setItem('storeConfig', JSON.stringify(storeConfig));\n\n      accessTokenLifeTime =\n        storeConfig?.customerAccessTokenLifetime || COOKIE_LIFETIME;\n    }\n\n    return `Max-Age=${accessTokenLifeTime}`;\n  } catch (error) {\n    console.error('getCookiesLifetime() Error:', error);\n    return `Max-Age=${COOKIE_LIFETIME}`;\n  }\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Initializer, Model, Config } from '@adobe-commerce/elsie/lib';\nimport { Lang } from '@adobe-commerce/elsie/i18n';\nimport { getCookie } from '@/auth/lib/cookieUtils';\nimport { CustomerModel } from '@/auth/data/models';\nimport { verifyToken, getCustomerRolePermissions, getAdobeCommerceOptimizerData } from '@/auth/api';\nimport { events } from '@adobe-commerce/event-bus';\nimport { COOKIE_NAMES } from '@/auth/configs/cookieConfigs';\n\ntype ConfigProps = {\n  langDefinitions?: Lang;\n  authHeaderConfig: {\n    header: string;\n    tokenPrefix: string;\n  };\n  customerPermissionRoles?: boolean;\n  adobeCommerceOptimizer?: boolean;\n  models?: {\n    CustomerModel?: Model<CustomerModel>;\n  };\n};\n\nconst _authenticated = new Config<boolean | undefined>(undefined);\n\nexport const initialize = new Initializer<ConfigProps>({\n  init: async (config) => {\n    const defaultConfig = {\n      authHeaderConfig: {\n        header: 'Authorization',\n        tokenPrefix: 'Bearer',\n      },\n      customerPermissionRoles: false,\n      adobeCommerceOptimizer: false,\n    };\n\n    const mergedConfig = { ...defaultConfig, ...config };\n\n    initialize.config.setConfig(mergedConfig);\n\n    const token = getCookie(COOKIE_NAMES.auth_dropin_user_token);\n\n    const [authenticated] = await Promise.all([\n      verifyToken(\n        mergedConfig.authHeaderConfig.header,\n        mergedConfig.authHeaderConfig.tokenPrefix\n      ),\n      mergedConfig.customerPermissionRoles && token\n        ? getCustomerRolePermissions()\n        : Promise.resolve(),\n      mergedConfig.adobeCommerceOptimizer\n        ? getAdobeCommerceOptimizerData()\n        : Promise.resolve(),\n    ]);\n\n    _authenticated.setConfig(authenticated);\n  },\n\n  listeners: () => [\n    events.on('authenticated', (next) => {\n      const prev = _authenticated.getConfig();\n\n      if (prev !== undefined && next !== prev) {\n        _authenticated.setConfig(next);\n        const { customerPermissionRoles, adobeCommerceOptimizer } = initialize.config.getConfig();\n        if (customerPermissionRoles) {\n          getCustomerRolePermissions();\n        }\n        if (adobeCommerceOptimizer) {\n          getAdobeCommerceOptimizerData();\n        }\n      }\n    }),\n  ],\n});\n\nexport const config = initialize.config;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { getStoreConfigResponse } from '@/auth/types';\nimport { COOKIE_LIFETIME } from '@/auth/configs/cookieConfigs';\nimport { StoreConfigModel } from '../models';\n\nexport const transformStoreConfig = (\n  response: getStoreConfigResponse\n): StoreConfigModel => {\n  return {\n    autocompleteOnStorefront:\n      response?.data?.storeConfig?.autocomplete_on_storefront || false,\n    // Need information about min length in response undefined\n    minLength: response?.data?.storeConfig?.minimum_password_length || 3,\n    requiredCharacterClasses:\n      +response?.data?.storeConfig?.required_character_classes_number || 0,\n    createAccountConfirmation:\n      response?.data?.storeConfig?.create_account_confirmation || false,\n    customerAccessTokenLifetime:\n      response?.data?.storeConfig?.customer_access_token_lifetime *\n        COOKIE_LIFETIME || COOKIE_LIFETIME,\n  };\n};\n","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { AdobeCommerceOptimizerModel } from '../models';\n\nexport interface AdobeCommerceOptimizerData {\n  priceBookId: string;\n}\n\nexport interface AdobeCommerceOptimizerResponse {\n  data?: {\n    commerceOptimizer?: AdobeCommerceOptimizerData;\n  };\n}\n\nexport const transformAdobeCommerceOptimizerData = (\n  response: AdobeCommerceOptimizerResponse\n): AdobeCommerceOptimizerModel => {\n  return {\n    priceBookId: response?.data?.commerceOptimizer?.priceBookId || '',\n  };\n};\n\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\n/** Actions */\nexport const handleFetchError = (errors: Array<{ message: string }>) => {\n  const errorMessage = errors.map((e: any) => e.message).join(' ');\n\n  throw Error(errorMessage);\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\n/**\n * Converts a base64 encoded string to a SHA1 hash string\n * @param base64String - The base64 encoded string to convert\n * @returns A promise that resolves to the SHA1 hash as a hexadecimal string, or empty string if input is undefined/null/empty or if conversion fails\n */\nexport const base64ToSha1 = async (\n  base64String?: string | null\n): Promise<string> => {\n  // Handle edge cases: undefined, null, or empty string\n  if (!base64String || base64String.trim() === '') {\n    return '';\n  }\n\n  try {\n    // Decode base64 string to binary data\n    const binaryString = atob(base64String);\n    const bytes = new Uint8Array(binaryString.length);\n    for (let i = 0; i < binaryString.length; i++) {\n      bytes[i] = binaryString.charCodeAt(i);\n    }\n\n    // Compute SHA1 hash using Web Crypto API\n    const hashBuffer = await crypto.subtle.digest('SHA-1', bytes);\n\n    // Convert hash to hexadecimal string\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    const hashHex = hashArray\n      .map((byte) => byte.toString(16).padStart(2, '0'))\n      .join('');\n\n    return hashHex;\n  } catch (error) {\n    console.error(\n      `Failed to convert base64 to SHA1: ${error instanceof Error ? error.message : 'Unknown error'}`\n    );\n    return '';\n  }\n};\n\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { base64ToSha1 } from './base64ToSha1';\n\n/**\n * Default customer group ID for non-logged-in (NLI) customers.\n * This value is emitted via the 'auth/group-uid' event when:\n * - A customer is not authenticated\n * - Token validation fails\n * - Customer logs out\n */\nexport const DEFAULT_NLI_CUSTOMER_GROUP_ID = 'b6589fc6ab0dc82cf12099d1c2d40ab994e8410c';\n\n/**\n * Emits the auth/group-uid event with the provided group UID.\n * If a value is provided, it will be converted from base64 to SHA1 hash.\n * If no value is provided, the default NLI customer group ID will be emitted.\n * \n * @param groupUid - The base64 encoded group UID, or undefined/null for default\n */\nexport const emitAuthGroupIdEvent = async (\n  groupUid?: string | null\n): Promise<void> => {\n  const groupIdHash = groupUid \n    ? await base64ToSha1(groupUid) \n    : DEFAULT_NLI_CUSTOMER_GROUP_ID;\n  \n  events.emit('auth/group-uid', groupIdHash);\n};\n\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nexport const GET_STORE_CONFIG = /* GraphQL */ `\n  query GET_STORE_CONFIG {\n    storeConfig {\n      autocomplete_on_storefront\n      minimum_password_length\n      required_character_classes_number\n      store_code\n      store_name\n      store_group_code\n      locale\n      create_account_confirmation\n      customer_access_token_lifetime\n    }\n  }\n`;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { getStoreConfigResponse } from '@/auth/types';\nimport { fetchGraphQl } from '../fetch-graphql';\nimport { GET_STORE_CONFIG } from './graphql/getStoreConfig.graphql';\nimport { handleNetworkError } from '@/auth/lib/network-error';\nimport { transformStoreConfig } from '@/auth/data/transforms';\nimport { StoreConfigModel } from '@/auth/data/models';\nimport { handleFetchError } from '@/auth/lib/fetch-error';\n\nexport const getStoreConfig = async (): Promise<StoreConfigModel> => {\n  return await fetchGraphQl(GET_STORE_CONFIG, {\n    method: 'GET',\n    cache: 'force-cache',\n  })\n    .then((response: getStoreConfigResponse) => {\n      if (response.errors?.length) return handleFetchError(response.errors);\n\n      return transformStoreConfig(response);\n    })\n    .catch(handleNetworkError);\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nexport const VALIDATE_CUSTOMER_TOKEN = /* GraphQL */ `\n  query VALIDATE_TOKEN {\n    customer {\n      group {\n        uid\n      }\n    }\n  }\n`;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { events } from '@adobe-commerce/event-bus';\nimport {\n  fetchGraphQl,\n  removeFetchGraphQlHeader,\n  setFetchGraphQlHeader,\n} from '../fetch-graphql';\nimport { deleteCookie, getCookie } from '@/auth/lib/cookieUtils';\nimport { COOKIE_NAMES } from '@/auth/configs/cookieConfigs';\nimport { VALIDATE_CUSTOMER_TOKEN } from './graphql/verifyToken.graphql';\nimport { emitAuthGroupIdEvent } from '@/auth/lib/emitAuthGroupId';\n\nexport const verifyToken = async (\n  authType = 'Authorization',\n  type = 'Bearer'\n) => {\n  const token = getCookie(COOKIE_NAMES.auth_dropin_user_token);\n\n  if (!token) {\n    await emitAuthGroupIdEvent();\n    events.emit('authenticated', false);\n    return false;\n  }\n\n  setFetchGraphQlHeader(authType, `${type} ${token}`);\n\n  return fetchGraphQl(VALIDATE_CUSTOMER_TOKEN).then(async (res) => {\n    const unauthenticated = !!res.errors?.find(\n      (error) => error.extensions?.category === 'graphql-authentication'\n    );\n\n    if (!unauthenticated) {\n      await emitAuthGroupIdEvent(res.data?.customer?.group?.uid);\n      events.emit('authenticated', true);\n      return true;\n    };\n\n    deleteCookie(COOKIE_NAMES.auth_dropin_user_token);\n    removeFetchGraphQlHeader(authType);\n    await emitAuthGroupIdEvent();\n    events.emit('authenticated', false);\n    return false;\n  });\n};\n","export const GET_CUSTOMER_ROLE_PERMISSIONS = `\n  query GET_CUSTOMER_ROLE_PERMISSIONS {\n    customer {\n      purchase_orders_enabled\n      role {\n        id\n        name\n        permissions {\n          id\n          text\n          children {\n            id\n            text\n            children {\n              id\n              text\n              children {\n                id\n                text\n                children {\n                  id\n                  text\n                  children {\n                    id\n                    text\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n`;\n","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { fetchGraphQl } from '@/auth/api/fetch-graphql';\nimport { PermissionsModel } from '@/auth/data/models';\nimport { GET_CUSTOMER_ROLE_PERMISSIONS } from './graphql/getCustomerRolePermissions.graphql';\n\n// TypeScript interfaces\ninterface Permission {\n  id: string;\n  text: string;\n  children?: Permission[];\n}\n\ninterface Role {\n  id: string;\n  name: string;\n  permissions?: Permission[];\n}\n\ninterface GetCustomerRolePermissionsResponse {\n  data?: {\n    customer?: {\n      purchase_orders_enabled?: boolean;\n      role?: Role;\n    };\n  };\n  errors?: {\n    message: string;\n  }[];\n}\n\n// Module-level cache\nlet permissionsCache: PermissionsModel | null = null;\nlet fetchPromise: Promise<PermissionsModel> | null = null;\n\n/**\n * Recursively flattens permission tree into a flat object\n */\nconst flattenPermissionTree = (\n  permissions: Permission[]\n): Record<string, boolean> => {\n  const flattened: Record<string, boolean> = {};\n\n  const processPermissions = (perms: Permission[]): void => {\n    perms.forEach((permission) => {\n      flattened[permission.id] = true;\n      if (permission.children?.length) {\n        processPermissions(permission.children);\n      }\n    });\n  };\n\n  processPermissions(permissions);\n  return flattened;\n};\n\n/**\n * Purchase Order related permissions that should be set to false\n * when purchase orders are disabled\n */\nconst PURCHASE_ORDER_PERMISSIONS = [\n  'Magento_PurchaseOrder::all',\n  'Magento_PurchaseOrder::view_purchase_orders',\n  'Magento_PurchaseOrder::view_purchase_orders_for_subordinates',\n  'Magento_PurchaseOrder::view_purchase_orders_for_company',\n  'Magento_PurchaseOrder::autoapprove_purchase_order',\n  'Magento_PurchaseOrderRule::super_approve_purchase_order',\n  'Magento_PurchaseOrderRule::view_approval_rules',\n  'Magento_PurchaseOrderRule::manage_approval_rules',\n];\n\n/**\n * Determines if user has admin privileges\n * Admin is only when user has role ID 'MA==' AND has an empty permissions array\n */\nconst isAdminUser = (role?: Role): boolean => {\n  return (\n    role?.id === 'MA==' &&\n    Array.isArray(role.permissions) &&\n    role.permissions.length === 0\n  );\n};\n\n/**\n * Gets all available permissions from the GraphQL response\n * Returns an empty object if no permissions (e.g., admin users have empty array)\n */\nconst getAllPermissions = (role?: Role): Record<string, boolean> => {\n  if (role?.permissions?.length) {\n    return flattenPermissionTree(role.permissions);\n  }\n  return {};\n};\n\n/**\n * Handles purchase order permissions based on PO enabled status\n * When PO is disabled, explicitly sets all PO permissions to false\n * This ensures consumers can distinguish between \"no data\" and \"explicitly disabled\"\n */\nconst overridePurchaseOrderPermissions = (\n  permissions: Record<string, boolean>,\n  purchaseOrdersEnabled?: boolean\n): Record<string, boolean> => {\n  // If PO is enabled, return permissions as-is from backend\n  if (purchaseOrdersEnabled === true) {\n    return permissions;\n  }\n\n  // When PO is disabled, explicitly set all PO permissions to false\n  const result = { ...permissions };\n  PURCHASE_ORDER_PERMISSIONS.forEach((permission) => {\n    result[permission] = false;\n  });\n\n  return result;\n};\n\n/**\n * Processes role data into flattened permissions\n */\nconst processUserPermissions = (\n  role?: Role,\n  purchaseOrdersEnabled?: boolean\n): PermissionsModel => {\n  const isAdmin = isAdminUser(role);\n\n  // Get all permissions (for both admin and non-admin users)\n  const allPermissions = getAllPermissions(role);\n\n  // Override PO permissions to false if PO is disabled\n  const processedPermissions = overridePurchaseOrderPermissions(\n    allPermissions,\n    purchaseOrdersEnabled\n  );\n\n  const basePermissions: PermissionsModel = {\n    all: true,\n    ...(isAdmin && { admin: true }),\n  };\n\n  return { ...basePermissions, ...processedPermissions };\n};\n\n/**\n * Fetches user role permissions from GraphQL API\n */\nconst fetchUserRolePermissions = async (): Promise<PermissionsModel> => {\n  try {\n    const response = (await fetchGraphQl(GET_CUSTOMER_ROLE_PERMISSIONS, {\n      method: 'GET',\n    })) as GetCustomerRolePermissionsResponse;\n\n    const permissions = processUserPermissions(\n      response.data?.customer?.role,\n      response.data?.customer?.purchase_orders_enabled\n    );\n\n    // Update cache\n    permissionsCache = permissions;\n    fetchPromise = null;\n\n    return permissions;\n  } catch (error) {\n    fetchPromise = null;\n    throw error;\n  }\n};\n\n/**\n * Gets user role permissions with caching\n */\nexport const getCustomerRolePermissions = (): Promise<PermissionsModel> => {\n  // Return cached data as resolved promise if available\n  if (permissionsCache) {\n    events.emit('auth/permissions', permissionsCache);\n    return Promise.resolve(permissionsCache);\n  }\n\n  // No cache available - create and return fetch promise if not already fetching\n  if (!fetchPromise) {\n    fetchPromise = fetchUserRolePermissions().then((permissions) => {\n      events.emit('auth/permissions', permissions);\n      return permissions;\n    });\n  }\n\n  return fetchPromise;\n};\n\n/**\n * Resets the permissions cache\n * @internal\n */\nexport const _resetCache = (): void => {\n  permissionsCache = null;\n  fetchPromise = null;\n};\n","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nexport const GET_ADOBE_COMMERCE_OPTIMIZER_DATA = /* GraphQL */`\n  query GET_ADOBE_COMMERCE_OPTIMIZER_DATA {\n    commerceOptimizer {\n      priceBookId\n    }\n  }\n`;\n\n","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { fetchGraphQl } from '@/auth/api/fetch-graphql';\nimport { AdobeCommerceOptimizerModel } from '@/auth/data/models';\nimport {\n  transformAdobeCommerceOptimizerData,\n  AdobeCommerceOptimizerResponse,\n} from '@/auth/data/transforms';\nimport { GET_ADOBE_COMMERCE_OPTIMIZER_DATA } from './graphql/getAdobeCommerceOptimizerData.graphql';\n\n/**\n * Fetches Adobe Commerce Optimizer data from GraphQL API\n * This function works for both authenticated and non-authenticated users\n */\nexport const getAdobeCommerceOptimizerData =\n  async (): Promise<AdobeCommerceOptimizerModel> => {\n    const response = (await fetchGraphQl(GET_ADOBE_COMMERCE_OPTIMIZER_DATA, {\n      method: 'GET',\n    })) as AdobeCommerceOptimizerResponse;\n\n    const adobeCommerceOptimizerData = transformAdobeCommerceOptimizerData(response);\n\n    // Emit event with the adobe commerce optimizer data\n    events.emit('auth/adobe-commerce-optimizer', adobeCommerceOptimizerData);\n\n    return adobeCommerceOptimizerData;\n  };\n"],"names":["COOKIE_NAMES","LOCALHOST","COOKIE_LIFETIME","getCookie","cookieName","cookies","foundValue","cookie","name","value","deleteCookie","getCookiesLifetime","storeConfigString","accessTokenLifeTime","storeConfig","getStoreConfig","error","_authenticated","Config","initialize","Initializer","config","mergedConfig","token","authenticated","verifyToken","getCustomerRolePermissions","getAdobeCommerceOptimizerData","events","next","prev","customerPermissionRoles","adobeCommerceOptimizer","transformStoreConfig","response","_b","_a","_d","_c","_f","_e","_h","_g","_j","_i","transformAdobeCommerceOptimizerData","handleFetchError","errors","errorMessage","e","base64ToSha1","base64String","binaryString","bytes","hashBuffer","byte","DEFAULT_NLI_CUSTOMER_GROUP_ID","emitAuthGroupIdEvent","groupUid","groupIdHash","GET_STORE_CONFIG","fetchGraphQl","handleNetworkError","VALIDATE_CUSTOMER_TOKEN","authType","type","setFetchGraphQlHeader","res","removeFetchGraphQlHeader","GET_CUSTOMER_ROLE_PERMISSIONS","permissionsCache","fetchPromise","flattenPermissionTree","permissions","flattened","processPermissions","perms","permission","PURCHASE_ORDER_PERMISSIONS","isAdminUser","role","getAllPermissions","overridePurchaseOrderPermissions","purchaseOrdersEnabled","result","processUserPermissions","isAdmin","allPermissions","processedPermissions","fetchUserRolePermissions","_resetCache","GET_ADOBE_COMMERCE_OPTIMIZER_DATA","adobeCommerceOptimizerData"],"mappings":"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"}