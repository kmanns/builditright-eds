{"version":3,"file":"ApplePay.js","sources":["/@dropins/storefront-payment-services/src/containers/ApplePay/ApplePay.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Lang, useText } from '@adobe-commerce/elsie/i18n';\nimport { useEffect, useRef } from 'preact/compat';\nimport {\n  ApplePay as ApplePayPaymentMethod,\n  ApplePayRenderConfig,\n} from '@adobe-commerce/payment-services-sdk/payment';\nimport { DEFAULT_LOCALE, useLocale } from '@/hooks/useLocale';\nimport * as signals from '@/lib/signals';\nimport LocalizedError, { fromPaymentsSDKError } from '@/lib/localizedError';\nimport { PaymentLocation } from '@/api';\nimport { useState } from 'preact/hooks';\n\nexport interface ApplePayProps {\n  /**\n   * Location where the Apple Pay button is to be rendered.\n   */\n  location: PaymentLocation;\n  /**\n   * Required if createCart not provided.\n   * Should return a promise that resolves to the shopper's cart ID.\n   */\n  getCartId?: () => Promise<string>;\n  /**\n   * Required if getCartId not provided.\n   */\n  createCart?: {\n    /**\n     * Should return a list with the cart items to purchase.\n     *\n     * The list must contain at least one cart item.\n     */\n    getCartItems: () => CartItem[];\n  };\n  /**\n   * Called when the user clicks the Apple Pay button. This callback receives a 'showPaymentSheet' function as its only\n   * argument that must be called to begin the Apple Pay session and show the payment sheet.\n   *\n   * IMPORTANT: The 'showPaymentSheet' function must be called synchronously. If called asynchronously, it will throw\n   *        ... an exception \"Must create a newApplePaySession from a user gesture handler.\"\n   */\n  onButtonClick?: (showPaymentSheet: () => void) => void;\n  /**\n   * Called when payment flow is successful.\n   */\n  onSuccess?: (result: { cartId: string }) => void;\n  /**\n   * Called when the payment flow was aborted due to an error.\n   *\n   * The function receives an object with two properties, { name: string, message: string }, containing the localized\n   * error name and message. Both properties are user-facing and can be translated using the\n   * \"PaymentServices.ApplePay.errors\" language definitions.\n   */\n  onError?: (localizedError: LocalizedError) => void;\n  /**\n   * Whether the button is hidden. Set this to true to hide the Apple Pay button (default: false).\n   */\n  hidden?: boolean;\n  /**\n   * Whether the button is disabled. Set this to true to disable the Apple Pay button (default: false).\n   */\n  disabled?: boolean;\n}\n\n/**\n * Apple pay button container element class.\n */\nconst CONTAINER_CSS_CLASS: string = 'payment-services_apple-pay-container';\n\n/**\n * Helper type for locale format that the Payments JS SDK works with for Apple Pay.\n */\ntype ApplePayLocale = 'en-US';\n\nfunction getSDK(location: PaymentLocation) {\n  const paymentServicesSDKs = signals.paymentsSDK.value;\n  switch (location) {\n    case PaymentLocation.CHECKOUT:\n      return paymentServicesSDKs?.checkout;\n    case PaymentLocation.PRODUCT_DETAIL:\n      return paymentServicesSDKs?.productDetail;\n    default:\n      throw new Error(`Unsupported location: ${location}`);\n  }\n}\n\nexport const ApplePay = ({\n  location,\n  getCartId,\n  createCart,\n  onButtonClick,\n  onSuccess,\n  onError,\n  hidden,\n  disabled,\n}: ApplePayProps) => {\n  if ((!getCartId && !createCart) || (getCartId && createCart)) {\n    throw new Error(\n      'Either getCartId or createCart must be provided and not both.'\n    );\n  }\n\n  const sdk = getSDK(location);\n  const [applePay, setApplePay] = useState<ApplePayPaymentMethod | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const storeFrontLocale = useLocale();\n  const initialDisabled = useRef<boolean>(!!disabled);\n\n  const {\n    methodNotAvailableMessage,\n    methodNotLoadedMessage,\n    methodLoadingMessage,\n  } = useText({\n    methodNotAvailableMessage: 'PaymentServices.messages.methodNotAvailable',\n    methodNotLoadedMessage: 'PaymentServices.messages.methodNotLoaded',\n    methodLoadingMessage: 'PaymentServices.messages.methodLoading',\n  });\n\n  useEffect(() => {\n    let shadowCartIdPromise: Promise<{ cartId: string }> | null = null;\n    if (!sdk?.Payment.ApplePay.isAvailable()) return;\n    if (!containerRef.current) return;\n\n    const containerId = `apple-pay-${Math.random().toString(36).slice(2, 11)}`;\n    containerRef.current.id = containerId;\n\n    const getOrCreateCart: () => Promise<string> = async () => {\n      if (getCartId) {\n        return getCartId();\n      }\n      const cartItems = createCart!.getCartItems(); // Can't be null nor undefined due to the check above.\n      if (!cartItems) {\n        throw new Error('No items found to be added to the cart.');\n      }\n      shadowCartIdPromise = sdk._Utils.addProductsToNewCart(\n        toCartItemInputs(cartItems)\n      );\n      return (await shadowCartIdPromise).cartId;\n    };\n\n    const onCancel = () => {\n      if (shadowCartIdPromise !== null) {\n        shadowCartIdPromise\n          .then(async ({ cartId }) => {\n            await sdk._Utils.setCartAsInactive(cartId);\n          })\n          .catch(console.error);\n      }\n    };\n\n    const renderConfig: ApplePayRenderConfig = {\n      getCartId: getOrCreateCart,\n      useApplePayShippingAddress: location === PaymentLocation.PRODUCT_DETAIL,\n      useApplePayBillingAddress: location === PaymentLocation.PRODUCT_DETAIL,\n      onSuccess,\n      onError: (error) => {\n        if (onError === undefined) {\n          console.error(error);\n        } else {\n          onError(fromPaymentsSDKError('ApplePay', error));\n        }\n      },\n      buttonLanguage: { locale: toAppleLocale(storeFrontLocale) },\n      container: `#${containerId}`,\n      onButtonClick,\n      onCancel,\n      disabled: initialDisabled.current,\n    };\n\n    let newApplePayInstance: ApplePayPaymentMethod | null = null;\n    sdk.Payment.ApplePay.render(renderConfig)\n      .then((instance) => {\n        newApplePayInstance = instance;\n        setApplePay(newApplePayInstance);\n      })\n      .catch((error) => {\n        console.error('Apple Pay render failed:', error);\n      });\n\n    return () => {\n      if (newApplePayInstance) {\n        newApplePayInstance.teardown();\n      }\n    };\n  }, [\n    sdk,\n    location,\n    getCartId,\n    createCart,\n    onSuccess,\n    onError,\n    onButtonClick,\n    storeFrontLocale,\n  ]);\n\n  useEffect(() => {\n    if (applePay) {\n      applePay.setDisabled(!!disabled);\n    }\n  }, [applePay, disabled]);\n\n  const styles = {\n    display: hidden ? 'none' : 'block',\n  };\n\n  if (sdk && !sdk.Payment.ApplePay.isAvailable()) {\n    return (\n      <div ref={containerRef} class={CONTAINER_CSS_CLASS} style={styles}>\n        <div class=\"apple-pay-error\">{methodNotAvailableMessage}</div>\n      </div>\n    );\n  }\n\n  if (signals.status.value === 'error') {\n    return (\n      <div ref={containerRef} class={CONTAINER_CSS_CLASS} style={styles}>\n        <div class=\"apple-pay-error\">{methodNotLoadedMessage}</div>\n      </div>\n    );\n  }\n\n  if (signals.status.value === 'initializing') {\n    return (\n      <div ref={containerRef} class={CONTAINER_CSS_CLASS} style={styles}>\n        <div class=\"apple-pay-loading\">{methodLoadingMessage}</div>\n      </div>\n    );\n  }\n\n  return (\n    <div ref={containerRef} class={CONTAINER_CSS_CLASS} style={styles}>\n      {/* Apple Pay button will be rendered here by the SDK */}\n    </div>\n  );\n};\n\nfunction toCartItemInputs(cartItems: CartItem[]) {\n  return cartItems.map((cartItem) => ({\n    sku: cartItem.sku,\n    quantity: cartItem.quantity,\n    parent_sku: cartItem.parentSku,\n    selected_options: cartItem.selectedOptions,\n    entered_options: cartItem.enteredOptions,\n  }));\n}\n\n/**\n * Maps elsie locale to the format that the Payment Services SDK expects for Apple Pay: a formatted string\n * consisting of an ISO-639-1 language code and an ISO-3166-1 region code, separated by a hyphen (-),\n * e.g., \"nl-NL\".\n */\nfunction toAppleLocale(locale: Lang): ApplePayLocale {\n  const parts = locale.split('_'); // e.g., split \"en_US\" into [\"en\", \"US\"]\n  if (parts.length < 2) {\n    const default_ = toAppleLocale(DEFAULT_LOCALE);\n    console.warn(\n      `Cannot map elsie locale \"${locale}\" to apple pay button locale. Falling back to \"${default_}\".`\n    );\n    return default_;\n  }\n  return `${parts[0]}-${parts[1]}` as ApplePayLocale;\n}\n\n/**\n * See https://developer.adobe.com/commerce/webapi/graphql-api/index.html#definition-CartItemInput.\n */\ninterface CartItem {\n  sku: string;\n  quantity: number;\n  parentSku?: string;\n  selectedOptions?: (string | number)[];\n  enteredOptions?: { uid: string | number; value: string }[];\n}\n"],"names":["CONTAINER_CSS_CLASS","getSDK","location","paymentServicesSDKs","signals.paymentsSDK","PaymentLocation","ApplePay","getCartId","createCart","onButtonClick","onSuccess","onError","hidden","disabled","sdk","applePay","setApplePay","useState","containerRef","useRef","storeFrontLocale","useLocale","initialDisabled","methodNotAvailableMessage","methodNotLoadedMessage","methodLoadingMessage","useText","useEffect","shadowCartIdPromise","containerId","getOrCreateCart","cartItems","toCartItemInputs","onCancel","cartId","renderConfig","error","fromPaymentsSDKError","toAppleLocale","newApplePayInstance","instance","styles","jsx","signals.status","cartItem","locale","parts","default_","DEFAULT_LOCALE"],"mappings":"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"}