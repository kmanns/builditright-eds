{"version":3,"file":"useCompanyRoles.js","sources":["/@dropins/storefront-company-management/src/hooks/useCompanyRoles.ts"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useState, useEffect, useCallback } from 'preact/hooks';\nimport {\n  getCompanyRoles,\n  getCompanyAclResources,\n  createCompanyRole,\n  updateCompanyRole,\n  deleteCompanyRole,\n  isCompanyRoleNameAvailable,\n  CompanyRoleModel,\n  CompanyAclResourceModel,\n  CompanyRoleCreateInputModel,\n  CompanyRoleUpdateInputModel,\n  GetCompanyRolesVariables,\n} from '../api/companyRoles';\nimport { useCompanyContextListener } from './useCompanyContextListener';\n\nexport const DEFAULT_PAGINATION_SIZE = 10;\n\nexport interface UseCompanyRolesReturn {\n  roles: CompanyRoleModel[];\n  aclResources: CompanyAclResourceModel[];\n  totalCount: number;\n  currentPage: number;\n  pageSize: number;\n  totalPages: number;\n  \n  isLoading: boolean;\n  isCreating: boolean;\n  isUpdating: boolean;\n  isDeleting: boolean;\n  \n  error: string | null;\n  \n  fetchRoles: (variables?: GetCompanyRolesVariables) => Promise<void>;\n  fetchAclResources: () => Promise<void>;\n  createRole: (input: CompanyRoleCreateInputModel) => Promise<CompanyRoleModel | null>;\n  updateRole: (input: CompanyRoleUpdateInputModel) => Promise<CompanyRoleModel | null>;\n  deleteRole: (id: string) => Promise<boolean>;\n  checkRoleNameAvailability: (name: string) => Promise<boolean>;\n  \n  setPage: (page: number) => void;\n  setPageSize: (size: number) => void;\n  \n  refresh: () => Promise<void>;\n  clearError: () => void;\n}\n\nexport const useCompanyRoles = (\n  initialPageSize: number = DEFAULT_PAGINATION_SIZE,\n  autoFetch: boolean = true,\n  clientSidePagination: boolean = false\n): UseCompanyRolesReturn => {\n  const [roles, setRoles] = useState<CompanyRoleModel[]>([]);\n  const [aclResources, setAclResources] = useState<CompanyAclResourceModel[]>([]);\n  const [totalCount, setTotalCount] = useState(0);\n  const [currentPage, setCurrentPage] = useState(1);\n  const [pageSize, setPageSize] = useState(initialPageSize);\n  const [totalPages, setTotalPages] = useState(1);\n  \n  const [isLoading, setIsLoading] = useState(false);\n  const [isCreating, setIsCreating] = useState(false);\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n  \n  const [error, setError] = useState<string | null>(null);\n\n  const fetchRoles = useCallback(async (variables: GetCompanyRolesVariables = {}) => {\n    setIsLoading(true);\n    setError(null);\n    \n    try {\n      if (clientSidePagination) {\n        // For client-side pagination, fetch all roles at once\n        const response = await getCompanyRoles({\n          pageSize: 1000,\n          currentPage: 1,\n          ...variables,\n        });\n        \n        setRoles(response.items);\n        setTotalCount(response.totalCount);\n        setTotalPages(1);\n        setCurrentPage(1);\n      } else {\n        // Server-side pagination\n        const response = await getCompanyRoles({\n          pageSize,\n          currentPage,\n          ...variables,\n        });\n        \n        setRoles(response.items);\n        setTotalCount(response.totalCount);\n        setTotalPages(response.pageInfo.totalPages);\n        setCurrentPage(response.pageInfo.currentPage);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to fetch roles');\n    } finally {\n      setIsLoading(false);\n    }\n  }, [clientSidePagination, pageSize, currentPage]);\n\n  const fetchAclResources = useCallback(async () => {\n    try {\n      const resources = await getCompanyAclResources();\n      setAclResources(resources);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to fetch ACL resources');\n    }\n  }, []);\n\n  const createRole = useCallback(async (input: CompanyRoleCreateInputModel): Promise<CompanyRoleModel | null> => {\n    setIsCreating(true);\n    setError(null);\n    \n    try {\n      const newRole = await createCompanyRole(input);\n      await fetchRoles();\n      return newRole;\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to create role');\n      return null;\n    } finally {\n      setIsCreating(false);\n    }\n  }, [fetchRoles]);\n\n  const updateRole = useCallback(async (input: CompanyRoleUpdateInputModel): Promise<CompanyRoleModel | null> => {\n    setIsUpdating(true);\n    setError(null);\n    \n    try {\n      const updatedRole = await updateCompanyRole(input);\n      \n      // Update the role in the local state\n      setRoles(prevRoles => \n        prevRoles.map(role => \n          role.id === updatedRole.id ? updatedRole : role\n        )\n      );\n      \n      return updatedRole;\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to update role');\n      return null;\n    } finally {\n      setIsUpdating(false);\n    }\n  }, []);\n\n  const deleteRole = useCallback(async (id: string): Promise<boolean> => {\n    setIsDeleting(true);\n    setError(null);\n    \n    try {\n      const success = await deleteCompanyRole({ id });\n      \n      if (success) {\n        // Remove the role from local state\n        setRoles(prevRoles => prevRoles.filter(role => role.id !== id));\n        setTotalCount(prev => prev - 1);\n      }\n      \n      return success;\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to delete role');\n      return false;\n    } finally {\n      setIsDeleting(false);\n    }\n  }, []);\n\n  const checkRoleNameAvailability = useCallback(async (name: string): Promise<boolean> => {\n    try {\n      return await isCompanyRoleNameAvailable({ name });\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to check role name availability');\n      return false;\n    }\n  }, []);\n\n  const setPage = useCallback((page: number) => {\n    setCurrentPage(page);\n  }, []);\n\n  const setPageSizeHandler = useCallback((size: number) => {\n    setPageSize(size);\n    setCurrentPage(1); // Reset to first page when changing page size\n  }, []);\n\n  const refresh = useCallback(async () => {\n    await Promise.all([\n      fetchRoles(),\n      fetchAclResources(),\n    ]);\n  }, [fetchRoles, fetchAclResources]);\n\n  const clearError = useCallback(() => {\n    setError(null);\n  }, []);\n\n  // Auto-fetch on mount and when pagination changes\n  useEffect(() => {\n    if (autoFetch) {\n      fetchRoles();\n    }\n  }, [fetchRoles, autoFetch]);\n\n  // Fetch ACL resources on mount\n  useEffect(() => {\n    if (autoFetch) {\n      fetchAclResources();\n    }\n  }, [fetchAclResources, autoFetch]);\n\n  // Listen for company context changes to clear stale data\n  // Note: We don't call refresh() here to avoid race conditions with permission updates.\n  // The parent component (RolesAndPermissions) will call refresh() after permissions update.\n  useCompanyContextListener(\n    useCallback(() => {\n      setCurrentPage(1);\n      setRoles([]);\n      setAclResources([]);\n      setTotalCount(0);\n      setTotalPages(0);\n      setIsLoading(true);\n    }, []),\n    { eager: true }\n  );\n\n  return {\n    roles,\n    aclResources,\n    totalCount,\n    currentPage,\n    pageSize,\n    totalPages,\n    isLoading,\n    isCreating,\n    isUpdating,\n    isDeleting,\n    error,\n    fetchRoles,\n    fetchAclResources,\n    createRole,\n    updateRole,\n    deleteRole,\n    checkRoleNameAvailability,\n    setPage,\n    setPageSize: setPageSizeHandler,\n    refresh,\n    clearError,\n  };\n};\n"],"names":["DEFAULT_PAGINATION_SIZE","useCompanyRoles","initialPageSize","autoFetch","clientSidePagination","roles","setRoles","useState","aclResources","setAclResources","totalCount","setTotalCount","currentPage","setCurrentPage","pageSize","setPageSize","totalPages","setTotalPages","isLoading","setIsLoading","isCreating","setIsCreating","isUpdating","setIsUpdating","isDeleting","setIsDeleting","error","setError","fetchRoles","useCallback","variables","response","getCompanyRoles","err","fetchAclResources","resources","getCompanyAclResources","createRole","input","newRole","createCompanyRole","updateRole","updatedRole","updateCompanyRole","prevRoles","role","deleteRole","id","success","deleteCompanyRole","prev","checkRoleNameAvailability","name","isCompanyRoleNameAvailable","setPage","page","setPageSizeHandler","size","refresh","clearError","useEffect","useCompanyContextListener"],"mappings":"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"}