{"version":3,"file":"useUserPermissions.js","sources":["../../node_modules/@adobe-commerce/elsie/src/components/Table/Table.tsx","/@dropins/storefront-company-management/src/hooks/useUserPermissions.ts"],"sourcesContent":["/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { FunctionComponent, VNode, Fragment } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\nimport { classes, VComponent } from '@adobe-commerce/elsie/lib';\nimport {\n  Icon,\n  Button,\n  Skeleton,\n  SkeletonRow,\n} from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\n\nimport '@adobe-commerce/elsie/components/Table/Table.css';\n\ntype Sortable = 'asc' | 'desc' | true;\n\ntype Column =\n  | { label: string; key: string; ariaLabel?: string; sortBy?: Sortable }\n  | {\n      label: VNode<HTMLAttributes<HTMLElement>>;\n      key: string;\n      ariaLabel: string;\n      sortBy?: Sortable;\n    };\n\ntype RowData = {\n  [key: string]: VNode | string | number | undefined;\n  _rowDetails?: VNode | string; // Special property for expandable row content\n};\n\nexport interface TableProps\n  extends Omit<HTMLAttributes<HTMLTableElement>, 'loading'> {\n  columns: Column[];\n  rowData: RowData[];\n  mobileLayout?: 'stacked' | 'none';\n  caption?: string;\n  expandedRows?: Set<number>;\n  loading?: boolean;\n  skeletonRowCount?: number;\n  onSortChange?: (columnKey: string, direction: Sortable) => void;\n}\n\nexport const Table: FunctionComponent<TableProps> = ({\n  className,\n  children,\n  columns = [],\n  rowData = [],\n  mobileLayout = 'none',\n  caption,\n  expandedRows = new Set(),\n  loading = false,\n  skeletonRowCount = 10,\n  onSortChange,\n  ...props\n}) => {\n  const translations = useText({\n    sortedAscending: 'Dropin.Table.sortedAscending',\n    sortedDescending: 'Dropin.Table.sortedDescending',\n    sortBy: 'Dropin.Table.sortBy',\n  });\n\n  const handleSort = (column: Column) => {\n    if (!onSortChange) return;\n\n    // Determine next sort direction\n    let nextDirection: Sortable;\n    if (column.sortBy === true) {\n      nextDirection = 'asc';\n    } else if (column.sortBy === 'asc') {\n      nextDirection = 'desc';\n    } else {\n      nextDirection = true;\n    }\n\n    onSortChange(column.key, nextDirection);\n  };\n\n  const renderSortButton = (column: Column) => {\n    if (column.sortBy === undefined) return null;\n    const label = column.ariaLabel ?? (column.label as string);\n\n    let iconSource: string;\n    let ariaLabel: string;\n\n    if (column.sortBy === 'asc') {\n      iconSource = 'ChevronUp';\n      ariaLabel = translations.sortedAscending.replace('{label}', label);\n    } else if (column.sortBy === 'desc') {\n      iconSource = 'ChevronDown';\n      ariaLabel = translations.sortedDescending.replace('{label}', label);\n    } else {\n      // Show chevron down when sortable but not sorted\n      iconSource = 'ChevronDown';\n      ariaLabel = translations.sortBy.replace('{label}', label);\n    }\n\n    return (\n      <Button\n        variant=\"tertiary\"\n        size=\"medium\"\n        className=\"dropin-table__header__sort-button\"\n        icon={<Icon source={iconSource} />}\n        aria-label={ariaLabel}\n        onClick={() => handleSort(column)}\n      />\n    );\n  };\n\n  const renderSkeletonRows = () => {\n    return Array.from({ length: skeletonRowCount }, (_, rowIndex) => (\n      <tr key={`skeleton-${rowIndex}`} className=\"dropin-table__body__row\">\n        {columns.map((column) => (\n          <td\n            key={column.key}\n            className=\"dropin-table__body__cell\"\n            data-label={column.ariaLabel ?? column.label}\n          >\n            <Skeleton>\n              <SkeletonRow variant=\"row\" size=\"small\" fullWidth />\n            </Skeleton>\n          </td>\n        ))}\n      </tr>\n    ));\n  };\n\n  const renderDataRows = () => {\n    return rowData.map((row, rowIndex) => {\n      const hasDetails = row._rowDetails !== undefined;\n      const isExpanded = expandedRows.has(rowIndex);\n\n      return (\n        <Fragment key={rowIndex}>\n          <tr className={classes([\n            'dropin-table__body__row',\n            ['dropin-table__body__row--expanded', isExpanded && hasDetails],\n          ])}>\n            {columns.map((column) => {\n              const cell = row[column.key];\n              const label = column.ariaLabel ?? column.label;\n\n              if (typeof cell === 'string' || typeof cell === 'number') {\n                return (\n                  <td\n                    key={column.key}\n                    className=\"dropin-table__body__cell\"\n                    data-label={label}\n                  >\n                    {cell}\n                  </td>\n                );\n              }\n\n              return (\n                <td\n                  key={column.key}\n                  className=\"dropin-table__body__cell\"\n                  data-label={label}\n                >\n                  <VComponent node={cell!} />\n                </td>\n              );\n            })}\n          </tr>\n          {hasDetails && isExpanded && (\n            <tr\n              key={`${rowIndex}-details`}\n              className=\"dropin-table__row-details dropin-table__row-details--expanded\"\n              id={`row-${rowIndex}-details`}\n            >\n              <td\n                className=\"dropin-table__row-details__cell\"\n                colSpan={columns.length}\n                role=\"region\"\n                aria-labelledby={`row-${rowIndex}-details`}\n              >\n                {typeof row._rowDetails === 'string' ? (\n                  row._rowDetails\n                ) : (\n                  <VComponent node={row._rowDetails!} />\n                )}\n              </td>\n            </tr>\n          )}\n        </Fragment>\n      );\n    });\n  };\n\n  const getAriaSort = (\n    column: Column\n  ): 'none' | 'ascending' | 'descending' | 'other' | undefined => {\n    if (column.sortBy === true) return 'none';\n    if (column.sortBy === 'asc') return 'ascending';\n    if (column.sortBy === 'desc') return 'descending';\n    return undefined;\n  };\n\n  return (\n    <div\n      className={classes([\n        'dropin-table',\n        `dropin-table--mobile-layout-${mobileLayout}`,\n        className,\n      ])}\n    >\n      <table {...props} className=\"dropin-table__table\">\n        {caption && (\n          <caption className=\"dropin-table__caption\">{caption}</caption>\n        )}\n        <thead className=\"dropin-table__header\">\n          <tr className=\"dropin-table__header__row\">\n            {columns.map((column) => (\n              <th\n                key={column.key}\n                className={classes([\n                  'dropin-table__header__cell',\n                  [\n                    'dropin-table__header__cell--sorted',\n                    column.sortBy === 'asc' || column.sortBy === 'desc',\n                  ],\n                  [\n                    'dropin-table__header__cell--sortable',\n                    column.sortBy !== undefined,\n                  ],\n                ])}\n                aria-sort={getAriaSort(column)}\n              >\n                {column.label}\n                {renderSortButton(column)}\n              </th>\n            ))}\n          </tr>\n        </thead>\n        <tbody className=\"dropin-table__body\">\n          {loading\n            ? // Render skeleton rows when loading\n              renderSkeletonRows()\n            : // Render actual data when not loading\n              renderDataRows()}\n        </tbody>\n      </table>\n    </div>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useState, useEffect, useCallback, useRef } from 'preact/hooks';\nimport { fetchUserPermissions } from '../api/fetchUserPermissions';\nimport { buildPermissionFlags, CompanyPermissionFlags } from '../lib/company-permissions';\nimport { useCompanyContextListener } from './useCompanyContextListener';\n\n/**\n * Hook to fetch user permissions without requiring full company profile access\n */\nexport const useUserPermissions = () => {\n  const [permissions, setPermissions] = useState<CompanyPermissionFlags | null>(null);\n  const [loading, setLoading] = useState<boolean>(true);\n  const [error, setError] = useState<Error | null>(null);\n  \n  const inFlightRef = useRef<boolean>(false);\n  const didInitialFetchRef = useRef<boolean>(false);\n\n  const fetchPermissions = useCallback(async () => {\n    if (inFlightRef.current) {\n      return;\n    }\n    \n    inFlightRef.current = true;\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const { roleResponse } = await fetchUserPermissions();\n      const role = roleResponse?.data?.customer?.role;\n      const permissionFlags = buildPermissionFlags(role);\n      setPermissions(permissionFlags);\n    } catch (err) {\n      console.error('Failed to fetch user permissions:', err);\n      setError(err as Error);\n    } finally {\n      setLoading(false);\n      inFlightRef.current = false;\n    }\n  }, []);\n\n  useEffect(() => {\n    if (!didInitialFetchRef.current) {\n      didInitialFetchRef.current = true;\n      fetchPermissions();\n    }\n  }, [fetchPermissions]);\n\n  // Re-fetch permissions when company context changes\n  useCompanyContextListener(fetchPermissions, { eager: true });\n\n  return {\n    permissions,\n    loading,\n    error,\n    refetch: fetchPermissions,\n  };\n};\n"],"names":["Table","className","children","columns","rowData","mobileLayout","caption","expandedRows","loading","skeletonRowCount","onSortChange","props","translations","useText","handleSort","column","nextDirection","renderSortButton","label","iconSource","ariaLabel","jsx","Button","Icon","renderSkeletonRows","_","rowIndex","Skeleton","SkeletonRow","renderDataRows","row","hasDetails","isExpanded","Fragment","classes","cell","VComponent","getAriaSort","jsxs","useUserPermissions","permissions","setPermissions","useState","setLoading","error","setError","inFlightRef","useRef","didInitialFetchRef","fetchPermissions","useCallback","roleResponse","fetchUserPermissions","role","_b","_a","permissionFlags","buildPermissionFlags","err","useEffect","useCompanyContextListener"],"mappings":"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","x_google_ignoreList":[0]}