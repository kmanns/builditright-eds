{"version":3,"file":"updateCompany.js","sources":["/@dropins/storefront-company-management/src/api/graphql/CompanyFragment.graphql.ts","/@dropins/storefront-company-management/src/api/graphql/buildCompanyQueries.ts","/@dropins/storefront-company-management/src/api/getCompany/getCompany.ts","/@dropins/storefront-company-management/src/api/updateCompany/updateCompany.ts"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\nexport const COMPANY_LEGAL_ADDRESS_FRAGMENT = /* GraphQL */ `\n  fragment COMPANY_LEGAL_ADDRESS_FRAGMENT on CompanyLegalAddress {\n    street\n    city\n    region {\n      region\n      region_code\n      region_id\n    }\n    country_code\n    postcode\n    telephone\n  }\n`;\n\nexport const COMPANY_BASIC_INFO_FRAGMENT = /* GraphQL */ `\n  fragment COMPANY_BASIC_INFO_FRAGMENT on Company {\n    id\n    name\n    email\n    legal_name\n    vat_tax_id\n    reseller_id\n  }\n`;\n\nexport const COMPANY_SALES_REPRESENTATIVE_FRAGMENT = /* GraphQL */ `\n  fragment COMPANY_SALES_REPRESENTATIVE_FRAGMENT on CompanySalesRepresentative {\n    firstname\n    lastname\n    email\n  }\n`;\n\nexport const COMPANY_ADMIN_FRAGMENT = /* GraphQL */ `\n  fragment COMPANY_ADMIN_FRAGMENT on Customer {\n    id\n    firstname\n    lastname\n    email\n    job_title\n  }\n`;\n\nexport const COMPANY_FULL_FRAGMENT = /* GraphQL */ `\n  fragment COMPANY_FULL_FRAGMENT on Company {\n    ...COMPANY_BASIC_INFO_FRAGMENT\n    legal_address {\n      ...COMPANY_LEGAL_ADDRESS_FRAGMENT\n    }\n    company_admin {\n      ...COMPANY_ADMIN_FRAGMENT\n    }\n    sales_representative {\n      ...COMPANY_SALES_REPRESENTATIVE_FRAGMENT\n    }\n    available_payment_methods {\n      code\n      title\n    }\n    available_shipping_methods {\n      code\n      title\n    }\n  }\n  ${COMPANY_BASIC_INFO_FRAGMENT}\n  ${COMPANY_LEGAL_ADDRESS_FRAGMENT}\n  ${COMPANY_ADMIN_FRAGMENT}\n  ${COMPANY_SALES_REPRESENTATIVE_FRAGMENT}\n`;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\nimport {\n  COMPANY_BASIC_INFO_FRAGMENT,\n  COMPANY_LEGAL_ADDRESS_FRAGMENT,\n  COMPANY_ADMIN_FRAGMENT,\n  COMPANY_SALES_REPRESENTATIVE_FRAGMENT,\n} from './CompanyFragment.graphql';\n\n/**\n * Builds company fields based on user permissions\n */\nconst buildCompanyFields = (allowed: Set<string>): { fields: string[]; usedFragments: string[] } => {\n  const wantProfile = allowed.has('Magento_Company::view_account');\n  const wantAddress = allowed.has('Magento_Company::view_address');\n  const wantContacts = allowed.has('Magento_Company::contacts');\n  const wantPayment = allowed.has('Magento_Company::payment_information');\n  const wantShipping = allowed.has('Magento_Company::shipping_information');\n\n  const fields: string[] = [];\n  const usedFragments: string[] = [];\n\n  if (wantProfile) {\n    fields.push('...COMPANY_BASIC_INFO_FRAGMENT');\n    usedFragments.push(COMPANY_BASIC_INFO_FRAGMENT);\n  }\n  if (wantAddress) {\n    fields.push(`legal_address { ...COMPANY_LEGAL_ADDRESS_FRAGMENT }`);\n    usedFragments.push(COMPANY_LEGAL_ADDRESS_FRAGMENT);\n  }\n  if (wantContacts) {\n    fields.push(`company_admin { ...COMPANY_ADMIN_FRAGMENT }`);\n    fields.push(`sales_representative { ...COMPANY_SALES_REPRESENTATIVE_FRAGMENT }`);\n    usedFragments.push(COMPANY_ADMIN_FRAGMENT);\n    usedFragments.push(COMPANY_SALES_REPRESENTATIVE_FRAGMENT);\n  }\n  if (wantPayment) {\n    fields.push(`available_payment_methods { code title }`);\n  }\n  if (wantShipping) {\n    fields.push(`available_shipping_methods { code title }`);\n  }\n\n  return { fields, usedFragments };\n};\n\n/**\n * Builds a dynamic company query based on user permissions\n */\nexport const buildCompanyQuery = (allowed: Set<string>): string => {\n  const { fields, usedFragments } = buildCompanyFields(allowed);\n\n  // If no allowed company fields, still query company with __typename to keep response shape\n  if (fields.length === 0) {\n    return `\n      query GET_COMPANY_DYNAMIC {\n        company { __typename }\n      }\n    `;\n  }\n\n  const query = `\n    query GET_COMPANY_DYNAMIC {\n      company {\n        ${fields.join('\\n        ')}\n      }\n    }\n  `;\n\n  return `${query}\\n${usedFragments.join('\\n')}`;\n};\n\n/**\n * Builds a dynamic company update mutation based on user permissions\n */\nexport const buildUpdateCompanyMutation = (allowed: Set<string>): string => {\n  const { fields, usedFragments } = buildCompanyFields(allowed);\n\n  // If no allowed company fields, still query company with __typename to keep response shape\n  if (fields.length === 0) {\n    return `\n      mutation UPDATE_COMPANY_DYNAMIC($input: CompanyUpdateInput!) {\n        updateCompany(input: $input) {\n          company { __typename }\n        }\n      }\n    `;\n  }\n\n  const mutation = `\n    mutation UPDATE_COMPANY_DYNAMIC($input: CompanyUpdateInput!) {\n      updateCompany(input: $input) {\n        company {\n          ${fields.join('\\n          ')}\n        }\n      }\n    }\n  `;\n\n  return `${mutation}\\n${usedFragments.join('\\n')}`;\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\nimport { fetchGraphQl } from '../fetch-graphql';\nimport { fetchUserPermissions } from '../fetchUserPermissions/fetchUserPermissions';\nimport { buildCompanyQuery } from '../graphql/buildCompanyQueries';\nimport { handleNetworkError } from '../../lib/network-error';\nimport { handleFetchError } from '../../lib/fetch-error';\nimport { CompanyModel } from '../../data/models';\nimport { transformCompany } from '../../data/transforms';\nimport { getCompanyResponse } from '../../types/api/getCompany.types';\n\n/**\n * Retrieves company information with permissions-aware field selection\n * Only returns fields that the current user has permission to view\n * \n * @returns Promise resolving to CompanyModel or null if no company data available\n * @throws {Error} When network errors or GraphQL errors occur\n */\nexport async function getCompany(): Promise<CompanyModel | null> {\n  return await fetchUserPermissions()\n    .then(async ({ allowedIds, roleResponse }) => {\n      // Build a company query that requests only allowed fields\n      const GET_COMPANY_DYNAMIC = buildCompanyQuery(allowedIds);\n\n      // Fetch company with dynamic selection\n      const companyResponse: getCompanyResponse = await fetchGraphQl(GET_COMPANY_DYNAMIC, { method: 'GET', cache: 'no-cache' });\n      if (companyResponse.errors?.length) return handleFetchError(companyResponse.errors);\n\n      const companyNode = companyResponse?.data?.company;\n      const hasAnyCompanyField = companyNode && Object.keys(companyNode).some((k) => k !== '__typename');\n      if (!hasAnyCompanyField) {\n        return null;\n      }\n\n      // Merge back minimal customer role info so transform can compute flags\n      if (companyResponse?.data && roleResponse?.data?.customer) {\n        companyResponse.data.customer = roleResponse.data.customer;\n      }\n\n      return transformCompany(companyResponse);\n    })\n    .catch(handleNetworkError);\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\nimport { handleNetworkError } from '../../lib/network-error';\nimport { fetchGraphQl } from '../fetch-graphql';\nimport { handleFetchError } from '../../lib/fetch-error';\nimport { transformCompany } from '../../data/transforms';\nimport { CompanyModel } from '../../data/models/company';\nimport { updateCompanyResponse, UpdateCompanyDto } from '../../types';\nimport { fetchUserPermissions } from '../fetchUserPermissions/fetchUserPermissions';\nimport { buildUpdateCompanyMutation } from '../graphql/buildCompanyQueries';\n\n/**\n * Updates company profile information with permission-aware field filtering.\n * \n * This function dynamically builds the GraphQL mutation based on user permissions:\n * - Only requests fields the user can view in the response\n * - Only sends fields the user can edit in the mutation\n * \n * **Permissions Required:**\n * - `Magento_Company::edit_account` - To update name, email, legal name, VAT/Tax ID, Reseller ID\n * - `Magento_Company::edit_address` - To update legal address fields\n * \n * **Important:** The dropin UI gates which fields are editable. If neither permission\n * is granted, the submit button is disabled and this function should not be called.\n * \n * @param input - Partial company data to update (only changed fields)\n * @returns Promise resolving to complete updated company object with all current data\n * @throws Error if network request fails or GraphQL returns errors\n * \n * @fires company/updated - Emitted after successful update with new company data\n * \n * @example\n * ```typescript\n * const updated = await updateCompany({\n *   name: 'New Company Name',\n *   legalAddress: {\n *     street: ['456 New St'],\n *     city: 'Los Angeles',\n *     region: { region: 'California', regionCode: 'CA' },\n *     countryCode: 'US',\n *     postcode: '90001'\n *   }\n * });\n * // Event 'company/updated' is emitted with { company: updated }\n * ```\n */\nexport const updateCompany = async (input: UpdateCompanyDto): Promise<CompanyModel> => {\n  return await fetchUserPermissions()\n    .then(async ({ allowedIds, roleResponse }) => {\n      // Build a dynamic mutation that requests only allowed fields in response\n      const UPDATE_COMPANY_DYNAMIC = buildUpdateCompanyMutation(allowedIds);\n\n      // Transform input (keep original logic for what to send)\n      const transformedInput: Record<string, unknown> = {};\n      \n      // Map frontend field names to GraphQL schema field names\n      if (input.name !== undefined) {\n        transformedInput.company_name = input.name;\n      }\n      if (input.email !== undefined) {\n        transformedInput.company_email = input.email;\n      }\n      if (input.legalName !== undefined) {\n        transformedInput.legal_name = input.legalName;\n      }\n      if (input.vatTaxId !== undefined) {\n        transformedInput.vat_tax_id = input.vatTaxId;\n      }\n      if (input.resellerId !== undefined) {\n        transformedInput.reseller_id = input.resellerId;\n      }\n      \n      // Transform legal address (only if user has edit_address permission)\n      if (input.legalAddress !== undefined && allowedIds.has('Magento_Company::edit_address')) {\n        // Handle street field - ensure it's always a flat array of strings\n        let streetArray: string[];\n        if (Array.isArray(input.legalAddress.street)) {\n          // If street is already an array, use it directly and add street_2 if present\n          streetArray = [...input.legalAddress.street];\n          if (input.legalAddress.street2) {\n            streetArray.push(input.legalAddress.street2);\n          }\n        } else {\n          // If street is a string, create array normally with type guard\n          streetArray = [input.legalAddress.street, input.legalAddress.street2].filter(\n            (s): s is string => typeof s === 'string' && s.trim().length > 0\n          );\n        }\n        \n        // Remove any empty strings and ensure all elements are strings\n        streetArray = streetArray.filter(street => street && typeof street === 'string' && street.trim().length > 0);\n        \n        // Handle region - different approaches for dropdown vs custom regions\n        let regionValue: { region: string; region_code: string; region_id?: number } | undefined;\n        if (input.legalAddress.region && typeof input.legalAddress.region === 'object') {\n          const regionObj = input.legalAddress.region;\n          \n          // Check if this is a custom region (region === regionCode) or predefined region\n          if (regionObj.region === regionObj.regionCode) {\n            // Custom region - send as object with region_id: 0\n            regionValue = {\n              region: regionObj.region,\n              region_code: regionObj.regionCode,\n              region_id: 0\n            };\n          } else {\n            // Predefined region - send as object\n            regionValue = {\n              region: regionObj.region,\n              region_code: regionObj.regionCode,\n            };\n          }\n        } else if (input.legalAddress.regionCode && input.legalAddress.region !== input.legalAddress.regionCode) {\n          // If we have different region and regionCode (dropdown case)\n          regionValue = {\n            region: input.legalAddress.region || input.legalAddress.regionCode,\n            region_code: input.legalAddress.regionCode,\n          };\n        } else if (input.legalAddress.region) {\n          // If we only have region string (fallback case)\n          regionValue = {\n            region: input.legalAddress.region,\n            region_code: input.legalAddress.region,\n            region_id: 0\n          };\n        }\n        \n        transformedInput.legal_address = {\n          street: streetArray,\n          city: input.legalAddress.city,\n          region: regionValue,\n          country_id: input.legalAddress.countryCode, // GraphQL expects country_id, not countryCode\n          postcode: input.legalAddress.postcode,\n          telephone: input.legalAddress.telephone,\n        };\n      }\n\n      // Execute the dynamic mutation\n      const response: updateCompanyResponse = await fetchGraphQl(UPDATE_COMPANY_DYNAMIC, {\n        method: 'POST',\n        variables: { input: transformedInput },\n      });\n\n      if (response.errors?.length) return handleFetchError(response.errors);\n\n      // Merge back minimal customer role info so transform can compute flags\n      (response as any).data.customer = roleResponse?.data?.customer;\n\n      return transformCompany(response);\n    })\n    .catch(handleNetworkError);\n};\n"],"names":["COMPANY_LEGAL_ADDRESS_FRAGMENT","COMPANY_BASIC_INFO_FRAGMENT","COMPANY_SALES_REPRESENTATIVE_FRAGMENT","COMPANY_ADMIN_FRAGMENT","buildCompanyFields","allowed","wantProfile","wantAddress","wantContacts","wantPayment","wantShipping","fields","usedFragments","buildCompanyQuery","buildUpdateCompanyMutation","getCompany","fetchUserPermissions","allowedIds","roleResponse","GET_COMPANY_DYNAMIC","companyResponse","fetchGraphQl","_a","handleFetchError","companyNode","_b","k","_c","transformCompany","handleNetworkError","updateCompany","input","UPDATE_COMPANY_DYNAMIC","transformedInput","streetArray","s","street","regionValue","regionObj","response"],"mappings":"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"}