{"version":3,"file":"RolesAndPermissions.js","sources":["/@dropins/storefront-company-management/src/components/RoleAndPermissionTable/RoleAndPermissionTable.tsx","/@dropins/storefront-company-management/src/components/EditRoleAndPermission/EditRoleAndPermission.tsx","/@dropins/storefront-company-management/src/components/DeleteRoleModal/DeleteRoleModal.tsx","/@dropins/storefront-company-management/src/containers/RolesAndPermissions/RolesAndPermissions.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { FunctionComponent } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\nimport { useMemo, useCallback } from 'preact/hooks';\nimport { Button, Picker, Pagination, ProgressSpinner, ActionButton } from '@adobe-commerce/elsie/components';\nimport { Table } from '@adobe-commerce/elsie/components/Table/Table';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { CompanyRoleModel } from '../../data/models/company-role';\nimport { DEFAULT_PAGINATION_SIZE } from '../../hooks/useCompanyRoles';\nimport { classes } from '@adobe-commerce/elsie/lib';\nimport './RoleAndPermissionTable.css';\n\n/**\n * Decode base64 encoded role ID to get the actual numeric ID\n */\nconst decodeRoleId = (encodedId: string): string => {\n  try {\n    // Handle the case where ID is already numeric\n    if (/^\\d+$/.test(encodedId)) {\n      return encodedId;\n    }\n    \n    const decoded = atob(encodedId);\n    \n    const match = decoded.match(/(\\d+)$/);\n\n    return match ? match[1] : encodedId;\n  } catch (error) {\n    console.warn('Failed to decode role ID:', encodedId, error);\n    return encodedId;\n  }\n};\n\nexport interface RoleAndPermissionTableProps extends HTMLAttributes<HTMLDivElement> {\n  roles: CompanyRoleModel[];\n  isLoading: boolean;\n  canManageRoles?: boolean;\n  onShowCreateForm: () => void;\n  onShowEditForm: (roleId: string) => void;\n  onDuplicateRole?: (roleId: string) => void;\n  onDeleteRole?: (roleId: string) => void;\n  totalCount?: number;\n  currentPage?: number;\n  pageSize?: number;\n  onPageChange?: (page: number) => void;\n  onPageSizeChange?: (pageSize: number) => void;\n  onSortChange?: (columnKey: string, direction: 'asc' | 'desc') => void;\n  sortColumn?: string;\n  sortDirection?: 'asc' | 'desc';\n}\n\nexport const RoleAndPermissionTable: FunctionComponent<RoleAndPermissionTableProps> = ({\n  className,\n  roles,\n  isLoading,\n  canManageRoles = false,\n  onShowCreateForm,\n  onShowEditForm,\n  onDuplicateRole,\n  onDeleteRole,\n  totalCount = roles.length,\n  currentPage = 1,\n  pageSize = DEFAULT_PAGINATION_SIZE,\n  onPageChange,\n  onPageSizeChange,\n  onSortChange,\n  sortColumn,\n  sortDirection,\n  children,\n  ...props\n}) => {\n  const translations = useText({\n    addNewRole: 'Company.RoleAndPermissionTable.addNewRole',\n    columnId: 'Company.RoleAndPermissionTable.columnId',\n    columnRole: 'Company.RoleAndPermissionTable.columnRole',\n    columnUsers: 'Company.RoleAndPermissionTable.columnUsers',\n    columnActions: 'Company.RoleAndPermissionTable.columnActions',\n    editButton: 'Company.RoleAndPermissionTable.editButton',\n    duplicateButton: 'Company.RoleAndPermissionTable.duplicateButton',\n    deleteButton: 'Company.RoleAndPermissionTable.deleteButton',\n    viewOnlyLabel: 'Company.RoleAndPermissionTable.viewOnlyLabel',\n    systemRoleLabel: 'Company.RoleAndPermissionTable.systemRoleLabel',\n    itemCount: 'Company.RoleAndPermissionTable.itemCount',\n    itemsRange: 'Company.RoleAndPermissionTable.itemsRange',\n    show: 'Company.RoleAndPermissionTable.show',\n    perPage: 'Company.RoleAndPermissionTable.perPage',\n    pageSizeLabel: 'Company.RoleAndPermissionTable.pageSizeLabel',\n  });\n\n  // Define table columns with sorting\n  // Only add sortBy if all required sorting values are present\n  // Note: Elsie's Table component has a bug in test environments where sortBy causes\n  // \"Cannot read properties of undefined (reading 'replace')\" errors, so we disable it in tests\n  const isTestEnv = typeof process !== 'undefined' && (process.env.NODE_ENV === 'test' || process.env.JEST_WORKER_ID !== undefined);\n  const enableSorting = !!(onSortChange && sortDirection && sortColumn) && !isTestEnv;\n  \n  const columns = useMemo(() => [\n    { \n      key: 'id', \n      label: translations.columnId || 'ID',\n      ...(enableSorting && { sortBy: (sortColumn === 'id' ? sortDirection : true) as 'asc' | 'desc' | true })\n    },\n    { \n      key: 'name', \n      label: translations.columnRole || 'Role',\n      ...(enableSorting && { sortBy: (sortColumn === 'name' ? sortDirection : true) as 'asc' | 'desc' | true })\n    },\n    { \n      key: 'usersCount', \n      label: translations.columnUsers || 'Users',\n      ...(enableSorting && { sortBy: (sortColumn === 'usersCount' ? sortDirection : true) as 'asc' | 'desc' | true })\n    },\n    { key: 'actions', label: translations.columnActions || 'Actions' },\n  ], [translations, sortColumn, sortDirection, enableSorting]);\n\n  const canEditRole = useCallback((role: CompanyRoleModel) => {\n    return canManageRoles && role.id !== '0';\n  }, [canManageRoles]);\n\n  const canDuplicateRole = useCallback((role: CompanyRoleModel) => {\n    return canManageRoles && role.id !== '0';\n  }, [canManageRoles]);\n\n  const canDeleteRole = useCallback((role: CompanyRoleModel) => {\n    return canManageRoles && role.id !== '0' && totalCount > 1;\n  }, [canManageRoles, totalCount]);\n\n  const buildActionButtons = useCallback((role: CompanyRoleModel) => {\n    const actions = [];\n\n    // Edit button\n    if (canEditRole(role)) {\n      actions.push(\n        <ActionButton\n          key=\"edit\"\n          onClick={() => onShowEditForm(role.id)}\n          className=\"role-action-button\"\n        >\n          {translations.editButton || 'Edit'}\n        </ActionButton>\n      );\n    }\n\n    // Duplicate button\n    if (canDuplicateRole(role) && onDuplicateRole) {\n      actions.push(\n        <ActionButton\n          key=\"duplicate\"\n          onClick={() => onDuplicateRole(role.id)}\n          className=\"role-action-button\"\n        >\n          {translations.duplicateButton || 'Duplicate'}\n        </ActionButton>\n      );\n    }\n\n    // Delete button\n    if (canDeleteRole(role) && onDeleteRole) {\n      actions.push(\n        <ActionButton\n          key=\"delete\"\n          onClick={() => onDeleteRole(role.id)}\n          className=\"role-action-button\"\n        >\n          {translations.deleteButton || 'Delete'}\n        </ActionButton>\n      );\n    }\n\n    if (actions.length === 0) {\n      if (!canManageRoles) {\n        return null;\n      }\n      return <span className=\"no-actions\">{translations.systemRoleLabel || 'System Role'}</span>;\n    }\n\n    return (\n      <div className=\"role-actions-container\">\n        {actions.map((action, index) => (\n          <span key={index} className=\"role-action-wrapper\">\n            {action}\n          </span>\n        ))}\n      </div>\n    );\n  }, [canEditRole, canDuplicateRole, canDeleteRole, onShowEditForm, onDuplicateRole, onDeleteRole, translations, canManageRoles]);\n\n  const rowData = useMemo(() => roles.map((role) => ({\n    id: decodeRoleId(role.id),\n    name: role.name,\n    usersCount: role.usersCount,\n    actions: (\n      <div className=\"roles-actions\">\n        {buildActionButtons(role)}\n      </div>\n    ),\n  })), [roles, buildActionButtons]);\n\n  // Page size options for Picker\n  const pageSizeOptions = [DEFAULT_PAGINATION_SIZE, 20, 50, 100].map(size => ({\n    value: size.toString(),\n    label: size.toString(),\n    text: size.toString()\n  }));\n\n  // Calculate pagination info\n  const totalPages = Math.ceil(totalCount / pageSize);\n  const startIndex = (currentPage - 1) * pageSize;\n  const endIndex = startIndex + pageSize;\n\n  return (\n    <div {...props} className={classes(['company-management-role-and-permission-table', className])} data-testid=\"role-and-permission-table\">\n      <div className=\"roles-table-container\">\n        <Table\n          columns={columns}\n          rowData={rowData}\n          mobileLayout=\"stacked\"\n          loading={isLoading}\n          skeletonRowCount={10}\n          onSortChange={(columnKey, direction) => {\n            let sortDir: 'asc' | 'desc';\n            \n            if (direction === true) {\n              // Clicking a column with sortBy: true (unsorted) or toggling\n              if (sortColumn === columnKey && sortDirection) {\n                // Toggle the current sort direction\n                sortDir = sortDirection === 'asc' ? 'desc' : 'asc';\n              } else {\n                // New column, start with ascending\n                sortDir = 'asc';\n              }\n            } else {\n              // Elsie provided a specific direction\n              sortDir = direction;\n            }\n            \n            onSortChange?.(columnKey, sortDir as 'asc' | 'desc');\n          }}\n        />\n      </div>\n      \n      {/* Table Footer with Count and Pagination */}\n      <div className=\"table-footer\">\n        <div className=\"table-footer-left\">\n          <span className=\"item-count\">\n            {(translations.itemsRange || 'Items {start}-{end} of {total}')\n              .replace('{start}', String(startIndex + 1))\n              .replace('{end}', String(Math.min(endIndex, totalCount)))\n              .replace('{total}', String(totalCount))}\n          </span>\n        </div>\n        \n        {/* Centered Page Navigation */}\n        {totalPages > 1 && (\n          <div className=\"table-footer-center\">\n            <Pagination\n              currentPage={currentPage}\n              totalPages={totalPages}\n              onChange={(page) => onPageChange?.(page)}\n            />\n          </div>\n        )}\n        \n        <div className=\"table-footer-right\">\n          <div className=\"pagination-controls\">\n            <span className=\"pagination-label\">\n              {translations.show || 'Show'}\n            </span>\n            {isLoading ? (\n              <div className=\"page-size-loading\">\n                <ProgressSpinner size=\"small\" />\n              </div>\n            ) : (\n              <Picker\n                value={pageSize.toString()}\n                onChange={(event) => {\n                  const target = event.target as HTMLSelectElement;\n                  onPageSizeChange?.(parseInt(target.value, 10));\n                }}\n                options={pageSizeOptions}\n                className=\"page-size-picker\"\n                aria-label={translations.pageSizeLabel || 'Items per page'}\n              />\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Add Role Button - Only show if user can manage roles */}\n      {canManageRoles && (\n        <div className=\"add-role-section\">\n          <Button variant=\"primary\" onClick={onShowCreateForm}>\n            {translations.addNewRole || 'Add New Role'}\n          </Button>\n        </div>\n      )}\n      {children}\n    </div>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { FunctionComponent } from 'preact';\nimport { useState, useEffect, useCallback, useRef } from 'preact/hooks';\nimport {\n  Button,\n  Card,\n  Field,\n  Header,\n  InLineAlert,\n  Input,\n  ProgressSpinner,\n} from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { Tree, TreeItem } from '../Tree/Tree';\nimport { CompanyRoleModel, CompanyAclResourceModel } from '../../data/models/company-role';\nimport { flattenIdsToArray } from '../../lib/company-permissions';\nimport { \n  isCompanyRoleNameAvailable \n} from '../../api/companyRoles';\nimport './EditRoleAndPermission.css';\n\nconst ROLE_NAME_CONSTRAINTS = {\n  MAX_LENGTH: 40,\n  AUTO_TRUNCATE: true,\n  ALLOW_SPECIAL_CHARS: true,\n  CHECK_UNIQUENESS: true,\n} as const;\n\nconst getRoleNameForSave = (raw: string): string => {\n  const stringValue = typeof raw === 'string' ? raw : String(raw || '');\n  const trimmed = stringValue.trim();\n  return trimmed.slice(0, ROLE_NAME_CONSTRAINTS.MAX_LENGTH);\n};\n\nexport interface EditRoleAndPermissionProps {\n  mode: 'create' | 'edit';\n  role?: CompanyRoleModel;\n  aclResources: CompanyAclResourceModel[];\n  existingRoleNames?: string[];\n  loading?: boolean;\n  onSubmit: (data: { name: string; permissions: string[] }) => void;\n  onCancel: () => void;\n  inLineAlertProps?: {\n    type: 'success' | 'error' | 'warning';\n    text: string;\n    icon?: string;\n  };\n  prefillName?: string;\n  prefillPermissions?: CompanyAclResourceModel[] | any[];\n}\n\nexport const EditRoleAndPermission: FunctionComponent<EditRoleAndPermissionProps> = ({\n  mode,\n  role,\n  aclResources,\n  existingRoleNames = [],\n  loading = false,\n  onSubmit,\n  onCancel,\n  inLineAlertProps,\n  prefillName,\n  prefillPermissions,\n}) => {\n  const translations = useText({\n    createTitle: 'Company.EditRoleAndPermission.createTitle',\n    editTitle: 'Company.EditRoleAndPermission.editTitle',\n    roleInformation: 'Company.EditRoleAndPermission.roleInformation',\n    roleName: 'Company.EditRoleAndPermission.roleName',\n    rolePermissions: 'Company.EditRoleAndPermission.rolePermissions',\n    permissionsDescription: 'Company.EditRoleAndPermission.permissionsDescription',\n    expandAll: 'Company.EditRoleAndPermission.expandAll',\n    collapseAll: 'Company.EditRoleAndPermission.collapseAll',\n    cancel: 'Company.shared.buttons.cancel',\n    saveRole: 'Company.EditRoleAndPermission.saveRole',\n    saving: 'Company.shared.buttons.saving',\n    roleNameRequired: 'Company.shared.validation.roleNameRequired',\n    roleNameExists: 'Company.shared.validation.roleNameExists',\n  });\n\n  const [formData, setFormData] = useState({\n    name: role?.name || '',\n  });\n\n  const [errors, setErrors] = useState<Record<string, string>>({});\n  const [touched, setTouched] = useState<Record<string, boolean>>({});\n  const [isValidatingName, setIsValidatingName] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [treeItems, setTreeItems] = useState<TreeItem[]>([]);\n  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set());\n  const [selectedPermissions, setSelectedPermissions] = useState<Set<string>>(new Set());\n  const validationTimeoutRef = useRef<number | null>(null);\n  const lastValidatedNameRef = useRef<string>('');\n  const isInitializedRef = useRef(false);\n\n  useEffect(() => {\n    // Only initialize form data once on mount, not on every prop change\n    // This preserves user input when company switches and props update\n    if (isInitializedRef.current) {\n      return;\n    }\n    \n    isInitializedRef.current = true;\n    \n    if (mode === 'edit' && role) {\n      setFormData({ name: role.name });\n      if (role.permissions && role.permissions.length > 0) {\n        const permissionIds = flattenIdsToArray(role.permissions);\n        setSelectedPermissions(new Set(permissionIds));\n      }\n    } else if (mode === 'create') {\n      const nameToUse = prefillName ?? '';\n      setFormData({ name: nameToUse });\n\n      if (prefillPermissions && prefillPermissions.length > 0) {\n        const permissionIds = flattenIdsToArray(prefillPermissions as any);\n        setSelectedPermissions(new Set(permissionIds));\n      } else {\n        setSelectedPermissions(new Set());\n      }\n    }\n  }, [mode, role, prefillName, prefillPermissions]);\n\n  // Transform ACL resources to tree items\n  useEffect(() => {\n    if (aclResources.length > 0) {\n      const items = transformAclResourcesToTreeItems(aclResources);\n      setTreeItems(items);\n      \n      const rootIds = items\n        .filter(item => !item.parentId)\n        .map(item => item.id);\n      \n      setExpandedIds(new Set(rootIds));\n      \n    }\n  }, [aclResources]);\n\n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (validationTimeoutRef.current) {\n        clearTimeout(validationTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const validateRoleName = useCallback((name: string): string | null => {\n    const trimmedNameForSave = getRoleNameForSave(name);\n    if (!trimmedNameForSave) {\n      return translations.roleNameRequired || 'This is a required field.';\n    }\n    \n    // Check uniqueness (exclude current role name in edit mode)\n    const rolesToCheck = mode === 'edit' && role \n      ? existingRoleNames.filter(existingName => existingName !== role.name)\n      : existingRoleNames;\n      \n    if (rolesToCheck.includes(trimmedNameForSave)) {\n      return translations.roleNameExists;\n    }\n    \n    return null;\n  }, [mode, role, existingRoleNames, translations.roleNameRequired, translations.roleNameExists]);\n\n  const validateRoleNameAsync = useCallback(async (name: string): Promise<string | null> => {\n    const trimmedNameForSave = getRoleNameForSave(name);\n    \n    const basicError = validateRoleName(trimmedNameForSave);\n    if (basicError) {\n      return basicError;\n    }\n    \n    if (mode === 'edit' && role && trimmedNameForSave === role.name) {\n      return null;\n    }\n    \n    try {\n      setIsValidatingName(true);\n      \n      const isAvailable = await isCompanyRoleNameAvailable({ name: trimmedNameForSave });\n      \n      if (!isAvailable) {\n        return translations.roleNameExists;\n      }\n      \n      return null;\n    } catch (error) {\n      console.error('Role name validation failed:', error);\n      // Allow submission and rely on backend validation\n      return null;\n    } finally {\n      setIsValidatingName(false);\n    }\n  }, [mode, role, translations.roleNameExists, validateRoleName]);\n\n  const debouncedValidateRoleName = useCallback((name: string) => {\n    if (validationTimeoutRef.current !== null) {\n      clearTimeout(validationTimeoutRef.current);\n    }\n\n    if (name === lastValidatedNameRef.current) {\n      return;\n    }\n\n    validationTimeoutRef.current = window.setTimeout(async () => {\n      const error = await validateRoleNameAsync(name);\n      if (error) {\n        setErrors(prev => ({ ...prev, name: error }));\n      } else {\n        setErrors(prev => ({ ...prev, name: '' }));\n      }\n      lastValidatedNameRef.current = name;\n    }, 500);\n  }, [validateRoleNameAsync]);\n\n  const validateForm = (): boolean => {\n    const newErrors: Record<string, string> = {};\n    let isValid = true;\n\n    const nameError = validateRoleName(formData.name);\n    if (nameError) {\n      newErrors.name = nameError;\n      isValid = false;\n    }\n\n    setErrors(newErrors);\n    return isValid;\n  };\n\n  const handleRoleNameChange = (value: string | Event) => {\n    const stringValue = typeof value === 'string' ? value : (value.target as HTMLInputElement).value;\n    setFormData(prev => ({ ...prev, name: stringValue }));\n    \n    if (errors.name) {\n      setErrors(prev => ({ ...prev, name: '' }));\n    }\n    \n    // Trigger debounced validation for real-time feedback\n    debouncedValidateRoleName(stringValue);\n  };\n\n  const handleRoleNameBlur = () => {\n    setTouched(prev => ({ ...prev, name: true }));\n    \n    // Cancel any pending debounced validation\n    if (validationTimeoutRef.current) {\n      clearTimeout(validationTimeoutRef.current);\n      validationTimeoutRef.current = null;\n    }\n  };\n\n  const handleExpandAll = () => {\n    const allIds = new Set(treeItems.map(item => item.id));\n    setExpandedIds(allIds);\n  };\n\n  const handleCollapseAll = () => {\n    setExpandedIds(new Set());\n  };\n\n  const handleSubmit = async (event: Event) => {\n    event.preventDefault();\n    \n    // Early return if already submitting\n    if (isSubmitting) {\n      return;\n    }\n    \n    setTouched({ name: true });\n    \n    // Do synchronous validation first\n    if (!validateForm()) {\n      return;\n    }\n    \n    // If there's already an error from previous validation, don't submit\n    if (errors.name) {\n      return;\n    }\n    \n    setIsSubmitting(true);\n    \n    try {\n      const roleData = {\n        name: getRoleNameForSave(formData.name),\n        permissions: Array.from(selectedPermissions),\n      };\n\n      if (onSubmit) {\n        await onSubmit(roleData);\n      }\n    } catch (error) {\n      console.error('Form submission failed:', error);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const title = mode === 'create' ? translations.createTitle : translations.editTitle;\n\n  return (\n    <Card variant=\"secondary\" className=\"edit-role-and-permission\">\n      <Header\n        level={2}\n        size=\"large\"\n        title={title}\n        divider={false}\n        className=\"edit-role-and-permission__title\"\n      />\n      \n      {inLineAlertProps?.text && (\n        <InLineAlert\n          className=\"edit-role-and-permission__notification\"\n          type={inLineAlertProps.type}\n          variant=\"secondary\"\n          heading={inLineAlertProps.text}\n          data-testid=\"editRoleInLineAlert\"\n        />\n      )}\n\n      <form className=\"edit-role-and-permission-form\" onSubmit={handleSubmit}>\n        <div className=\"edit-role-and-permission__section\">\n          <Header\n            level={3}\n            size=\"medium\"\n            title={translations.roleInformation || 'Role Information'}\n            divider={false}\n            className=\"edit-role-and-permission__section-title\"\n          />\n          \n            <Field\n              label={translations.roleName || 'Role Name'}\n              required\n              error={touched.name && errors.name ? errors.name : undefined}\n            >\n              <Input\n                type=\"text\"\n                name=\"roleName\"\n                value={formData.name}\n                onChange={handleRoleNameChange}\n                onBlur={handleRoleNameBlur}\n                disabled={loading || isSubmitting}\n                data-testid=\"roleNameInput\"\n                placeholder={translations.roleName || 'Role Name'}\n                variant=\"primary\"\n                size=\"medium\"\n                maxLength={40}\n              />\n            </Field>\n            {isValidatingName && (\n              <div className=\"edit-role-and-permission__validation-spinner\">\n                <ProgressSpinner size=\"medium\" />\n              </div>\n            )}\n        </div>\n\n        <div className=\"edit-role-and-permission__section\">\n          <Header\n            level={3}\n            size=\"medium\"\n            title={translations.rolePermissions}\n            divider={false}\n            className=\"edit-role-and-permission__section-title\"\n          />\n          \n          <InLineAlert\n            type=\"info\"\n            variant=\"secondary\"\n            heading={translations.permissionsDescription}\n            className=\"edit-role-and-permission__permissions-description\"\n          />\n\n          <div className=\"edit-role-and-permission__tree-controls\">\n            <Button\n              type=\"button\"\n              variant=\"tertiary\"\n              onClick={handleExpandAll}\n              disabled={loading || isSubmitting}\n            >\n              {translations.expandAll}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"tertiary\"\n              onClick={handleCollapseAll}\n              disabled={loading || isSubmitting}\n            >\n              {translations.collapseAll}\n            </Button>\n          </div>\n\n          <div \n            className=\"edit-role-and-permission__tree-container\"\n            role=\"group\"\n            aria-label={translations.rolePermissions}\n          >\n                {treeItems.length > 0 ? (\n            <Tree\n              items={treeItems}\n              expandedIds={expandedIds}\n              onExpandedChange={setExpandedIds}\n              checkedIds={selectedPermissions}\n              onCheckedChange={setSelectedPermissions}\n              preserveOrder={true}\n              isCheckable={() => true}\n              biDirectionalChecking={true}\n                      renderNode={({ item, expanded, hasChildren, toggle, checkbox }) => (\n                        <div className=\"edit-role-and-permission__tree-node\">\n                          {hasChildren ? (\n                            <button\n                              type=\"button\"\n                              className=\"edit-role-and-permission__tree-expander\"\n                              onClick={(e) => {\n                                e.preventDefault();\n                                e.stopPropagation();\n                                toggle();\n                              }}\n                              aria-label={expanded ? `Collapse ${item.label}` : `Expand ${item.label}`}\n                            >\n                              {expanded ? 'âˆ’' : '+'}\n                            </button>\n                          ) : (\n                            <span className=\"edit-role-and-permission__tree-spacer\" />\n                          )}\n                          {checkbox && checkbox()}\n                          <span className=\"edit-role-and-permission__tree-label\">\n                            {item.label}\n                          </span>\n                        </div>\n                      )}\n                    />\n                ) : (\n              <div className=\"edit-role-and-permission__tree-loading\">\n                Loading permissions...\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div className=\"edit-role-and-permission__actions\">\n          <Button\n            type=\"button\"\n            variant=\"secondary\"\n            onClick={onCancel}\n            disabled={loading || isSubmitting}\n          >\n            {translations.cancel}\n          </Button>\n          <Button\n            type=\"submit\"\n            variant=\"primary\"\n            disabled={loading || isSubmitting}\n          >\n            {(loading || isSubmitting) ? translations.saving : translations.saveRole}\n          </Button>\n        </div>\n      </form>\n\n      {(loading || isSubmitting) && (\n        <div className=\"edit-role-and-permission__loading-overlay\">\n          <ProgressSpinner size=\"large\" />\n          <div className=\"edit-role-and-permission__loading-text\">\n            {translations.saving}\n          </div>\n        </div>\n      )}\n    </Card>\n  );\n};\n\nconst transformAclResourcesToTreeItems = (resources: CompanyAclResourceModel[]): TreeItem[] => {\n  const items: TreeItem[] = [];\n\n  const processResource = (resource: CompanyAclResourceModel, parentId?: string) => {\n    items.push({\n      id: resource.id,\n      parentId: parentId || null,\n      label: resource.text,\n    });\n\n    if (resource.children) {\n      // Sort children by sortOrder before processing to match Magento backend ordering\n      const sortedChildren = [...resource.children].sort((a, b) => a.sortOrder - b.sortOrder);\n      sortedChildren.forEach(child => {\n        processResource(child, resource.id);\n      });\n    }\n  };\n\n  // Sort root resources by sortOrder before processing to match Magento backend ordering\n  const sortedResources = [...resources].sort((a, b) => a.sortOrder - b.sortOrder);\n  sortedResources.forEach(resource => processResource(resource));\n  \n  return items;\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Modal, Button } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport './DeleteRoleModal.css';\n\nexport interface DeleteRoleModalProps {\n  isOpen: boolean;\n  hasUsers?: boolean;\n  onConfirm: () => void;\n  onCancel: () => void;\n}\n\nexport const DeleteRoleModal = ({\n  isOpen,\n  hasUsers = false,\n  onConfirm,\n  onCancel,\n}: DeleteRoleModalProps) => {\n  const translations = useText({\n    deleteModalTitle: 'Company.RolesAndPermissions.deleteModal.title',\n    deleteModalMessage: 'Company.RolesAndPermissions.deleteModal.message',\n    deleteModalConfirm: 'Company.RolesAndPermissions.deleteModal.confirm',\n    deleteModalCancel: 'Company.RolesAndPermissions.deleteModal.cancel',\n    cannotDeleteModalTitle: 'Company.RolesAndPermissions.cannotDeleteModal.title',\n    cannotDeleteModalMessage: 'Company.RolesAndPermissions.cannotDeleteModal.message',\n    cannotDeleteModalOk: 'Company.RolesAndPermissions.cannotDeleteModal.ok',\n  });\n\n  if (!isOpen) {\n    return null;\n  }\n\n  const message = hasUsers\n    ? (translations.cannotDeleteModalMessage || 'This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.')\n    : (translations.deleteModalMessage || 'This action cannot be undone. Are you sure you want to delete this role?');\n\n  return (\n    <Modal\n      open={true}\n      onClose={onCancel}\n      title={<>{hasUsers \n        ? (translations.cannotDeleteModalTitle || 'Cannot Delete Role')\n        : (translations.deleteModalTitle || 'Delete This Role?')\n      }</>}\n      size=\"small\"\n      className=\"delete-role-modal\"\n    >\n      <div className=\"delete-role-modal__content\">\n        <p>{message}</p>\n      </div>\n      <div className=\"delete-role-modal__actions\">\n        {hasUsers ? (\n          <Button\n            variant=\"primary\"\n            onClick={onConfirm}\n            className=\"delete-role-modal__ok-btn\"\n          >\n            {translations.cannotDeleteModalOk || 'OK'}\n          </Button>\n        ) : (\n          <>\n            <Button\n              variant=\"secondary\"\n              onClick={onCancel}\n              className=\"delete-role-modal__cancel-btn\"\n            >\n              {translations.deleteModalCancel || 'Cancel'}\n            </Button>\n            <Button\n              variant=\"primary\"\n              onClick={onConfirm}\n              className=\"delete-role-modal__confirm-btn\"\n            >\n              {translations.deleteModalConfirm || 'Delete'}\n            </Button>\n          </>\n        )}\n      </div>\n    </Modal>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useState, useEffect, useMemo } from 'preact/hooks';\nimport { classes, Container } from '@adobe-commerce/elsie/lib';\nimport { Header, Card, IllustratedMessage, InLineAlert } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { RoleAndPermissionTable } from '../../components/RoleAndPermissionTable';\nimport { EditRoleAndPermission } from '../../components/EditRoleAndPermission';\nimport { DeleteRoleModal } from '../../components/DeleteRoleModal';\nimport { useCompanyRoles, DEFAULT_PAGINATION_SIZE } from '../../hooks/useCompanyRoles';\nimport { useUserPermissions } from '../../hooks/useUserPermissions';\nimport { useInLineAlert } from '../../hooks/useInLineAlert';\nimport { useCompanyContextListener } from '../../hooks/useCompanyContextListener';\n\nexport interface RolesAndPermissionsProps {\n  /** Additional CSS classes to apply to the container for custom styling */\n  className?: string;\n  /**\n   * When true, displays the header section with title.\n   * Set to false when embedding within a layout that provides its own header.\n   * @default false\n   */\n  withHeader?: boolean;\n}\n    \nexport const RolesAndPermissions: Container<RolesAndPermissionsProps> = ({\n  className,\n  withHeader = false,\n}) => {\n  const translations = useText({\n    containerTitle: 'Company.RolesAndPermissions.containerTitle',\n    noAccessTitle: 'Company.RolesAndPermissions.noAccess.title',\n    noAccessMessage: 'Company.RolesAndPermissions.noAccess.message',\n    errorTitle: 'Company.RolesAndPermissions.error.title',\n    errorMessage: 'Company.RolesAndPermissions.error.message',\n    deleteRoleSuccess: 'Company.RoleAndPermissionTable.deleteRole.success',\n    createSuccess: 'Company.RolesAndPermissions.alerts.createSuccess',\n    createError: 'Company.RolesAndPermissions.alerts.createError',\n    createErrorPermissions: 'Company.RolesAndPermissions.alerts.createErrorPermissions',\n    updateSuccess: 'Company.RolesAndPermissions.alerts.updateSuccess',\n    updateError: 'Company.RolesAndPermissions.alerts.updateError',\n    updateErrorPermissions: 'Company.RolesAndPermissions.alerts.updateErrorPermissions',\n    deleteError: 'Company.RolesAndPermissions.alerts.deleteError',\n  });\n  \n  const { inLineAlertProps, handleSetInLineAlert } = useInLineAlert();\n  \n  const { permissions, loading: permissionsLoading, error: permissionsError } = useUserPermissions();\n  \n  // Calculate permissions before using in hooks\n  const canViewRoles = permissions?.canViewRoles ?? false;\n  const canManageRoles = permissions?.canManageRoles ?? false;\n  const hasAnyRoleAccess = canViewRoles || canManageRoles;\n  \n  const {\n    roles,\n    aclResources,\n    isLoading,\n    isCreating,\n    isUpdating,\n    error,\n    createRole,\n    updateRole,\n    deleteRole,\n    clearError,\n    refresh,\n  } = useCompanyRoles(DEFAULT_PAGINATION_SIZE, hasAnyRoleAccess, true); // Only auto-fetch if user has access\n\n  // Show/hide states for different views\n  const [showCreateForm, setShowCreateForm] = useState(false);\n  const [showEditForm, setShowEditForm] = useState(false);\n  const [editingRoleId, setEditingRoleId] = useState<string | null>(null);\n  \n  const [currentPage, setCurrentPage] = useState(1);\n  const [pageSize, setPageSize] = useState(DEFAULT_PAGINATION_SIZE);\n  const [sortColumn, setSortColumn] = useState<string>('id');\n  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc');\n\n  const [deleteTarget, setDeleteTarget] = useState<{ id: string; name: string; hasUsers: boolean } | null>(null);\n  \n  // Local state to pass prefill data into EditRoleAndPermission when creating\n  const [prefillRole, setPrefillRole] = useState<{ name: string; permissions: any[] } | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (error) {\n        clearError();\n      }\n      // Clear prefill data on unmount to prevent memory leaks\n      setPrefillRole(null);\n    };\n  }, [error, clearError]);\n\n  // Track when company changes to trigger refetch after permissions update\n  const [companyChangeTrigger, setCompanyChangeTrigger] = useState(0);\n\n  // Handle company context changes - close modals, reset state\n  useCompanyContextListener(() => {\n    // 1. Table view: Reset to page 1\n    setCurrentPage(1);\n    \n    // 2. Create/Duplicate form: Keep open temporarily while permissions load\n    //    Will be closed by useEffect below if new company lacks permission\n    \n    // 3. Edit form: Close and return to table view (role doesn't exist in new company)\n    if (showEditForm) {\n      setShowEditForm(false);\n      setEditingRoleId(null);\n    }\n    \n    // 4. Delete modal: Close immediately for safety\n    setDeleteTarget(null);\n    \n    clearError();\n\n    // 5. Trigger refetch (will happen in useEffect after permissions update)\n    setCompanyChangeTrigger(prev => prev + 1);\n  }, { eager: true });\n\n  // Close create form if user loses management permission after company switch\n  useEffect(() => {\n    if (showCreateForm && !permissionsLoading && !canManageRoles) {\n      setShowCreateForm(false);\n      setPrefillRole(null);\n    }\n  }, [showCreateForm, permissionsLoading, canManageRoles]);\n\n  // Refetch roles/ACL after permissions update when company changes\n  useEffect(() => {\n    // Skip initial mount\n    if (companyChangeTrigger === 0) {\n      return;\n    }\n\n    // Wait for permissions to finish loading before checking\n    if (permissionsLoading) {\n      return;\n    }\n\n    // Only refetch if user has access (permissions have been updated by now)\n    if (hasAnyRoleAccess) {\n      refresh();\n    }\n  }, [companyChangeTrigger, hasAnyRoleAccess, refresh, permissionsLoading]);\n\n  // Client-side sorting logic\n  const sortedRoles = useMemo(() => {\n    const sorted = [...roles];\n    sorted.sort((a, b) => {\n      let aValue: any;\n      let bValue: any;\n\n      if (sortColumn === 'id') {\n        // Decode IDs for proper numeric sorting\n        const decodeId = (id: string): number => {\n          try {\n            const decoded = atob(id);\n            const match = decoded.match(/role\\/(\\d+)/);\n            if (match) {\n              return parseInt(match[1], 10);\n            }\n            // If no pattern match, try parsing the decoded value directly\n            const num = parseInt(decoded, 10);\n            return isNaN(num) ? 0 : num;\n          } catch {\n            return 0;\n          }\n        };\n        aValue = decodeId(a.id);\n        bValue = decodeId(b.id);\n      } else if (sortColumn === 'name') {\n        aValue = a.name.toLowerCase();\n        bValue = b.name.toLowerCase();\n      } else if (sortColumn === 'usersCount') {\n        aValue = a.usersCount || 0;\n        bValue = b.usersCount || 0;\n      } else {\n        return 0;\n      }\n\n      if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;\n      if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;\n      return 0;\n    });\n    return sorted;\n  }, [roles, sortColumn, sortDirection]);\n\n  // Client-side pagination logic (calculate before conditional renders)\n  const totalCount = sortedRoles.length;\n  const startIndex = (currentPage - 1) * pageSize;\n  const endIndex = startIndex + pageSize;\n  const paginatedRoles = sortedRoles.slice(startIndex, endIndex);\n\n  // Render loading state - but NOT if a form is open (preserve form state during company switch)\n  if (permissionsLoading && !showCreateForm && !showEditForm) {\n    return (\n      <div className=\"roles-and-permissions-container\" data-testid=\"rolesAndPermissionsLoader\">\n        <div>Loading...</div>\n      </div>\n    );\n  }\n\n  // Render error state - but NOT if a form is open\n  if (permissionsError && !showCreateForm && !showEditForm) {\n    return (\n      <div className=\"roles-and-permissions-container\">\n        <Card variant=\"secondary\" className=\"roles-and-permissions-error\">\n          <div className=\"roles-and-permissions-error__wrapper\">\n            <div className=\"roles-and-permissions-error__content\">\n              <IllustratedMessage\n                heading={translations.errorTitle || 'Error Loading Permissions'}\n                message={<p>{translations.errorMessage || 'An error occurred while loading your permissions. Please try again.'}</p>}\n              />\n            </div>\n          </div>\n        </Card>\n      </div>\n    );\n  }\n\n  // Render no access state - but NOT if a form is open (let user finish/cancel first)\n  if (!hasAnyRoleAccess && !showCreateForm && !showEditForm) {\n    return (\n      <div className=\"roles-and-permissions-container\">\n        <Card variant=\"secondary\" className=\"roles-and-permissions-no-access\">\n          <div className=\"roles-and-permissions-no-access__wrapper\">\n            <div className=\"roles-and-permissions-no-access__content\">\n              <IllustratedMessage\n                heading={translations.noAccessTitle || 'Access Restricted'}\n                message={<p>{translations.noAccessMessage || 'You don\\'t have permission to view roles and permissions. Please contact your company administrator.'}</p>}\n              />\n            </div>\n          </div>\n        </Card>\n      </div>\n    );\n  }\n\n  const handlePageChange = (page: number) => {\n    setCurrentPage(page);\n  };\n\n  const handlePageSizeChange = (newPageSize: number) => {\n    setPageSize(newPageSize);\n    setCurrentPage(1); // Reset to first page when page size changes\n  };\n\n  const handleSortChange = (columnKey: string, direction: 'asc' | 'desc') => {\n    setSortColumn(columnKey);\n    setSortDirection(direction);\n    setCurrentPage(1); // Reset to first page when sorting changes\n  };\n\n  // Form show/hide handlers\n  const handleShowCreateForm = () => {\n    // Clear any prefill data when opening create form directly\n    setPrefillRole(null);\n    setShowCreateForm(true);\n  };\n\n  const handleHideCreateForm = () => {\n    // Clear prefill data when hiding create form\n    setPrefillRole(null);\n    setShowCreateForm(false);\n  };\n\n  const handleShowEditForm = (roleId: string) => {\n    setEditingRoleId(roleId);\n    setShowEditForm(true);\n  };\n\n  const handleHideEditForm = () => {\n    setShowEditForm(false);\n    setEditingRoleId(null);\n  };\n\n  const handleDuplicateRole = (roleId: string) => {\n    const source = roles.find(r => r.id === roleId);\n    if (!source) return;\n\n    setPrefillRole({\n      name: `${source.name} - Duplicated`,\n      permissions: source.permissions || [],\n    });\n    setShowCreateForm(true);\n  };\n\n  const handleCreateRole = async (roleData: { name: string; permissions: string[] }) => {\n    try {\n      const result = await createRole({\n        name: roleData.name,\n        permissions: roleData.permissions,\n      });\n      \n      if (result) {\n        const successMessage = translations.createSuccess \n          ? translations.createSuccess.replace('{roleName}', roleData.name)\n          : `Role \"${roleData.name}\" created successfully!`;\n        handleSetInLineAlert({\n          type: 'success',\n          text: successMessage,\n        });\n        handleHideCreateForm();\n      } else {\n        handleSetInLineAlert({\n          type: 'error',\n          text: translations.createError || 'Failed to create role. Please try again.',\n        });\n      }\n    } catch (error) {\n      handleSetInLineAlert({\n        type: 'error',\n        text: translations.createErrorPermissions || 'Failed to create role. Please check your permissions and try again.',\n      });\n    }\n  };\n\n  const handleUpdateRole = async (roleData: { name: string; permissions: string[] }) => {\n    if (!editingRoleId) return;\n    \n    try {\n      const result = await updateRole({\n        id: editingRoleId,\n        name: roleData.name,\n        permissions: roleData.permissions,\n      });\n      \n      if (result) {\n        const successMessage = translations.updateSuccess \n          ? translations.updateSuccess.replace('{roleName}', roleData.name)\n          : `Role \"${roleData.name}\" updated successfully!`;\n        handleSetInLineAlert({\n          type: 'success',\n          text: successMessage,\n        });\n        handleHideEditForm();\n      } else {\n        handleSetInLineAlert({\n          type: 'error',\n          text: translations.updateError || 'Failed to update role. Please try again.',\n        });\n      }\n    } catch (error) {\n      handleSetInLineAlert({\n        type: 'error',\n        text: translations.updateErrorPermissions || 'Failed to update role. Please check your permissions and try again.',\n      });\n    }\n  };\n\n  const requestDeleteRole = (roleId: string) => {\n    const role = roles.find(r => r.id === roleId);\n    if (!role) return;\n    const hasUsers = role.usersCount > 0;\n    setDeleteTarget({ id: roleId, name: role.name, hasUsers });\n  };\n\n  const confirmDeleteRole = async () => {\n    if (!deleteTarget) return;\n    \n    if (deleteTarget.hasUsers) {\n      setDeleteTarget(null);\n      return;\n    }\n    \n    try {\n      const success = await deleteRole(deleteTarget.id);\n      if (success) {\n        const successMessage = translations.deleteRoleSuccess \n          ? translations.deleteRoleSuccess.replace('{roleName}', deleteTarget.name || 'Unknown Role')\n          : `You have deleted role \"${deleteTarget.name || 'Unknown Role'}\".`;\n        handleSetInLineAlert({ type: 'success', text: successMessage });\n      } else {\n        handleSetInLineAlert({ type: 'error', text: translations.deleteError || 'Failed to delete role. Please try again.' });\n      }\n    } catch (error) {\n      handleSetInLineAlert({ type: 'error', text: translations.deleteError || 'Failed to delete role. Please try again.' });\n    } finally {\n      setDeleteTarget(null);\n    }\n  };\n\n  const cancelDeleteRole = () => setDeleteTarget(null);\n\n  return (\n    <div className=\"roles-and-permissions-container\">\n      <div className={classes(['roles-and-permissions', className])}>\n        {withHeader ? (\n          <Header\n            title={translations.containerTitle}\n            divider={false}\n            className={'roles-and-permissions__title'}\n          />\n        ) : null}\n        \n        {/* Show error alert if there's an error */}\n        {error && (\n          <InLineAlert\n            type=\"error\"\n            heading={translations.errorTitle || 'Error'}\n            description={translations.errorMessage || 'An error occurred while loading roles and permissions.'}\n            onDismiss={clearError}\n          />\n        )}\n        \n        {/* Show inline alert for user feedback */}\n        {inLineAlertProps && inLineAlertProps.text && (\n          <InLineAlert\n            type={inLineAlertProps.type || 'success'}\n            heading={inLineAlertProps.text}\n            icon={inLineAlertProps.icon}\n          />\n        )}\n        \n        {/* Conditional rendering: Show either table OR form, never both */}\n        {showCreateForm ? (\n          <EditRoleAndPermission\n            key=\"create-role-form\"\n            mode=\"create\"\n            aclResources={aclResources}\n            existingRoleNames={roles.map(role => role.name)}\n            loading={isCreating}\n            onSubmit={handleCreateRole}\n            onCancel={() => { setPrefillRole(null); handleHideCreateForm(); }}\n            inLineAlertProps={error ? { type: 'error', text: error } : undefined}\n            prefillName={prefillRole?.name}\n            prefillPermissions={prefillRole?.permissions}\n          />\n        ) : showEditForm && editingRoleId ? (\n          <EditRoleAndPermission\n            key={`edit-role-form-${editingRoleId}`}\n            mode=\"edit\"\n            role={roles.find(r => r.id === editingRoleId)}\n            aclResources={aclResources}\n            existingRoleNames={roles.map(role => role.name)}\n            loading={isUpdating}\n            onSubmit={handleUpdateRole}\n            onCancel={handleHideEditForm}\n            inLineAlertProps={error ? { type: 'error', text: error } : undefined}\n          />\n        ) : (\n          <RoleAndPermissionTable\n            roles={paginatedRoles}\n            isLoading={isLoading}\n            canManageRoles={canManageRoles}\n            onShowCreateForm={handleShowCreateForm}\n            onShowEditForm={handleShowEditForm}\n            onDuplicateRole={handleDuplicateRole}\n            onDeleteRole={requestDeleteRole}\n            totalCount={totalCount}\n            currentPage={currentPage}\n            pageSize={pageSize}\n            onPageChange={handlePageChange}\n            onPageSizeChange={handlePageSizeChange}\n            onSortChange={handleSortChange}\n            sortColumn={sortColumn}\n            sortDirection={sortDirection}\n          />\n        )}\n\n        {/* Delete confirmation modal */}\n        <DeleteRoleModal\n          isOpen={!!deleteTarget}\n          hasUsers={deleteTarget?.hasUsers}\n          onConfirm={confirmDeleteRole}\n          onCancel={cancelDeleteRole}\n        />\n      </div>\n    </div>\n  );\n};\n"],"names":["decodeRoleId","encodedId","match","error","RoleAndPermissionTable","className","roles","isLoading","canManageRoles","onShowCreateForm","onShowEditForm","onDuplicateRole","onDeleteRole","totalCount","currentPage","pageSize","DEFAULT_PAGINATION_SIZE","onPageChange","onPageSizeChange","onSortChange","sortColumn","sortDirection","children","props","translations","useText","isTestEnv","define_process_env_default","enableSorting","columns","useMemo","canEditRole","useCallback","role","canDuplicateRole","canDeleteRole","buildActionButtons","actions","jsx","ActionButton","action","index","rowData","pageSizeOptions","size","totalPages","startIndex","endIndex","jsxs","classes","Table","columnKey","direction","sortDir","Pagination","page","ProgressSpinner","Picker","event","target","Button","ROLE_NAME_CONSTRAINTS","getRoleNameForSave","raw","EditRoleAndPermission","mode","aclResources","existingRoleNames","loading","onSubmit","onCancel","inLineAlertProps","prefillName","prefillPermissions","formData","setFormData","useState","errors","setErrors","touched","setTouched","isValidatingName","setIsValidatingName","isSubmitting","setIsSubmitting","treeItems","setTreeItems","expandedIds","setExpandedIds","selectedPermissions","setSelectedPermissions","validationTimeoutRef","useRef","lastValidatedNameRef","isInitializedRef","useEffect","permissionIds","flattenIdsToArray","items","transformAclResourcesToTreeItems","rootIds","item","validateRoleName","name","trimmedNameForSave","existingName","validateRoleNameAsync","basicError","isCompanyRoleNameAvailable","debouncedValidateRoleName","prev","validateForm","newErrors","isValid","nameError","handleRoleNameChange","value","stringValue","handleRoleNameBlur","handleExpandAll","allIds","handleCollapseAll","handleSubmit","roleData","title","Card","Header","InLineAlert","Field","Input","Tree","expanded","hasChildren","toggle","checkbox","e","resources","processResource","resource","parentId","a","b","child","DeleteRoleModal","isOpen","hasUsers","onConfirm","message","Modal","Fragment","RolesAndPermissions","withHeader","handleSetInLineAlert","useInLineAlert","permissions","permissionsLoading","permissionsError","useUserPermissions","canViewRoles","hasAnyRoleAccess","isCreating","isUpdating","createRole","updateRole","deleteRole","clearError","refresh","useCompanyRoles","showCreateForm","setShowCreateForm","showEditForm","setShowEditForm","editingRoleId","setEditingRoleId","setCurrentPage","setPageSize","setSortColumn","setSortDirection","deleteTarget","setDeleteTarget","prefillRole","setPrefillRole","companyChangeTrigger","setCompanyChangeTrigger","useCompanyContextListener","sortedRoles","sorted","aValue","bValue","decodeId","id","decoded","num","paginatedRoles","IllustratedMessage","handlePageChange","handlePageSizeChange","newPageSize","handleSortChange","handleShowCreateForm","handleHideCreateForm","handleShowEditForm","roleId","handleHideEditForm","handleDuplicateRole","source","r","handleCreateRole","successMessage","handleUpdateRole","requestDeleteRole","confirmDeleteRole","cancelDeleteRole"],"mappings":"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"}