{"version":3,"file":"AcceptInvitation.js","sources":["/@dropins/storefront-company-management/src/lib/switchCompanyContext.ts","/@dropins/storefront-company-management/src/hooks/useAcceptInvitation.ts","/@dropins/storefront-company-management/src/components/AcceptInvitationForm/AcceptInvitationForm.tsx","/@dropins/storefront-company-management/src/containers/AcceptInvitation/AcceptInvitation.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { getCustomerCompany } from '@/company-management/api/getCustomerCompany/getCustomerCompany';\n\n/**\n * Switches the company context to the specified company ID\n * Only switches if:\n * 1. The invited customer ID matches the logged-in customer ID\n * 2. There's no company ID already in session\n * \n * This replicates Luma's behavior in AcceptInvitation controller.\n * \n * @param companyId - The company ID to switch to (base64 encoded)\n * @param invitedCustomerId - The customer ID from the invitation (base64 encoded)\n */\nexport async function switchCompanyContext(companyId: string, invitedCustomerId: string): Promise<void> {\n  const companySessionStorageKey = 'DROPIN__COMPANYSWITCHER__COMPANY__CONTEXT';\n  const groupSessionStorageKey = 'DROPIN__COMPANYSWITCHER__GROUP__CONTEXT';\n\n  // Check if there's already a company ID in session\n  // Match Luma's behavior: only set company context if user doesn't have one yet\n  const existingCompanyId = sessionStorage.getItem(companySessionStorageKey);\n  if (existingCompanyId) {\n    return; // Don't override existing company context\n  }\n\n  try {\n    // Get logged-in customer info including customer ID\n    const customerInfo = await getCustomerCompany();\n    if (!customerInfo?.customerId) {\n      return; // No customer ID available\n    }\n\n    // Compare base64-encoded IDs (GraphQL returns base64-encoded ID)\n    if (customerInfo.customerId !== invitedCustomerId) {\n      return; // Invitation is for a different customer\n    }\n\n    // Set company ID in session storage\n    sessionStorage.setItem(companySessionStorageKey, companyId);\n    \n    // Remove customer group ID - company-switcher will refresh it on reload\n    sessionStorage.removeItem(groupSessionStorageKey);\n  } catch (error) {\n    // Silently fail - don't set company context if we can't verify\n    console.error('Failed to switch company context:', error);\n  }\n}\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useEffect, useState, useRef } from 'preact/hooks';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { acceptCompanyInvitation, companyEnabled } from '@/company-management/api';\nimport { AcceptCompanyInvitationInput, InvitationStatus } from '@/company-management/types';\nimport { switchCompanyContext } from '@/company-management/lib';\n\n/**\n * Hook to handle company invitation acceptance from email link\n * Parses URL parameters, validates company is enabled, and calls the API\n * \n * @param isAuthenticated - Whether the user is currently authenticated\n */\nexport const useAcceptInvitation = (isAuthenticated: boolean = false): InvitationStatus => {\n  // Check URL parameters synchronously to determine initial state\n  const urlParams = new URLSearchParams(window.location.search);\n  const code = urlParams.get('code');\n  const customerId = urlParams.get('customer[customer_id]');\n  const companyId = urlParams.get('customer[company_id]');\n  const hasInvalidParams = !code || !customerId || !companyId;\n\n  const translations = useText({\n    companyDisabledError: 'Company.AcceptInvitation.companyDisabledError',\n    invalidLinkError: 'Company.AcceptInvitation.invalidLinkError',\n    expiredLinkError: 'Company.AcceptInvitation.expiredLinkError',\n    genericError: 'Company.AcceptInvitation.genericError',\n  });\n\n  const [status, setStatus] = useState<InvitationStatus>({\n    isLoading: false,\n    isSuccess: false,\n    isError: hasInvalidParams,\n    errorMessage: '',\n    isCompanyDisabled: false,\n  });\n\n  const hasProcessedRef = useRef(false);\n\n  useEffect(() => {\n    // Only process once\n    if (hasProcessedRef.current) return;\n\n    const processInvitation = async () => {\n      // Validate required parameters - show error if missing\n      if (hasInvalidParams) {\n        hasProcessedRef.current = true;\n        setStatus({\n          isLoading: false,\n          isSuccess: false,\n          isError: true,\n          errorMessage: translations.invalidLinkError,\n          isCompanyDisabled: false,\n        });\n        return;\n      }\n\n      // Mark as processing IMMEDIATELY to prevent duplicate calls\n      hasProcessedRef.current = true;\n\n      // Valid invitation parameters - start processing\n      setStatus({\n        isLoading: true,\n        isSuccess: false,\n        isError: false,\n        errorMessage: '',\n        isCompanyDisabled: false,\n      });\n\n      // Check if B2B company features are enabled\n      const isEnabled = await companyEnabled();\n      if (!isEnabled) {\n        setStatus({\n          isLoading: false,\n          isSuccess: false,\n          isError: true,\n          errorMessage: translations.companyDisabledError,\n          isCompanyDisabled: true,\n        });\n        return;\n      }\n\n      // Get remaining URL parameters (code, customerId, companyId already extracted above)\n      const jobTitle = urlParams.get('customer[job_title]');\n      const telephone = urlParams.get('customer[telephone]');\n      const statusParam = urlParams.get('customer[status]');\n\n      // Prepare invitation input\n      const invitationInput: AcceptCompanyInvitationInput = {\n        code,\n        user: {\n          customerId,\n          companyId,\n          jobTitle: jobTitle || null,\n          telephone: telephone || null,\n          status: statusParam ? (statusParam === '1' ? 'ACTIVE' : 'INACTIVE') : null,\n        },\n        roleId: null,\n      };\n\n      try {\n        // Call API to accept invitation\n        const result = await acceptCompanyInvitation(invitationInput);\n\n        if (result && result.success) {\n          // Clear URL parameters\n          const url = new URL(window.location.href);\n          url.search = '';\n          window.history.replaceState({}, '', url.toString());\n\n          // Switch company context to the newly joined company (only if authenticated)\n          // Only switches if logged-in customer matches invited customer\n          // and there's no company ID already in session\n          if (isAuthenticated) {\n            await switchCompanyContext(companyId, customerId);\n          }\n\n          // Show success message with buttons for user to navigate\n          // Company context will be applied when navigating to My Account\n          setStatus({\n            isLoading: false,\n            isSuccess: true,\n            isError: false,\n            errorMessage: '',\n            isCompanyDisabled: false,\n          });\n        } else {\n          setStatus({\n            isLoading: false,\n            isSuccess: false,\n            isError: true,\n            errorMessage: translations.expiredLinkError,\n            isCompanyDisabled: false,\n          });\n        }\n      } catch (error) {\n        // Extract error message from caught error (GraphQL errors are thrown by handleFetchError)\n        const errorMessage = error instanceof Error ? error.message : translations.genericError;\n        \n        setStatus({\n          isLoading: false,\n          isSuccess: false,\n          isError: true,\n          errorMessage,\n          isCompanyDisabled: false,\n        });\n      }\n    };\n\n    processInvitation();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [translations]);\n\n  return status;\n};\n\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { FunctionComponent } from 'preact';\nimport { Button, ProgressSpinner, InLineAlert } from '@adobe-commerce/elsie/components';\nimport { classes } from '@adobe-commerce/elsie/lib';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { useAcceptInvitation } from '@/company-management/hooks/useAcceptInvitation';\nimport { AcceptInvitationFormProps } from '@/company-management/types';\nimport '@adobe-commerce/storefront-design/dist/css/base.css';\nimport './AcceptInvitationForm.css';\n\nexport const AcceptInvitationForm: FunctionComponent<AcceptInvitationFormProps> = ({\n  routeMyAccount,\n  routeLogin,\n  isAuthenticated = false,\n  labels,\n  className = '',\n}) => {\n  const { isLoading, isSuccess, isError, errorMessage, isCompanyDisabled } = useAcceptInvitation(isAuthenticated);\n\n  const translations = useText({\n    title: 'Company.AcceptInvitation.title',\n    loadingText: 'Company.AcceptInvitation.loadingText',\n    successMessage: 'Company.AcceptInvitation.successMessage',\n    myAccountButton: 'Company.AcceptInvitation.myAccountButton',\n    loginButton: 'Company.AcceptInvitation.loginButton',\n  });\n\n  const finalLabels = { ...translations, ...labels };\n\n  if (isLoading) {\n    return (\n      <div className={classes(['company-accept-invitation-wrapper', className])}>\n        <h2>{finalLabels.title}</h2>\n        <div className=\"company-accept-invitation-loading\">\n          <ProgressSpinner />\n          <p>{finalLabels.loadingText}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isSuccess || isError) {\n    return (\n      <div className={classes(['company-accept-invitation-wrapper', className])}>\n        <h2>{finalLabels.title}</h2>\n        <InLineAlert \n          type={isSuccess ? 'success' : 'error'}\n          variant=\"secondary\" \n          heading={isSuccess ? finalLabels.successMessage || '' : errorMessage} \n        />\n        <div className=\"company-accept-invitation-wrapper__buttons\">\n          {!isCompanyDisabled && !isAuthenticated && routeLogin && (\n            <Button\n              variant=\"primary\"\n              onClick={() => {\n                window.location.href = routeLogin();\n              }}\n              className=\"company-accept-invitation-wrapper__submit\"\n            >\n              {finalLabels.loginButton}\n            </Button>\n          )}\n          {isAuthenticated && routeMyAccount && (\n            <Button\n              variant=\"primary\"\n              onClick={() => {\n                window.location.href = routeMyAccount();\n              }}\n              className=\"company-accept-invitation-wrapper__submit\"\n            >\n              {finalLabels.myAccountButton}\n            </Button>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  return null;\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { AcceptInvitationForm } from '@/company-management/components';\nimport { AcceptInvitationProps } from '@/company-management/types';\n\nexport const AcceptInvitation: Container<AcceptInvitationProps> = ({\n  routeMyAccount,\n  routeLogin,\n  isAuthenticated,\n  labels,\n  className = '',\n}) => {\n  return (\n    <div className={`company-accept-invitation-container ${className}`}>\n      <AcceptInvitationForm\n        routeMyAccount={routeMyAccount}\n        routeLogin={routeLogin}\n        isAuthenticated={isAuthenticated}\n        labels={labels}\n      />\n    </div>\n  );\n};\n"],"names":["switchCompanyContext","companyId","invitedCustomerId","companySessionStorageKey","groupSessionStorageKey","customerInfo","getCustomerCompany","error","useAcceptInvitation","isAuthenticated","urlParams","code","customerId","hasInvalidParams","translations","useText","status","setStatus","useState","hasProcessedRef","useRef","useEffect","companyEnabled","jobTitle","telephone","statusParam","invitationInput","result","acceptCompanyInvitation","url","errorMessage","AcceptInvitationForm","routeMyAccount","routeLogin","labels","className","isLoading","isSuccess","isError","isCompanyDisabled","finalLabels","jsxs","classes","jsx","ProgressSpinner","InLineAlert","Button","AcceptInvitation"],"mappings":"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"}