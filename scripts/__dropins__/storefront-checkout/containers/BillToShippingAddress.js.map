{"version":3,"file":"BillToShippingAddress.js","sources":["/@dropins/storefront-checkout/src/components/BillToShippingAddress/BillToShippingAddressSkeleton.tsx","/@dropins/storefront-checkout/src/components/BillToShippingAddress/BillToShippingAddress.tsx","/@dropins/storefront-checkout/src/containers/BillToShippingAddress/BillToShippingAddress.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Skeleton, SkeletonRow } from '@adobe-commerce/elsie/components';\nimport { FunctionComponent } from 'preact';\n\nexport const BillToShippingAddressSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton\n      className=\"bill-to-shipping-address__skeleton\"\n      data-testid=\"bill-to-shipping-skeleton\"\n    >\n      <SkeletonRow size=\"small\" variant=\"row\" />\n    </Skeleton>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport '@/checkout/components/BillToShippingAddress/BillToShippingAddress.css';\nimport { BillToShippingAddressSkeleton } from '@/checkout/components/BillToShippingAddress/BillToShippingAddressSkeleton';\nimport { WithConditionals } from '@/checkout/components/ConditionalWrapper/ConditionalWrapper';\nimport { Checkbox, InLineAlert } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { classes } from '@adobe-commerce/elsie/lib/classes';\nimport { FunctionComponent } from 'preact';\nimport { ChangeEvent, HTMLAttributes } from 'preact/compat';\n\nexport interface BillToShippingAddressProps\n  extends Omit<\n    HTMLAttributes<HTMLInputElement>,\n    'loading' | 'disabled' | 'onChange'\n  > {\n  disabled?: boolean;\n  error?: string | null;\n  onChange?: (checked: boolean) => void;\n  onDismissError?: () => void;\n}\n\nconst BillToShippingAddressComponent: FunctionComponent<\n  BillToShippingAddressProps\n> = ({\n  className,\n  checked,\n  disabled,\n  error = null,\n  onChange = () => {},\n  onDismissError = () => {},\n}) => {\n  const translations = useText({\n    title: 'Checkout.BillToShippingAddress.title',\n  });\n\n  const hasError = error !== null;\n\n  const handleChange = (event: Event | ChangeEvent<HTMLInputElement>) => {\n    const checkbox = event.target as HTMLInputElement;\n    onChange?.(checkbox.checked);\n  };\n\n  return (\n    <div className=\"checkout-bill-to-shipping-address\">\n      <Checkbox\n        checked={checked}\n        className={classes([\n          'checkout-bill-to-shipping-address__checkbox',\n          className,\n        ])}\n        data-testid=\"bill-to-shipping-checkbox\"\n        disabled={disabled}\n        label={translations.title}\n        name=\"checkout-bill-to-shipping-address__checkbox\"\n        onChange={handleChange}\n      />\n\n      {hasError && (\n        <div\n          className=\"checkout-bill-to-shipping-address__error\"\n          data-testid=\"checkout-bill-to-shipping-address-alert\"\n        >\n          <InLineAlert\n            heading={error}\n            type=\"error\"\n            variant=\"primary\"\n            onDismiss={onDismissError}\n          />\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport const BillToShippingAddress = WithConditionals(\n  BillToShippingAddressComponent,\n  BillToShippingAddressSkeleton\n);\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { config, setBillingAddress } from '@/checkout/api';\nimport { BillToShippingAddress as BillToShippingAddressComponent } from '@/checkout/components/BillToShippingAddress';\nimport { Cart, NegotiableQuote } from '@/checkout/data/models';\nimport {\n  getLatestCheckoutUpdate,\n  getValue,\n  hasPendingUpdates,\n  hasShippingAddress,\n  notifyValues,\n} from '@/checkout/lib';\nimport { isSetAddressRequestPending } from '@/checkout/store/ui';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { events } from '@adobe-commerce/event-bus';\nimport { HTMLAttributes } from 'preact/compat';\nimport { useCallback, useEffect, useRef, useState } from 'preact/hooks';\n\ninterface CartSyncError {\n  error: Error;\n}\n\nexport interface BillToShippingAddressProps\n  extends Omit<HTMLAttributes<HTMLDivElement>, 'onChange'> {\n  active?: boolean;\n  autoSync?: boolean;\n  onCartSyncError?: (error: CartSyncError) => void;\n  onChange?: (checked: boolean) => void;\n}\n\nexport const BillToShippingAddress: Container<BillToShippingAddressProps> = ({\n  active = true,\n  autoSync = true,\n  onCartSyncError,\n  onChange,\n}) => {\n  const [error, setError] = useState<string | null>(null);\n  const [isVirtual, setIsVirtual] = useState(false);\n  const [isChecked, setIsChecked] = useState<boolean | undefined>();\n\n  const hasInitialCartData = useRef(false);\n\n  const isDisabled = hasPendingUpdates.value || isSetAddressRequestPending.value;\n\n  const { cartSyncError } = useText({\n    cartSyncError: 'Checkout.BillToShippingAddress.cartSyncError',\n  });\n\n  const handleDismissError = useCallback(() => {\n    setError(null);\n  }, []);\n\n  const handleChange = useCallback(\n    (isBillToShipping: boolean) => {\n      setError(null);\n      setIsChecked(isBillToShipping);\n\n      onChange?.(isBillToShipping);\n\n      if (!autoSync || !isBillToShipping || !hasShippingAddress()) {\n        return;\n      }\n\n      setBillingAddress({ sameAsShipping: true }).catch((error: any) => {\n        setIsChecked(false);\n        onCartSyncError?.({ error });\n\n        if (!onCartSyncError) {\n          setError(cartSyncError);\n        }\n      });\n    },\n    [autoSync, cartSyncError, onCartSyncError, onChange]\n  );\n\n  const handleCheckoutData = useCallback(\n    (data: Cart | NegotiableQuote | null) => {\n      const isCartEmpty = !data || data.isEmpty;\n      const isCartVirtual = !!data?.isVirtual;\n\n      if (isCartEmpty || isCartVirtual) {\n        setIsVirtual(isCartVirtual);\n        setIsChecked(false);\n        hasInitialCartData.current = false;\n        return;\n      }\n\n      // If we've already set the initial state from cart data, don't override it.\n      // This preserves any changes the user might have made.\n      if (hasInitialCartData.current) {\n        return;\n      }\n\n      const cart = data as Cart;\n      const shippingAddress = cart.shippingAddresses?.[0];\n      const hasBillingAddress = !!cart.billingAddress;\n\n      let initialIsChecked: boolean;\n\n      if (!shippingAddress) {\n        const { defaults } = config.getConfig();\n        initialIsChecked = defaults!.isBillToShipping!;\n      } else {\n        initialIsChecked = shippingAddress.sameAsBilling ?? !hasBillingAddress;\n      }\n\n      setIsChecked(initialIsChecked);\n      hasInitialCartData.current = true;\n\n      if (\n        autoSync &&\n        initialIsChecked &&\n        shippingAddress &&\n        !hasBillingAddress\n      ) {\n        setBillingAddress({ sameAsShipping: true }).catch(() => {});\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    []\n  );\n\n  useEffect(() => {\n    if (!active || isChecked === undefined) return;\n    notifyValues({ isBillToShipping: isChecked });\n  }, [active, isChecked]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const pastUpdate = getLatestCheckoutUpdate();\n\n    if (pastUpdate) {\n      // When component becomes active, restore key state so handleCheckoutData can work properly\n      const userBillToShipping = getValue('isBillToShipping');\n      if (userBillToShipping != null) {\n        setIsChecked(userBillToShipping);\n      }\n      handleCheckoutData(pastUpdate);\n      return;\n    }\n\n    const onCheckoutInit = events.on(\n      'checkout/initialized',\n      handleCheckoutData,\n      { eager: true }\n    );\n\n    return () => {\n      onCheckoutInit?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const onCheckoutUpdated = events.on(\n      'checkout/updated',\n      handleCheckoutData,\n      {\n        eager: false,\n      }\n    );\n\n    return () => {\n      onCheckoutUpdated?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  return (\n    <BillToShippingAddressComponent\n      checked={isChecked}\n      disabled={isDisabled}\n      error={error}\n      initialized={isChecked !== undefined}\n      visible={active && !isVirtual}\n      onChange={handleChange}\n      onDismissError={handleDismissError}\n    />\n  );\n};\n"],"names":["BillToShippingAddressSkeleton","jsx","Skeleton","SkeletonRow","BillToShippingAddressComponent","className","checked","disabled","error","onChange","onDismissError","translations","useText","hasError","handleChange","event","checkbox","jsxs","Checkbox","classes","InLineAlert","BillToShippingAddress","WithConditionals","active","autoSync","onCartSyncError","setError","useState","isVirtual","setIsVirtual","isChecked","setIsChecked","hasInitialCartData","useRef","isDisabled","hasPendingUpdates","isSetAddressRequestPending","cartSyncError","handleDismissError","useCallback","isBillToShipping","hasShippingAddress","setBillingAddress","handleCheckoutData","data","isCartEmpty","isCartVirtual","cart","shippingAddress","_a","hasBillingAddress","initialIsChecked","defaults","config","useEffect","notifyValues","pastUpdate","getLatestCheckoutUpdate","userBillToShipping","getValue","onCheckoutInit","events","onCheckoutUpdated"],"mappings":"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"}