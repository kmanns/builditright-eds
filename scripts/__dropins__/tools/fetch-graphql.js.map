{"version":3,"file":"fetch-graphql.js","sources":["@dropins/tools/src/fetch-graphql/index.ts"],"sourcesContent":["/********************************************************************\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this \n * file in accordance with the terms of the Adobe license agreement \n * accompanying it. \n *******************************************************************/\n\nexport type Header = { [key: string]: string | null };\n\nexport type FetchOptions = {\n  method?: 'GET' | 'POST';\n  variables?: { [key: string]: any };\n  signal?: AbortSignal;\n  cache?:\n    | 'default'\n    | 'no-store'\n    | 'reload'\n    | 'no-cache'\n    | 'force-cache'\n    | 'only-if-cached';\n};\n\nexport type FetchQueryError = Array<{\n  message: string;\n  extensions: { category: string };\n}>;\n\nexport type BeforeHook = (requestInit: RequestInit) => RequestInit;\nexport type AfterHook<T = any> = (\n    requestInit: RequestInit,\n    response: { errors?: FetchQueryError; data: T }\n) => { errors?: FetchQueryError; data: T };\n\nconst defaultHeaders = {\n  'Content-Type': 'application/json',\n  Accept: 'application/json',\n};\n\nclass FetchGraphQLMesh {\n  protected _endpoint?: string;\n\n  public _fetchGraphQlHeaders: Header = {};\n\n  public _beforeHooks: BeforeHook[] = [];\n\n  public _afterHooks: AfterHook[] = [];\n\n  get endpoint() {\n    return this._endpoint;\n  }\n\n  get fetchGraphQlHeaders() {\n    return this._fetchGraphQlHeaders;\n  }\n\n  /**\n   * Sets the GraphQL endpoint.\n   * @param endpoint - The GraphQL endpoint URL string.\n   * @example\n   * ```js\n   * // Set endpoint as string\n   * instance.setEndpoint('https://api.example.com/graphql');\n   * ```\n   */\n  public setEndpoint(endpoint: string) {\n    this._endpoint = endpoint;\n  }\n\n  /**\n   * Sets the GraphQL headers.\n   * @param key - The key of the header.\n   * @param value - The value of the header.\n   */\n  public setFetchGraphQlHeader(key: string, value: string | null) {\n    this._fetchGraphQlHeaders = {\n      ...this._fetchGraphQlHeaders,\n      [key]: value,\n    };\n  }\n\n  /**\n   * Removes a specific GraphQL header.\n   * @param key - The key of the header.\n   */\n  public removeFetchGraphQlHeader(key: string) {\n    delete this._fetchGraphQlHeaders[key];\n  }\n\n  /**\n   * Gets the value of a specific GraphQL header.\n   * @param key - The key of the header.\n   * @returns The value of the header, or undefined if not found.\n   */\n  public getFetchGraphQlHeader(key: string): string | null | undefined {\n    return this._fetchGraphQlHeaders[key];\n  }\n\n  /**\n   * Sets the GraphQL headers.\n   * @param header - The header object or a function that returns a header object.\n   * If a function is provided, it will be called with the previous headers.\n   * The returned object will be merged with the previous headers.\n   * @example\n   * ```js\n   * // set headers\n   * setFetchGraphQlHeaders({ test: 'test' });\n   * \n   * // merge with previous headers\n   * setFetchGraphQlHeaders((prev) => ({\n   *   ...prev,\n   *  test: 'test2',\n   * }));\n   * ```\n   */\n  public setFetchGraphQlHeaders(header: Header | ((prev: Header) => Header)) {\n    if (typeof header === 'function') {\n      this._fetchGraphQlHeaders = {\n        ...this._fetchGraphQlHeaders,\n        ...header(this._fetchGraphQlHeaders),\n      };\n    } else {\n      this._fetchGraphQlHeaders = { ...header };\n    }\n  }\n\n  /**\n   * Adds a hook executed before the GraphQL call.\n   * @param hook - The hook function.\n   * @example\n   * ```js\n   * // add before hook\n   * addBeforeHook((requestInit) => console.log('About to execute ' + requestInit.method + ' call.'));\n   *\n   * // modify the requestInit before executing the request\n   * addBeforeHook((requestInit) => {method: requestInit.method, body: 'new body'});\n   * ```\n   */\n  public addBeforeHook(hook: BeforeHook): void {\n    this._beforeHooks.push(hook);\n  }\n\n  /**\n   * Adds a hook executed before the GraphQL call.\n   * @param hook - The hook function.\n   * @example\n   * ```js\n   * // add before hook\n   * addAfterHook((requestInit, response) => console.log(\n   *     'The result of ' + requestInit.method + ' call is ' + response.json().body\n   * ));\n   *\n   * // modify the response\n   * addAfterHook((requestInit, response) => new Response(JSON.stringify({ ...response, modified: true }));\n   * ```\n   */\n  public addAfterHook(hook: AfterHook): void {\n    this._afterHooks.push(hook);\n  }\n  \n  /**\n   * Collects all before hooks. Can be overridden by subclasses for inheritance.\n   * @protected\n   */\n  protected _collectBeforeHooks(): BeforeHook[] {\n    return this._beforeHooks;\n  }\n  \n  /**\n   * Collects all after hooks. Can be overridden by subclasses for inheritance.\n   * @protected\n   */\n  protected _collectAfterHooks(): AfterHook[] {\n    return this._afterHooks;\n  }\n  \n  /**\n   * Fetches GraphQL data.\n   * @param query - The GraphQL query.\n   * @param options - Optional configuration for the fetch request.\n   * @returns\n   */\n  public async fetchGraphQl<T = any>(\n    query: string,\n    options?: FetchOptions\n  ): Promise<{ errors?: FetchQueryError; data: T }> {\n    const endpoint = this.endpoint;\n    const fetchGraphQlHeaders = this.fetchGraphQlHeaders;\n\n    if (!endpoint) throw Error('Missing \"url\"');\n\n    const method = options?.method ?? 'POST';\n    const cache = options?.cache;\n    const signal = options?.signal;\n\n    let body;\n    const url = new URL(endpoint);\n    const headers = {\n      ...defaultHeaders,\n      ...fetchGraphQlHeaders,\n    };\n\n    if (method === 'POST') {\n      body = JSON.stringify({\n        query,\n        variables: options?.variables,\n      });\n    }\n\n    if (method === 'GET') {\n      url.searchParams.append('query', minimizeGraphQlQuery(query));\n\n      if (options?.variables)\n        url.searchParams.append('variables', JSON.stringify(options.variables));\n    }\n\n    let requestInit: RequestInit = {\n      method,\n      headers,\n      body,\n      cache,\n      signal,\n    };\n\n    // Collect and execute before hooks\n    const allBeforeHooks = this._collectBeforeHooks();\n    requestInit = await allBeforeHooks.reduce(\n        async (prev, hook) => hook(await prev),\n        Promise.resolve(requestInit)\n    );\n\n    // Collect and execute after hooks\n    const allAfterHooks = this._collectAfterHooks();\n    return await fetch(url, requestInit).then((r) => r.json().then(\n        (response) => allAfterHooks.reduce(\n            async (result, hook) => hook(requestInit, await result),\n            Promise.resolve(response)\n        )\n    ));\n  }\n  \n  /**\n   * Gets the configuration.\n   */\n  public getConfig() {\n    return {\n      endpoint: this.endpoint,\n      fetchGraphQlHeaders: this.fetchGraphQlHeaders,\n    };\n  }\n\n  public getMethods() {\n    return {\n      setEndpoint: this.setEndpoint.bind(this),\n      setFetchGraphQlHeader: this.setFetchGraphQlHeader.bind(this),\n      getFetchGraphQlHeader: this.getFetchGraphQlHeader.bind(this),\n      removeFetchGraphQlHeader: this.removeFetchGraphQlHeader.bind(this),\n      setFetchGraphQlHeaders: this.setFetchGraphQlHeaders.bind(this),\n      fetchGraphQl: this.fetchGraphQl.bind(this),\n      getConfig: this.getConfig.bind(this),\n      addBeforeHook: this.addBeforeHook.bind(this),\n      addAfterHook: this.addAfterHook.bind(this),\n    };\n  }\n}\n\nconst mesh = new FetchGraphQLMesh();\n\n/**\n * `FetchGraphQL` is a class that extends `FetchGraphQLMesh`.\n * It provides methods to get the GraphQL endpoint and headers with support for inheritance.\n *\n * @class\n *\n */\nexport class FetchGraphQL extends FetchGraphQLMesh {\n  private _mode: 'standalone' | 'linked' | 'default' = 'default';\n  private _source?: string | FetchGraphQL;\n\n  get endpoint(): string | undefined {\n    switch (this._mode) {\n      case 'standalone':\n        return this._source as string;\n      case 'linked':\n        return (this._source as FetchGraphQL)?.endpoint;\n      case 'default':\n        return mesh.endpoint;\n    }\n  }\n\n  get fetchGraphQlHeaders(): Header {    \n    switch (this._mode) {\n      case 'standalone':\n        // Standalone instance - only use own headers\n        return this._fetchGraphQlHeaders;\n      case 'linked':\n        // Linked to another instance - use linked instance's headers directly\n        return (this._source as FetchGraphQL).fetchGraphQlHeaders;\n      case 'default':\n        // Default - inherit from global mesh\n        return {\n          ...mesh.fetchGraphQlHeaders,\n          ...this._fetchGraphQlHeaders,\n        };\n    }\n  }\n\n  /**\n   * Sets the GraphQL endpoint or links to another FetchGraphQL instance.\n   * @param endpoint - The GraphQL endpoint URL string, or a FetchGraphQL instance to link to.\n   * @example\n   * ```js\n   * // Set endpoint as string\n   * instance.setEndpoint('https://api.example.com/graphql');\n   * \n   * // Link to another instance\n   * const parent = new FetchGraphQL();\n   * parent.setEndpoint('https://api.example.com/graphql');\n   * \n   * const child = new FetchGraphQL();\n   * child.setEndpoint(parent); // Links to parent, shares endpoint, headers, and hooks\n   * ```\n   */\n  public setEndpoint(endpoint: string | FetchGraphQL): void {\n    if (endpoint instanceof FetchGraphQL) {\n      // Link to another instance\n      this._mode = 'linked';\n      this._source = endpoint;\n    } else {\n      // Set string endpoint - become standalone\n      this._mode = 'standalone';\n      this._source = endpoint;\n    }\n  }\n\n  /**\n   * Sets a GraphQL header. When linked to another instance, this sets the header on the linked instance.\n   * @param key - The key of the header.\n   * @param value - The value of the header.\n   */\n  public setFetchGraphQlHeader(key: string, value: string | null): void {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      (this._source as FetchGraphQL).setFetchGraphQlHeader(key, value);\n    } else {\n      // Set on self\n      super.setFetchGraphQlHeader(key, value);\n    }\n  }\n\n  /**\n   * Sets the GraphQL headers. When linked to another instance, this sets the headers on the linked instance.\n   * @param header - The header object or a function that returns a header object.\n   */\n  public setFetchGraphQlHeaders(header: Header | ((prev: Header) => Header)): void {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      (this._source as FetchGraphQL).setFetchGraphQlHeaders(header);\n    } else {\n      // Set on self\n      super.setFetchGraphQlHeaders(header);\n    }\n  }\n\n  /**\n   * Removes a specific GraphQL header. When linked to another instance, this removes the header from the linked instance.\n   * @param key - The key of the header.\n   */\n  public removeFetchGraphQlHeader(key: string): void {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      (this._source as FetchGraphQL).removeFetchGraphQlHeader(key);\n    } else {\n      // Remove from self\n      super.removeFetchGraphQlHeader(key);\n    }\n  }\n\n  /**\n   * Gets the value of a specific GraphQL header. When linked to another instance, this gets the header from the linked instance.\n   * @param key - The key of the header.\n   * @returns The value of the header, or undefined if not found.\n   */\n  public getFetchGraphQlHeader(key: string): string | null | undefined {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      return (this._source as FetchGraphQL).getFetchGraphQlHeader(key);\n    } else {\n      // Get from self\n      return super.getFetchGraphQlHeader(key);\n    }\n  }\n\n  /**\n   * Adds a before hook. When linked to another instance, this adds the hook to the linked instance.\n   * @param hook - The hook function.\n   */\n  public addBeforeHook(hook: BeforeHook): void {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      (this._source as FetchGraphQL).addBeforeHook(hook);\n    } else {\n      // Add to self\n      super.addBeforeHook(hook);\n    }\n  }\n\n  /**\n   * Adds an after hook. When linked to another instance, this adds the hook to the linked instance.\n   * @param hook - The hook function.\n   */\n  public addAfterHook(hook: AfterHook): void {\n    if (this._mode === 'linked') {\n      // Delegate to linked instance\n      (this._source as FetchGraphQL).addAfterHook(hook);\n    } else {\n      // Add to self\n      super.addAfterHook(hook);\n    }\n  }\n\n  /**\n   * Collects all before hooks. When linked, delegates to the linked instance.\n   * @protected\n   */\n  protected _collectBeforeHooks(): BeforeHook[] {\n    if (this._mode === 'linked') {\n      return (this._source as FetchGraphQL)._collectBeforeHooks();\n    }\n    return this._beforeHooks;\n  }\n  \n  /**\n   * Collects all after hooks. When linked, delegates to the linked instance.\n   * @protected\n   */\n  protected _collectAfterHooks(): AfterHook[] {\n    if (this._mode === 'linked') {\n      return (this._source as FetchGraphQL)._collectAfterHooks();\n    }\n    return this._afterHooks;\n  }\n}\n\nfunction minimizeGraphQlQuery(query: string) {\n  // Remove comments\n  query = query.replace(/#.*/g, '');\n\n  // Remove extra spaces, tabs, and line breaks\n  query = query.replace(/\\s+/g, ' ');\n\n  return query.trim();\n}\n/**\n * Exports several methods from the `mesh` object.\n *\n * @property {Function} setEndpoint - Sets the GraphQL endpoint.\n * @property {Function} setFetchGraphQlHeaders - Sets the GraphQL headers.\n * @property {Function} setFetchGraphQlHeader - Sets a specific GraphQL header.\n * @property {Function} getFetchGraphQlHeader - Gets the value of a specific GraphQL header.\n * @property {Function} removeFetchGraphQlHeader - Removes a specific GraphQL header.\n * @property {Function} fetchGraphQl - Fetches GraphQL data.\n * @property {Function} getConfig - Gets the configuration.\n * @property {Function} addBeforeHook - Adds a hook executed before the GraphQL call.\n * @property {Function} addAfterHook - Adds a hook executed after the GraphQL call.\n */\n\n// Global Mesh instance\nexport const {\n  setEndpoint,\n  setFetchGraphQlHeaders,\n  setFetchGraphQlHeader,\n  getFetchGraphQlHeader,\n  removeFetchGraphQlHeader,\n  fetchGraphQl,\n  getConfig,\n  addBeforeHook,\n  addAfterHook,\n} = mesh.getMethods();\n"],"names":["defaultHeaders","FetchGraphQLMesh","__publicField","endpoint","key","value","header","hook","query","options","fetchGraphQlHeaders","method","cache","signal","body","url","headers","minimizeGraphQlQuery","requestInit","prev","allAfterHooks","r","response","result","mesh","FetchGraphQL","_a","setEndpoint","setFetchGraphQlHeaders","setFetchGraphQlHeader","getFetchGraphQlHeader","removeFetchGraphQlHeader","fetchGraphQl","getConfig","addBeforeHook","addAfterHook"],"mappings":"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"}