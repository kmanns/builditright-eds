{"version":3,"file":"CompanySwitcher.js","sources":["/@dropins/storefront-company-switcher/src/hooks/useCompanyData.ts","/@dropins/storefront-company-switcher/src/containers/CompanySwitcher/CompanySwitcher.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { useState, useCallback, useEffect } from 'preact/hooks';\nimport { events } from '@adobe-commerce/event-bus';\nimport { CustomerCompanyContext, updateCustomerGroup } from '@/company-switcher/api/customerCompanyContext';\nimport type { CompanyOption, CustomerCompanyInfo, UseCompanyDataProps, UseCompanyDataReturn } from '@/company-switcher/types/company';\nimport { config } from '@/company-switcher/api/initialize';\nimport { getGroupHeaderManager } from '@/company-switcher/api/setGroupHeaders';\nimport { getCompanyHeaderManager } from '@/company-switcher/api/setCompanyHeaders';\n\n/**\n * Custom hook that manages company data fetching and state management\n * @returns {UseCompanyDataReturn} Company data and handlers\n */\nexport const useCompanyData = ({ onCompanyChange }: UseCompanyDataProps = {}): UseCompanyDataReturn => {\n  const [companies, setCompanies] = useState<CompanyOption[]>([]);\n  const [currentCompany, setCurrentCompany] = useState<CompanyOption>({ text: '', value: '' });\n\n\n  /**\n   * Loads company information from the API and updates state\n   */\n  const loadCompanyData = useCallback(async (): Promise<void> => {\n    try {\n      const customerCompanyContext = CustomerCompanyContext.getInstance();\n      const companyInfo: CustomerCompanyInfo = await customerCompanyContext.getCustomerCompanyInfo();\n      setCompanies(companyInfo.customerCompanies);\n      \n      if (companyInfo.currentCompany?.name && companyInfo.currentCompany?.id) {\n        setCurrentCompany({\n          text: companyInfo.currentCompany.name, \n          value: companyInfo.currentCompany.id\n        });\n      }\n    } catch (err) {\n      console.error('Failed to load company data:', err);\n    }\n  }, []);\n\n  /**\n   * Handles company selection change\n   */\n  const handleCompanyChange = useCallback(async (event: Event): Promise<void> => {\n    const target = event.target as HTMLSelectElement;\n    const companyId = target.value;\n    \n    // Update local state\n    const selectedCompany = companies.find(c => c.value === companyId);\n    if (selectedCompany) {\n      setCurrentCompany(selectedCompany);\n    }\n    \n    getCompanyHeaderManager().setCompanyHeaders(companyId);\n    if (companyId) {\n      sessionStorage.setItem(config.getConfig().companySessionStorageKey, companyId);\n    } else {\n      sessionStorage.removeItem(config.getConfig().companySessionStorageKey);\n    }\n    const groupId = await updateCustomerGroup();\n    getGroupHeaderManager().setGroupHeaders(groupId);\n    if (groupId) {\n      sessionStorage.setItem(config.getConfig().groupSessionStorageKey, groupId);\n    } else {\n      sessionStorage.removeItem(config.getConfig().groupSessionStorageKey);\n    }\n\n    onCompanyChange?.({ id: companyId, name: selectedCompany?.text || '' });\n\n    events.emit('companyContext/changed', companyId);\n  }, [companies, onCompanyChange]);\n\n  /**\n   * Clears company context\n   */\n  const clearCompanyContext = useCallback((): void => {\n    const customerCompanyContext = CustomerCompanyContext.getInstance();\n    customerCompanyContext.resetCache();\n    setCompanies([]);\n    setCurrentCompany({ text: '', value: '' });\n  }, []);\n\n  /**\n   * Handles authentication state changes\n   */\n  const handleAuthenticationChange = useCallback((authenticated: boolean) => {\n    if (authenticated) {\n      loadCompanyData();\n    } else {\n      clearCompanyContext();\n    }\n  }, [loadCompanyData, clearCompanyContext]);\n\n  /**\n   * Handles company context restoration\n   */\n  const handleCompanyContextRestored = useCallback((companyId: string | null) => {\n    if (!companyId) {\n      clearCompanyContext();\n      return;\n    }\n    // Store the company ID to be restored when companies are loaded\n    setCompanies(prevCompanies => {\n      const restoredCompany = prevCompanies.find(company => company.value === companyId);\n      if (restoredCompany) {\n        setCurrentCompany(restoredCompany);\n      }\n      return prevCompanies;\n    });\n  }, [clearCompanyContext, setCompanies, setCurrentCompany]);\n\n  /**\n   * Handles company updated event\n   */\n  const handleCompanyUpdated = useCallback((eventData: { company: { id: string; name: string; } }) => {\n    const { company } = eventData;\n\n    setCompanies(prevCompanies => {\n      const companyIndex = prevCompanies.findIndex(c => c.value === company.id);\n      if (companyIndex === -1) {\n        return prevCompanies;\n      }\n      return prevCompanies.map((c, i) =>\n        i === companyIndex ? { ...c, text: company.name } : c\n      );\n    });\n    \n    setCurrentCompany({\n      text: company.name,\n      value: company.id\n    });\n  }, []);\n\n  // Set up event listeners\n  useEffect(() => {\n    const unsubscribeAuth = events.on('authenticated', handleAuthenticationChange, { eager: true });\n    const unsubscribeRestore = events.on('companyContext/changed', handleCompanyContextRestored, { eager: true });\n    const unsubscribeCompanyUpdated = events.on('company/updated', handleCompanyUpdated);\n    \n    return () => {\n      unsubscribeAuth?.off?.();\n      unsubscribeRestore?.off?.();\n      unsubscribeCompanyUpdated?.off?.();\n    };\n  }, [handleAuthenticationChange, handleCompanyContextRestored, handleCompanyUpdated]);\n\n  return {\n    companies,\n    currentCompany,\n    handleCompanyChange\n  };\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n \nimport { HTMLAttributes } from 'preact/compat';\nimport { useMemo, useState, useEffect } from 'preact/hooks';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { Picker } from '@adobe-commerce/elsie/components';\nimport { events } from '@adobe-commerce/event-bus';\nimport { useCompanyData } from '@/company-switcher/hooks/useCompanyData';\nimport { Company } from '@/company-switcher/types/company';\n\nexport interface CompanySwitcherProps extends HTMLAttributes<HTMLDivElement> {\n  /** Custom aria-label for the picker */\n  ariaLabel?: string;\n  /** Callback function to be called when the company changes */\n  onCompanyChange?: (company: Company) => void;\n}\n\n/**\n * CompanySwitcher component allows users to switch between companies they have access to.\n * It only renders when a user has access to multiple companies.\n * This is a presentational component that uses the useCompanyData hook for all business logic.\n */\nexport const CompanySwitcher: Container<CompanySwitcherProps> = ({ \n  ariaLabel,\n  onCompanyChange,\n  ...props \n}) => {\n  const { companies, currentCompany, handleCompanyChange } = useCompanyData({ onCompanyChange });\n  const [isVisible, setIsVisible] = useState(true);\n\n  // Memoize the companies array to prevent unnecessary re-renders\n  const memoizedCompanies = useMemo(() => companies, [companies]);\n\n  // Listen for checkout/initialized and checkout/updated events to hide the picker\n  useEffect(() => {\n    const hidePickerHandler = () => {\n      setIsVisible(false);\n    };\n\n    const unsubscribeInitialized = events.on('checkout/initialized', hidePickerHandler);\n    const unsubscribeUpdated = events.on('checkout/updated', hidePickerHandler);\n\n    return () => {\n      unsubscribeInitialized?.off();\n      unsubscribeUpdated?.off();\n    };\n  }, []);\n\n  // Only render if user has access to multiple companies and picker is visible\n  if (companies.length < 2 || !isVisible) {\n    return null;\n  }\n\n  return (\n    <div {...props}>\n      <Picker \n        options={memoizedCompanies} \n        value={currentCompany.value} \n        onChange={handleCompanyChange}\n        aria-label={ariaLabel || 'Select company'}\n        aria-describedby=\"company-switcher-description\"\n      />\n    </div>\n  );\n};\n"],"names":["useCompanyData","onCompanyChange","companies","setCompanies","useState","currentCompany","setCurrentCompany","loadCompanyData","useCallback","companyInfo","CustomerCompanyContext","_a","_b","err","handleCompanyChange","event","companyId","selectedCompany","c","getCompanyHeaderManager","config","groupId","updateCustomerGroup","getGroupHeaderManager","events","clearCompanyContext","handleAuthenticationChange","authenticated","handleCompanyContextRestored","prevCompanies","restoredCompany","company","handleCompanyUpdated","eventData","companyIndex","i","useEffect","unsubscribeAuth","unsubscribeRestore","unsubscribeCompanyUpdated","_c","CompanySwitcher","ariaLabel","props","isVisible","setIsVisible","memoizedCompanies","useMemo","hidePickerHandler","unsubscribeInitialized","unsubscribeUpdated","jsx","Picker"],"mappings":"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"}