{"version":3,"file":"QuoteHistoryLog.js","sources":["/@dropins/storefront-quote-management/src/components/QuoteHistoryLog/QuoteHistoryLog.tsx"],"sourcesContent":["/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { FunctionComponent } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\nimport { classes } from '@adobe-commerce/elsie/lib';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { formattedDate } from '@/quote-management/utils/dateUtils';\nimport '@/quote-management/components/QuoteHistoryLog/QuoteHistoryLog.css';\n\nexport interface HistoryEntry {\n  uid: string;\n  createdAt: string;\n  author: {\n    firstname: string;\n    lastname: string;\n  };\n  changeType: string;\n  changes: {\n    commentAdded?: { comment: string };\n    statuses?: { changes: Array<{ oldStatus?: string; newStatus?: string }> };\n    expiration?: { oldExpiration?: string; newExpiration?: string };\n    total?: {\n      oldPrice?: { value: number; currency: string };\n      newPrice?: { value: number; currency: string };\n    };\n    customChanges?: { title: string; old_value: string; new_value: string };\n    productsRemoved?: {\n      productsRemovedFromCatalog?: string[];\n      productsRemovedFromQuote?: Array<{ name?: string; sku?: string; uid: string }>;\n    };\n  };\n}\n\nexport interface ItemNote {\n  createdAt: string;\n  creatorId: number;\n  creatorType: number;\n  negotiableQuoteItemUid: string;\n  note: string;\n  noteUid: string;\n}\n\nexport interface QuoteItem {\n  product: {\n    name: string;\n    sku: string;\n  };\n  noteFromBuyer?: ItemNote[];\n  noteFromSeller?: ItemNote[];\n}\n\nexport interface QuoteHistoryLogProps extends HTMLAttributes<HTMLDivElement> {\n  history?: HistoryEntry[];\n  items?: QuoteItem[];\n  buyer: {\n    firstname: string;\n    lastname: string;\n  };\n  salesRepName: string;\n}\n\nexport const QuoteHistoryLog: FunctionComponent<QuoteHistoryLogProps> = ({\n  className,\n  children,\n  history,\n  items,\n  buyer,\n  salesRepName,\n  ...props\n}) => {\n  const dictionary = useText({\n    quoteCreated: 'historyLog.changeTypes.created',\n    quoteUpdated: 'historyLog.changeTypes.updated',\n    statusChanged: 'historyLog.changeTypes.statusChanged',\n    commentAdded: 'historyLog.changeTypes.commentAdded',\n    expirationChanged: 'historyLog.changeTypes.expirationChanged',\n    buyerNoteAdded: 'historyLog.noteTypes.buyerNoteAdded',\n    sellerNoteAdded: 'historyLog.noteTypes.sellerNoteAdded',\n    buyerLabel: 'historyLog.authorLabels.buyer',\n    sellerLabel: 'historyLog.authorLabels.seller',\n    commentDetail: 'historyLog.changeDetails.comment',\n    statusChangedFromTo: 'historyLog.changeDetails.statusChangedFromTo',\n    statusSetTo: 'historyLog.changeDetails.statusSetTo',\n    expirationChangedFromTo: 'historyLog.changeDetails.expirationChangedFromTo',\n    expirationSetTo: 'historyLog.changeDetails.expirationSetTo',\n    totalChangedFromTo: 'historyLog.changeDetails.totalChangedFromTo',\n    customChange: 'historyLog.changeDetails.customChange',\n    productsRemovedFromCatalog: 'historyLog.changeDetails.productsRemovedFromCatalog',\n    productsRemovedFromQuote: 'historyLog.changeDetails.productsRemovedFromQuote',\n    noDetailsAvailable: 'historyLog.changeDetails.noDetailsAvailable',\n    emptyState: 'historyLog.emptyState',\n    never: 'dateUtils.never',\n  });\n\n\n  const formatChangeType = (changeType: string) => {\n    switch (changeType) {\n      case 'CREATED':\n        return dictionary.quoteCreated;\n      case 'UPDATED':\n        return dictionary.quoteUpdated;\n      case 'STATUS_CHANGED':\n        return dictionary.statusChanged;\n      case 'COMMENT_ADDED':\n        return dictionary.commentAdded;\n      case 'EXPIRATION_CHANGED':\n        return dictionary.expirationChanged;\n      default:\n        return changeType\n          .replace(/_/g, ' ')\n          .toLowerCase()\n          .replace(/\\b\\w/g, (l) => l.toUpperCase());\n    }\n  };\n\n  // Handle status or expiration changes\n  const formatChanges = (changes: any) => {\n    const changeDetails = [];\n\n    if (changes?.commentAdded?.comment) {\n      changeDetails.push(\n        dictionary.commentDetail.replace(\n          '{comment}',\n          changes.commentAdded.comment\n        )\n      );\n    }\n\n    if (changes?.statuses?.changes) {\n      changes.statuses.changes.forEach((statusChange: any) => {\n        if (statusChange.oldStatus && statusChange.newStatus) {\n          changeDetails.push(\n            dictionary.statusChangedFromTo\n              .replace('{oldStatus}', statusChange.oldStatus)\n              .replace('{newStatus}', statusChange.newStatus)\n          );\n        } else if (statusChange.newStatus) {\n          changeDetails.push(\n            dictionary.statusSetTo.replace(\n              '{newStatus}',\n              statusChange.newStatus\n            )\n          );\n        }\n      });\n    }\n\n    if (\n      changes?.expiration?.newExpiration &&\n      changes?.expiration?.oldExpiration\n    ) {\n      const newDateFormatted = formattedDate(changes.expiration.newExpiration);\n      const oldDateFormatted = formattedDate(changes.expiration.oldExpiration);\n      changeDetails.push(\n        dictionary.expirationChangedFromTo\n          .replace('{oldExpiration}', oldDateFormatted)\n          .replace('{newExpiration}', newDateFormatted)\n      );\n    } else if (changes?.expiration?.newExpiration) {\n      const newDateFormatted = formattedDate(changes.expiration.newExpiration);\n      changeDetails.push(\n        dictionary.expirationSetTo.replace('{newExpiration}', newDateFormatted)\n      );\n    }\n\n    if (changes?.total?.newPrice && changes?.total?.oldPrice) {\n      const newTotal = `${changes.total.newPrice.currency} ${changes.total.newPrice.value}`;\n      const oldTotal = `${changes.total.oldPrice.currency} ${changes.total.oldPrice.value}`;\n      changeDetails.push(\n        dictionary.totalChangedFromTo\n          .replace('{oldTotal}', oldTotal)\n          .replace('{newTotal}', newTotal)\n      );\n    }\n\n    if (changes?.customChanges?.title && changes?.customChanges?.old_value && changes?.customChanges?.new_value) {\n      changeDetails.push(\n        dictionary.customChange\n          .replace('{title}', changes.customChanges.title)\n          .replace('{oldValue}', changes.customChanges.old_value)\n          .replace('{newValue}', changes.customChanges.new_value)\n      );\n    }\n\n    if (changes?.productsRemoved?.productsRemovedFromCatalog && changes.productsRemoved.productsRemovedFromCatalog.length > 0) {\n      changeDetails.push(\n        dictionary.productsRemovedFromCatalog.replace(\n          '{products}',\n          changes.productsRemoved.productsRemovedFromCatalog.join(', ')\n        )\n      );\n    }\n\n    if (changes?.productsRemoved?.productsRemovedFromQuote && changes.productsRemoved.productsRemovedFromQuote.length > 0) {\n      const productNames = changes.productsRemoved.productsRemovedFromQuote.map((product: any) =>\n        product.name || product.sku || product.uid\n      ).join(', ');\n      changeDetails.push(\n        dictionary.productsRemovedFromQuote.replace('{products}', productNames)\n      );\n    }\n\n    return changeDetails.length > 0\n      ? changeDetails\n      : [dictionary.noDetailsAvailable];\n  };\n\n  // Get item notes outside of history entries\n  const getItemNotes = () => {\n    const notes: Array<{\n      createdAt: string;\n      creatorId: number;\n      creatorType: number;\n      negotiableQuoteItemUid: string;\n      note: string;\n      noteUid: string;\n      type: 'buyer' | 'seller';\n      productName: string;\n      productSku: string;\n      authorName: string;\n    }> = [];\n\n    const processNotes = (\n      noteArray: ItemNote[] | undefined,\n      type: 'buyer' | 'seller',\n      authorName: string,\n      item: QuoteItem\n    ) => {\n      if (noteArray && Array.isArray(noteArray)) {\n        noteArray.forEach((note) => {\n          if (note && note.note && note.note.trim()) {\n            notes.push({\n              ...note,\n              type,\n              productName: item.product.name,\n              productSku: item.product.sku,\n              authorName,\n            });\n          }\n        });\n      }\n    };\n\n    if (items) {\n      items.forEach((item) => {\n        processNotes(\n          item.noteFromBuyer,\n          'buyer',\n          `${buyer.firstname} ${buyer.lastname} ${dictionary.buyerLabel}`,\n          item\n        );\n\n        processNotes(\n          item.noteFromSeller,\n          'seller',\n          `${salesRepName} ${dictionary.sellerLabel}`,\n          item\n        );\n      });\n    }\n\n    return notes;\n  };\n\n  const itemNotes = getItemNotes();\n\n  // Get history entries\n  const historyEntries = (history || []).map((entry) => ({\n    ...entry,\n    entryType: 'history' as const,\n  }));\n  const noteEntries = itemNotes.map((note) => ({\n    ...note,\n    entryType: 'note' as const,\n  }));\n\n  // Combine history and item notes without sorting\n  const allEntries = [...historyEntries, ...noteEntries];\n\n  return (\n    <div\n      {...props}\n      className={classes(['quote-management-quote-history-log', className])}\n    >\n      {allEntries.length > 0 ? (\n        <div className=\"quote-management-quote-history-log__entries\">\n          {allEntries.map((entry, index) => (\n            <div\n              key={\n                entry.entryType === 'history'\n                  ? entry.uid\n                  : `${entry.noteUid}-${index}`\n              }\n              className=\"quote-management-quote-history-log__entry\"\n            >\n              <div className=\"quote-management-quote-history-log__entry-header\">\n                <div className=\"quote-management-quote-history-log__entry-meta\">\n                  <span className=\"quote-management-quote-history-log__entry-date\">\n                    {formattedDate(entry.createdAt, 'long')}\n                  </span>\n                  <span className=\"quote-management-quote-history-log__entry-author\">\n                    {entry.entryType === 'history'\n                      ? `by ${entry.author.firstname} ${entry.author.lastname\n                      } ${entry.author.firstname === buyer.firstname &&\n                        entry.author.lastname === buyer.lastname\n                        ? dictionary.buyerLabel\n                        : dictionary.sellerLabel\n                      }`\n                      : `by ${entry.authorName}`}\n                  </span>\n                </div>\n                <div className=\"quote-management-quote-history-log__entry-type\">\n                  {entry.entryType === 'history'\n                    ? formatChangeType(entry.changeType)\n                    : entry.type === 'buyer'\n                      ? dictionary.buyerNoteAdded\n                      : dictionary.sellerNoteAdded}\n                </div>\n              </div>\n              <div className=\"quote-management-quote-history-log__entry-changes\">\n                {entry.entryType === 'history' ? (\n                  formatChanges(entry.changes).map((change, changeIndex) => (\n                    <div\n                      key={changeIndex}\n                      className=\"quote-management-quote-history-log__entry-change\"\n                    >\n                      {change}\n                    </div>\n                  ))\n                ) : (\n                  <div className=\"quote-management-quote-history-log__entry-change\">\n                    <div>\n                      {entry.productName}({entry.productSku})\n                    </div>\n                    <div>\"{entry.note}\"</div>\n                  </div>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : (\n        <div className=\"quote-management-quote-history-log__empty\">\n          {dictionary.emptyState}\n        </div>\n      )}\n      {children}\n    </div>\n  );\n};\n"],"names":["QuoteHistoryLog","className","children","history","items","buyer","salesRepName","props","dictionary","useText","formatChangeType","changeType","l","formatChanges","changes","changeDetails","_a","_b","statusChange","_c","_d","newDateFormatted","formattedDate","oldDateFormatted","_e","_f","_g","newTotal","oldTotal","_h","_i","_j","_k","_l","productNames","product","itemNotes","notes","processNotes","noteArray","type","authorName","item","note","historyEntries","entry","noteEntries","allEntries","jsxs","classes","jsx","index","change","changeIndex"],"mappings":"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"}