{"version":3,"file":"uploadFile.js","sources":["/@dropins/storefront-quote-management/src/api/uploadFile/graphql/InitiateUploadMutation.ts","/@dropins/storefront-quote-management/src/api/uploadFile/graphql/FinishUploadMutation.ts","/@dropins/storefront-quote-management/src/api/uploadFile/uploadFile.ts"],"sourcesContent":["/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this \n * file in accordance with the terms of the Adobe license agreement \n * accompanying it. \n *******************************************************************/\n\nexport const INITIATE_UPLOAD_MUTATION = `\n  mutation INITIATE_UPLOAD_MUTATION($input: initiateUploadInput!) {\n    initiateUpload(input: $input) {\n      upload_url\n      key\n      expires_at\n    }\n  }\n`;","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this \n * file in accordance with the terms of the Adobe license agreement \n * accompanying it. \n *******************************************************************/\n\nexport const FINISH_UPLOAD_MUTATION = `\n  mutation FINISH_UPLOAD_MUTATION($input: finishUploadInput!) {\n    finishUpload(input: $input) {\n      success\n      key\n      message\n    }\n  }\n`;","/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this \n * file in accordance with the terms of the Adobe license agreement \n * accompanying it. \n *******************************************************************/\n\nimport { fetchGraphQl } from '@/quote-management/api';\nimport { events } from '@adobe-commerce/event-bus';\nimport { INITIATE_UPLOAD_MUTATION } from '@/quote-management/api/uploadFile/graphql/InitiateUploadMutation';\nimport { FINISH_UPLOAD_MUTATION } from '@/quote-management/api/uploadFile/graphql/FinishUploadMutation';\n\ntype GraphQLError = { message: string };\ntype InitiateUploadData = {\n  initiateUpload?: {\n    upload_url: string;\n    key: string;\n    expires_at: string;\n  };\n};\ntype FinishUploadData = {\n  finishUpload?: {\n    success: boolean;\n    key: string;\n    message?: string;\n  };\n};\ntype GraphQLResponse<T> = {\n  data?: T;\n  errors?: GraphQLError[];\n};\n\nexport const uploadFile = async (file: File): Promise<{ key: string }> => {\n  const mediaResourceType = 'NEGOTIABLE_QUOTE_ATTACHMENT';\n\n  try {\n    const filename = file?.name;\n    if (!file || !filename) throw new Error('Invalid file');\n\n    const formatGraphQLErrors = (errors: GraphQLError[]): string =>\n      errors.map((e) => e.message).join('; ');\n\n    const { data: initialData, errors: initialErrors } = (await fetchGraphQl(\n      INITIATE_UPLOAD_MUTATION,\n      { \n        variables: { input: { key: filename, media_resource_type: mediaResourceType } } \n      }\n    )) as GraphQLResponse<InitiateUploadData>;\n    if (initialErrors && initialErrors.length) throw new Error(formatGraphQLErrors(initialErrors));\n\n    const { upload_url, key } = initialData?.initiateUpload || {};\n    if (!upload_url || !key) throw new Error('Failed to initiate upload');\n\n    const put = await fetch(upload_url, { method: 'PUT', body: file });\n    if (!put.ok) throw new Error(`Upload failed: ${put.status} ${put.statusText}`);\n\n    const { data: finishData, errors: finishErrors } = (await fetchGraphQl(\n      FINISH_UPLOAD_MUTATION,\n      { \n        variables: { input: { key, media_resource_type: mediaResourceType } } \n      }\n    )) as GraphQLResponse<FinishUploadData>;\n    if (finishErrors && finishErrors.length) throw new Error(formatGraphQLErrors(finishErrors));\n\n    const { success, key: finalizedKey, message } = finishData?.finishUpload || {};\n    if (!success || !finalizedKey) throw new Error(message || 'Failed to finish upload');\n\n    return { key: finalizedKey };\n    \n  } catch (err: any) {\n    events.emit('quote-management/file-upload-error', {\n      error: err?.message || 'File upload failed',\n      fileName: file?.name,\n    });\n    throw err instanceof Error ? err : new Error('File upload failed');\n  }\n};\n"],"names":["INITIATE_UPLOAD_MUTATION","FINISH_UPLOAD_MUTATION","uploadFile","file","mediaResourceType","filename","formatGraphQLErrors","errors","e","initialData","initialErrors","fetchGraphQl","upload_url","key","put","finishData","finishErrors","success","finalizedKey","message","err","events"],"mappings":"iHASO,MAAMA,EAA2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,ECA3BC,EAAyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,ECyBzBC,EAAa,MAAOC,GAAyC,CACxE,MAAMC,EAAoB,8BAE1B,GAAI,CACF,MAAMC,EAAWF,GAAA,YAAAA,EAAM,KACvB,GAAI,CAACA,GAAQ,CAACE,EAAU,MAAM,IAAI,MAAM,cAAc,EAEtD,MAAMC,EAAuBC,GAC3BA,EAAO,IAAKC,GAAMA,EAAE,OAAO,EAAE,KAAK,IAAI,EAElC,CAAE,KAAMC,EAAa,OAAQC,CAAA,EAAmB,MAAMC,EAC1DX,EACA,CACE,UAAW,CAAE,MAAO,CAAE,IAAKK,EAAU,oBAAqBD,EAAkB,CAAE,CAChF,EAEF,GAAIM,GAAiBA,EAAc,OAAQ,MAAM,IAAI,MAAMJ,EAAoBI,CAAa,CAAC,EAE7F,KAAM,CAAE,WAAAE,EAAY,IAAAC,CAAA,GAAQJ,GAAA,YAAAA,EAAa,iBAAkB,CAAA,EAC3D,GAAI,CAACG,GAAc,CAACC,EAAK,MAAM,IAAI,MAAM,2BAA2B,EAEpE,MAAMC,EAAM,MAAM,MAAMF,EAAY,CAAE,OAAQ,MAAO,KAAMT,EAAM,EACjE,GAAI,CAACW,EAAI,GAAI,MAAM,IAAI,MAAM,kBAAkBA,EAAI,MAAM,IAAIA,EAAI,UAAU,EAAE,EAE7E,KAAM,CAAE,KAAMC,EAAY,OAAQC,CAAA,EAAkB,MAAML,EACxDV,EACA,CACE,UAAW,CAAE,MAAO,CAAE,IAAAY,EAAK,oBAAqBT,EAAkB,CAAE,CACtE,EAEF,GAAIY,GAAgBA,EAAa,OAAQ,MAAM,IAAI,MAAMV,EAAoBU,CAAY,CAAC,EAE1F,KAAM,CAAE,QAAAC,EAAS,IAAKC,EAAc,QAAAC,IAAYJ,GAAA,YAAAA,EAAY,eAAgB,CAAA,EAC5E,GAAI,CAACE,GAAW,CAACC,QAAoB,IAAI,MAAMC,GAAW,yBAAyB,EAEnF,MAAO,CAAE,IAAKD,CAAA,CAEhB,OAASE,EAAU,CACjB,MAAAC,EAAO,KAAK,qCAAsC,CAChD,OAAOD,GAAA,YAAAA,EAAK,UAAW,qBACvB,SAAUjB,GAAA,YAAAA,EAAM,IAAA,CACjB,EACKiB,aAAe,MAAQA,EAAM,IAAI,MAAM,oBAAoB,CACnE,CACF"}