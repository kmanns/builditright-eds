{"version":3,"file":"ItemsQuoted.js","sources":["/@dropins/storefront-quote-management/src/containers/ItemsQuoted/ItemsQuoted.tsx"],"sourcesContent":["/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport {\n  HTMLAttributes,\n  useCallback,\n  useEffect,\n  useState,\n} from 'preact/compat';\nimport { Container, Slot, SlotProps } from '@adobe-commerce/elsie/lib';\nimport { events } from '@adobe-commerce/event-bus';\nimport { Price, InLineAlert } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport {\n  NegotiableQuoteModel,\n  CartItemModel,\n} from '@/quote-management/data/models/negotiable-quote-model';\nimport {\n  ProductListTable,\n  QuotePricesSummary,\n  ItemsQuoted as ItemsQuotedComponent,\n} from '@/quote-management/components';\nimport { CheckWithCircle, WarningFilled } from '@adobe-commerce/elsie/icons';\nimport { ConfirmationModal } from '@/quote-management/components/ConfirmationModal';\nimport { LineItemNoteModal } from '@/quote-management/components/LineItemNoteModal';\nimport { updateQuantities, setLineItemNote } from '@/quote-management/api';\nimport { removeNegotiableQuoteItems } from '@/quote-management/api/removeNegotiableQuoteItems';\n\nconst NOTIFICATION_AUTO_DISMISS_DELAY = 3000;\n\nexport interface ItemsQuotedProps extends HTMLAttributes<HTMLDivElement> {\n  quoteData?: NegotiableQuoteModel;\n  onItemCheckboxChange?: (\n    item: CartItemModel,\n    isSelected: boolean\n  ) => void;\n  onItemDropdownChange?: (\n    item: CartItemModel,\n    action: string\n  ) => void;\n  onUpdate?: (e: SubmitEvent) => void;\n  onRemoveItemsRef?: (\n    handler: (items: CartItemModel[]) => void\n  ) => void;\n  onRemoveModalStateChange?: (isOpen: boolean) => void;\n  slots?: {\n    ProductListTable?: SlotProps<{\n      items: NegotiableQuoteModel['items'];\n      canEdit: boolean;\n      readOnly?: boolean;\n      onItemCheckboxChange?: (\n        item: CartItemModel,\n        isSelected: boolean\n      ) => void;\n      onItemDropdownChange?: (\n        item: CartItemModel,\n        action: string\n      ) => void;\n      onQuantityChange?: (\n        item: CartItemModel,\n        newQuantity: number\n      ) => void;\n      onUpdate?: (e: SubmitEvent) => void;\n      dropdownSelections?: Record<string, string | undefined>;\n    }>;\n    QuotePricesSummary?: SlotProps<{\n      items: NegotiableQuoteModel['items'];\n      prices: NegotiableQuoteModel['prices'];\n    }>;\n  };\n}\n\nexport const ItemsQuoted: Container<ItemsQuotedProps> = ({\n  quoteData: initialData,\n  onItemCheckboxChange,\n  onItemDropdownChange,\n  onRemoveItemsRef,\n  onRemoveModalStateChange,\n  slots,\n  ...props\n}) => {\n  const [quoteData, setQuoteData] = useState<NegotiableQuoteModel | undefined>(\n    initialData\n  );\n  const [quantityChanges, setQuantityChanges] = useState<{\n    [itemUid: string]: number;\n  }>({});\n  const [selectedItem, setSelectedItem] =\n    useState<CartItemModel | null>(null);\n  const [isUpdateQuantitiesModalOpen, setIsUpdateQuantitiesModalOpen] =\n    useState(false);\n  const [isLineItemNoteModalOpen, setIsLineItemNoteModalOpen] = useState(false);\n  const [modalErrorMessage, setModalErrorMessage] = useState('');\n  const [notificationState, setNotificationState] = useState<{\n    type: 'success' | 'error' | null;\n    message: string;\n  }>({ type: null, message: '' });\n  // State for remove items functionality\n  const [isRemoveModalOpen, setIsRemoveModalOpen] = useState(false);\n  const [itemsToRemove, setItemsToRemove] = useState<CartItemModel[]>(\n    []\n  );\n  const [isRemoving, setIsRemoving] = useState(false);\n  const [removeNotificationState, setRemoveNotificationState] = useState<{\n    type: 'success' | 'error' | null;\n    message: string;\n  }>({ type: null, message: '' });\n  const [dropdownSelections, setDropdownSelections] = useState<\n    Record<string, string>\n  >({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const dictionary = useText({\n    subtotal: 'NegotiableQuote.Manage.quotePricesSummary.subtotal.excludingTax',\n    grandTotal:\n      'NegotiableQuote.Manage.quotePricesSummary.grandTotal.includingTax',\n    appliedTaxes: 'NegotiableQuote.Manage.quotePricesSummary.appliedTaxes',\n    modalTitle: 'NegotiableQuote.Manage.updateQuantitiesModal.title',\n    modalDescription:\n      'NegotiableQuote.Manage.updateQuantitiesModal.description',\n    modalCancelButton:\n      'NegotiableQuote.Manage.updateQuantitiesModal.cancelButton',\n    modalUpdateButton:\n      'NegotiableQuote.Manage.updateQuantitiesModal.updateButton',\n    successHeading:\n      'NegotiableQuote.Manage.updateQuantitiesModal.successHeading',\n    successMessage:\n      'NegotiableQuote.Manage.updateQuantitiesModal.successMessage',\n    errorHeading: 'NegotiableQuote.Manage.updateQuantitiesModal.errorHeading',\n    errorMessage: 'NegotiableQuote.Manage.updateQuantitiesModal.errorMessage',\n    removeModalTitle: 'NegotiableQuote.Manage.removeItemsModal.title',\n    removeModalDescription:\n      'NegotiableQuote.Manage.removeItemsModal.description',\n    removeModalCancelButton:\n      'NegotiableQuote.Manage.removeItemsModal.cancelButton',\n    removeModalConfirmButton:\n      'NegotiableQuote.Manage.removeItemsModal.confirmButton',\n    removeModalConfirmButtonRemoving:\n      'NegotiableQuote.Manage.removeItemsModal.confirmButtonRemoving',\n    removeSuccessHeading:\n      'NegotiableQuote.Manage.removeItemsModal.successHeading',\n    removeSuccessMessage:\n      'NegotiableQuote.Manage.removeItemsModal.successMessage',\n    removeErrorHeading: 'NegotiableQuote.Manage.removeItemsModal.errorHeading',\n    removeErrorMessage: 'NegotiableQuote.Manage.removeItemsModal.errorMessage',\n  });\n\n  useEffect(() => {\n    const quoteDataEvent = events.on(\n      'quote-management/quote-data',\n\n      (data: { quote: NegotiableQuoteModel }) => {\n        setQuoteData(data.quote);\n        setQuantityChanges({});\n        setNotificationState({ type: null, message: '' });\n        setDropdownSelections({});\n      },\n\n      {\n        eager: true,\n      }\n    );\n    return () => quoteDataEvent?.off();\n  }, []);\n\n  useEffect(() => {\n    const quantitiesUpdatedEvent = events.on(\n      'quote-management/quantities-updated',\n      (data: { quote: NegotiableQuoteModel }) => {\n        setQuoteData(data.quote);\n        setQuantityChanges({});\n        setNotificationState({\n          type: 'success',\n          message: dictionary.successMessage,\n        });\n        // Auto-close success notification after 3 seconds\n        setTimeout(() => {\n          setIsUpdateQuantitiesModalOpen(false);\n          setNotificationState({ type: null, message: '' });\n        }, 3000);\n      }\n    );\n    return () => quantitiesUpdatedEvent?.off();\n  }, [dictionary.successMessage]);\n\n  // Listen for quote items removed event\n  useEffect(() => {\n    const itemsRemovedEvent = events.on(\n      'quote-management/quote-items-removed',\n      (data: { quote: NegotiableQuoteModel }) => {\n        setQuoteData(data.quote);\n        setItemsToRemove([]);\n        setIsRemoving(false);\n        setRemoveNotificationState({\n          type: 'success',\n          message: dictionary.removeSuccessMessage,\n        });\n        // Auto-close success notification after 3 seconds\n        setTimeout(() => {\n          setIsRemoveModalOpen(false);\n          setRemoveNotificationState({ type: null, message: '' });\n          onRemoveModalStateChange?.(false);\n        }, NOTIFICATION_AUTO_DISMISS_DELAY);\n      }\n    );\n    return () => itemsRemovedEvent?.off();\n  }, [dictionary.removeSuccessMessage, onRemoveModalStateChange]);\n\n  // Unified handler for removing items (single or multiple)\n  const handleRemoveItems = useCallback((items: CartItemModel[]) => {\n    if (!items || items.length === 0) {\n      return;\n    }\n    setItemsToRemove(items);\n    setRemoveNotificationState({ type: null, message: '' });\n    setIsRemoveModalOpen(true);\n  }, []);\n\n  // Expose handler to parent component\n  useEffect(() => {\n    onRemoveItemsRef?.(handleRemoveItems);\n  }, [handleRemoveItems, onRemoveItemsRef]);\n\n  const handleDismissRemoveBanner = () => {\n    setRemoveNotificationState({ type: null, message: '' });\n  };\n\n  const handleItemDropdownChange = (\n    item: CartItemModel,\n    action: string\n  ) => {\n    const cartItem = item;\n    // Handle edit action - open line item note modal\n    if (action === 'edit') {\n      setSelectedItem(cartItem);\n      setIsLineItemNoteModalOpen(true);\n      // Reset dropdown immediately\n      setDropdownSelections((prev) => ({ ...prev, [cartItem.uid]: '' }));\n      return;\n    }\n\n    // Handle remove action\n    if (action === 'remove') {\n      setDropdownSelections((prev) => ({\n        ...prev,\n        [cartItem.uid]: action,\n      }));\n      handleRemoveItems([cartItem]); // Use unified handler\n      onItemDropdownChange?.(cartItem, action);\n      // Reset dropdown immediately (consistent with edit action)\n      setDropdownSelections((prev) => ({ ...prev, [cartItem.uid]: '' }));\n      return;\n    }\n\n    // For any other actions, pass through to parent (but ignore empty/placeholder selections)\n    if (action) {\n      onItemDropdownChange?.(cartItem, action);\n    }\n\n    // Clear dropdown selection for non-edit/remove actions\n    /* istanbul ignore next: defensive cleanup - custom actions shouldn't have dropdown state due to proper cleanup in edit/remove handlers */\n    setDropdownSelections((prev) => {\n      if (!(cartItem.uid in prev)) {\n        return prev;\n      }\n      const next = { ...prev };\n      delete next[cartItem.uid];\n      return next;\n    });\n  };\n\n  const handleConfirmRemove = async () => {\n    /* istanbul ignore next */\n    if (!quoteData || itemsToRemove.length === 0) {\n      return;\n    }\n\n    const uidsToRemove = itemsToRemove.map((item) => item.uid);\n\n    setIsRemoving(true);\n    setRemoveNotificationState({ type: null, message: '' });\n\n    try {\n      await removeNegotiableQuoteItems({\n        quoteUid: quoteData.uid,\n        quoteItemUids: uidsToRemove,\n      });\n      // Success is handled by the event listener\n    } catch (err) {\n      const errorMessage =\n        /* istanbul ignore next */\n        err instanceof Error ? err.message : dictionary.removeErrorMessage;\n      setRemoveNotificationState({\n        type: 'error',\n        message: errorMessage,\n      });\n      // Clear dropdown selections for failed items (single item only)\n      /* istanbul ignore next */ // UI-driven state; covered by tests but line sometimes mis-attributed in source maps\n      if (itemsToRemove.length === 1) {\n        const failedItem = itemsToRemove[0];\n        setDropdownSelections((prev) => {\n          if (!(failedItem.uid in prev)) {\n            return prev;\n          }\n          const next = { ...prev };\n          delete next[failedItem.uid];\n          return next;\n        });\n      }\n      setIsRemoving(false);\n    }\n  };\n\n  const handleCancelRemove = () => {\n    setIsRemoveModalOpen(false);\n    setRemoveNotificationState({ type: null, message: '' });\n    onRemoveModalStateChange?.(false);\n    // Clear dropdown selections for single item cancellation\n    /* istanbul ignore next */ // UI-driven state; covered by tests but line sometimes mis-attributed in source maps\n    if (itemsToRemove.length === 1) {\n      const cancelledItem = itemsToRemove[0];\n      setDropdownSelections((prev) => {\n        if (!(cancelledItem.uid in prev)) {\n          return prev;\n        }\n        const next = { ...prev };\n        delete next[cancelledItem.uid];\n        return next;\n      });\n    }\n    setItemsToRemove([]);\n  };\n\n  // Handle modal close\n  const handleModalClose = useCallback(() => {\n    // Clean up dropdown selection for the selected item before clearing it\n    /* istanbul ignore else: defensive check - selectedItem should always be truthy when modal is open */\n    if (selectedItem) {\n      setDropdownSelections((prev) => {\n        const next = { ...prev };\n        delete next[selectedItem.uid];\n        return next;\n      });\n    }\n    setIsLineItemNoteModalOpen(false);\n    setSelectedItem(null);\n    setIsSubmitting(false);\n    setModalErrorMessage('');\n  }, [selectedItem]);\n\n  // Handle modal confirm - submit note and quantity\n  const handleModalConfirm = useCallback(\n    async (note: string, quantity: number) => {\n      /* istanbul ignore next: defensive guard for async race conditions - unreachable in normal flow as modal only renders with selectedItem and quoteData */\n      if (!selectedItem || !quoteData) return;\n\n      setIsSubmitting(true);\n      try {\n        // Check if quantity has changed from the original\n        const quantityChanged = quantity !== selectedItem.quantity;\n\n        // If quantity changed, update it first\n        if (quantityChanged) {\n          await updateQuantities({\n            quoteUid: quoteData.uid,\n            items: [{ quoteItemUid: selectedItem.uid, quantity }],\n          });\n        }\n\n        // Then set the line item note\n        await setLineItemNote({\n          quoteUid: quoteData.uid,\n          itemUid: selectedItem.uid,\n          note,\n          quantity,\n        });\n\n        // Close modal on success\n        handleModalClose();\n      } catch (error) {\n        console.error('Failed to set line item note:', error);\n        // Extract error message from API\n        const errorMessage =\n          /* istanbul ignore next */\n          error instanceof Error\n            ? error.message\n            : 'Unable to update the item. Please try again.';\n        setModalErrorMessage(errorMessage);\n        setIsSubmitting(false);\n      }\n    },\n    [selectedItem, quoteData, handleModalClose]\n  );\n\n  if (!quoteData) {\n    return <ItemsQuotedComponent loading={true} />;\n  }\n\n  const canEdit = Boolean(quoteData.canUpdateQuote);\n\n  const handleQuantityChange = (\n    item: CartItemModel,\n    newQuantity: number\n  ) => {\n    setQuantityChanges((prev) => ({\n      ...prev,\n      [item.uid]: newQuantity,\n    }));\n  };\n\n  const handleUpdate = (e: SubmitEvent) => {\n    e.preventDefault();\n    setNotificationState({ type: null, message: '' });\n    setIsUpdateQuantitiesModalOpen(true);\n  };\n\n  const handleConfirmUpdate = async () => {\n    /* istanbul ignore next */\n    if (!quoteData) {\n      return;\n    }\n\n    if (Object.keys(quantityChanges).length === 0) {\n      setIsUpdateQuantitiesModalOpen(false);\n      return;\n    }\n\n    // Clear any previous notifications\n    setNotificationState({ type: null, message: '' });\n\n    const items = Object.entries(quantityChanges).map(\n      ([quoteItemUid, quantity]) => ({\n        quoteItemUid,\n        quantity,\n      })\n    );\n\n    try {\n      await updateQuantities({\n        quoteUid: quoteData.uid,\n        items,\n      });\n      // Success is handled by the event listener\n    } catch (err) {\n      const errorMessage =\n        /* istanbul ignore next */\n        err instanceof Error ? err.message : dictionary.errorMessage;\n      setNotificationState({\n        type: 'error',\n        message: errorMessage,\n      });\n      console.error('Failed to update quantities:', err);\n    }\n  };\n\n  const handleCancelUpdate = () => {\n    setIsUpdateQuantitiesModalOpen(false);\n    setNotificationState({ type: null, message: '' });\n  };\n\n  const handleDismissBanner = () => {\n    setNotificationState({ type: null, message: '' });\n  };\n\n  const quotePricesSummaryEntries = [];\n\n  quoteData.prices.subtotalExcludingTax &&\n    quotePricesSummaryEntries.push({\n      label: dictionary.subtotal,\n      id: 'subtotal',\n      value: (\n        <Price\n          amount={quoteData.prices.subtotalExcludingTax.value}\n          currency={quoteData.prices.subtotalExcludingTax.currency}\n          weight=\"normal\"\n        />\n      ),\n    });\n\n  quoteData.prices.grandTotal &&\n    quotePricesSummaryEntries.push({\n      label: dictionary.grandTotal,\n      id: 'total',\n      value: (\n        <Price\n          amount={quoteData.prices.grandTotal.value}\n          currency={quoteData.prices.grandTotal.currency}\n        />\n      ),\n      strong: true,\n    });\n\n  // Create confirmation banner based on notification state\n  const confirmationBanner =\n    notificationState.type === 'success' ? (\n      <InLineAlert\n        type=\"success\"\n        variant=\"primary\"\n        icon={<CheckWithCircle />}\n        heading={dictionary.successHeading}\n        description={notificationState.message}\n        onDismiss={handleDismissBanner}\n        data-testid=\"update-quantities-success-banner\"\n      />\n    ) : notificationState.type === 'error' ? (\n      <InLineAlert\n        type=\"error\"\n        variant=\"primary\"\n        icon={<WarningFilled />}\n        heading={dictionary.errorHeading}\n        description={notificationState.message}\n        onDismiss={handleDismissBanner}\n        data-testid=\"update-quantities-error-banner\"\n      />\n    ) : null;\n\n  // Create wrapper for checkbox change handler\n  const handleItemCheckboxChange = onItemCheckboxChange\n    ? (item: CartItemModel, isSelected: boolean) => {\n        onItemCheckboxChange(item, isSelected);\n      }\n    : undefined;\n\n  // Create remove confirmation banner based on notification state\n  const removeConfirmationBanner =\n    removeNotificationState.type === 'success' ? (\n      <InLineAlert\n        type=\"success\"\n        variant=\"primary\"\n        icon={<CheckWithCircle />}\n        heading={dictionary.removeSuccessHeading}\n        description={removeNotificationState.message}\n        onDismiss={handleDismissRemoveBanner}\n        data-testid=\"remove-items-success-banner\"\n      />\n    ) : removeNotificationState.type === 'error' ? (\n      <InLineAlert\n        type=\"error\"\n        variant=\"primary\"\n        icon={<WarningFilled />}\n        heading={dictionary.removeErrorHeading}\n        description={removeNotificationState.message}\n        onDismiss={handleDismissRemoveBanner}\n        data-testid=\"remove-items-error-banner\"\n      />\n    ) : null;\n\n  // Create modal error banner\n  const modalErrorBanner = modalErrorMessage ? (\n    <InLineAlert\n      type=\"error\"\n      variant=\"primary\"\n      icon={<WarningFilled />}\n      heading={dictionary.errorHeading}\n      description={modalErrorMessage}\n      onDismiss={() => setModalErrorMessage('')}\n      data-testid=\"line-item-note-error-banner\"\n    />\n  ) : null;\n\n  return (\n    <>\n      <ItemsQuotedComponent\n        data-testid=\"items-quoted-container\"\n        {...props}\n        loading={false}\n        table={\n          <Slot\n            name=\"ProductListTable\"\n            slot={slots?.ProductListTable}\n            context={{\n              items: quoteData.items,\n              canEdit,\n              readOnly: quoteData.readOnly,\n              onItemCheckboxChange,\n              onItemDropdownChange: handleItemDropdownChange,\n              onQuantityChange: handleQuantityChange,\n              onUpdate: handleUpdate,\n              dropdownSelections,\n            }}\n          >\n            <ProductListTable\n              items={quoteData.items}\n              canEdit={canEdit}\n              onItemCheckboxChange={handleItemCheckboxChange}\n              readOnly={quoteData.readOnly}\n              onItemDropdownChange={handleItemDropdownChange}\n              onQuantityChange={handleQuantityChange}\n              onUpdate={handleUpdate}\n              dropdownSelections={dropdownSelections}\n            />\n          </Slot>\n        }\n        pricesSummary={\n          <Slot\n            name=\"QuotePricesSummary\"\n            slot={slots?.QuotePricesSummary}\n            context={{\n              items: quoteData.items,\n              prices: quoteData.prices,\n            }}\n          >\n            <QuotePricesSummary entries={quotePricesSummaryEntries} />\n          </Slot>\n        }\n      />\n\n      {/* Update Quantities Modal */}\n      <ConfirmationModal\n        open={isUpdateQuantitiesModalOpen}\n        title={dictionary.modalTitle}\n        message={dictionary.modalDescription}\n        cancelLabel={dictionary.modalCancelButton}\n        confirmLabel={dictionary.modalUpdateButton}\n        onCancel={handleCancelUpdate}\n        onConfirm={handleConfirmUpdate}\n        confirmationBanner={confirmationBanner}\n        data-testid=\"update-quantities-modal\"\n      />\n\n      {/* Remove Items Modal */}\n      <ConfirmationModal\n        open={isRemoveModalOpen}\n        title={dictionary.removeModalTitle}\n        message={dictionary.removeModalDescription}\n        cancelLabel={dictionary.removeModalCancelButton}\n        confirmLabel={\n          isRemoving\n            ? dictionary.removeModalConfirmButtonRemoving\n            : dictionary.removeModalConfirmButton\n        }\n        onCancel={handleCancelRemove}\n        onConfirm={handleConfirmRemove}\n        confirmationBanner={removeConfirmationBanner}\n        data-testid=\"remove-items-modal\"\n      />\n      {/* Line Item Note Modal */}\n      {selectedItem && (\n        <LineItemNoteModal\n          open={isLineItemNoteModalOpen}\n          item={selectedItem}\n          onClose={handleModalClose}\n          onConfirm={handleModalConfirm}\n          isSubmitting={isSubmitting}\n          errorBanner={modalErrorBanner || undefined}\n        />\n      )}\n    </>\n  );\n};\n"],"names":["NOTIFICATION_AUTO_DISMISS_DELAY","ItemsQuoted","initialData","onItemCheckboxChange","onItemDropdownChange","onRemoveItemsRef","onRemoveModalStateChange","slots","props","quoteData","setQuoteData","useState","quantityChanges","setQuantityChanges","selectedItem","setSelectedItem","isUpdateQuantitiesModalOpen","setIsUpdateQuantitiesModalOpen","isLineItemNoteModalOpen","setIsLineItemNoteModalOpen","modalErrorMessage","setModalErrorMessage","notificationState","setNotificationState","isRemoveModalOpen","setIsRemoveModalOpen","itemsToRemove","setItemsToRemove","isRemoving","setIsRemoving","removeNotificationState","setRemoveNotificationState","dropdownSelections","setDropdownSelections","isSubmitting","setIsSubmitting","dictionary","useText","useEffect","quoteDataEvent","events","data","quantitiesUpdatedEvent","itemsRemovedEvent","handleRemoveItems","useCallback","items","handleDismissRemoveBanner","handleItemDropdownChange","item","action","cartItem","prev","next","handleConfirmRemove","uidsToRemove","removeNegotiableQuoteItems","err","errorMessage","failedItem","handleCancelRemove","cancelledItem","handleModalClose","handleModalConfirm","note","quantity","updateQuantities","setLineItemNote","error","jsx","ItemsQuotedComponent","canEdit","handleQuantityChange","newQuantity","handleUpdate","e","handleConfirmUpdate","quoteItemUid","handleCancelUpdate","handleDismissBanner","quotePricesSummaryEntries","Price","confirmationBanner","InLineAlert","CheckWithCircle","WarningFilled","handleItemCheckboxChange","isSelected","removeConfirmationBanner","modalErrorBanner","jsxs","Fragment","Slot","ProductListTable","QuotePricesSummary","ConfirmationModal","LineItemNoteModal"],"mappings":"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"}